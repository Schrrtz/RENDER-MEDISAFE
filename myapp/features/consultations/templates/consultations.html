  {% extends 'base.html' %}
  {% load static %}

{% block title %}Medical Consultations - MediSafe{% endblock %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'healthcare-red': '#FF6B35',
                    'healthcare-blue': '#003366',
                    'healthcare-light-blue': '#0066CC'
                }
            }
        }
    }
</script>
  <style>
    /* Standard Theme Colors and Styles */
    :root {
      --ink: #2c2c2f;
      --blue: #2c71b7;
      --blue2: #2c71b7;
      --red: #FF6B35;
      --bg: #f0f3f6;
      --gray: #64748b;
      --border: #d4cac9;
      --success: #10B981;
      --pending: #F59E0B;
      --approved: #10B981;
      --rejected: #f15e2c;
      --scheduled: #2c71b7;
      --completed: #10B981;
      --cancelled: #64748B;
    }

    body {
      margin: 0;
      background: #f8fafc;
      color: var(--ink);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    /* Standard Header */
    .std-nav {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0,51,102,.1);
    }

    .std-wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* Main Content Styles */
    .page-header {
      background: linear-gradient(135deg, var(--blue) 0%, var(--blue2) 100%);
      color: white;
      padding: 48px 0;
      margin-bottom: 48px;
    }

    .page-title {
      font-size: 32px;
      font-weight: 800;
      margin: 0;
      margin-bottom: 16px;
    }

    .page-description {
      font-size: 18px;
      opacity: 0.9;
      max-width: 600px;
      line-height: 1.6;
    }

    .quick-booking-banner {
      background: linear-gradient(135deg, #003d80 0%, #2c71b7 100%);
      color: white;
      border-radius: 18px;
      padding: 28px;
      margin: 24px auto;
      box-shadow: 0 18px 60px rgba(12, 36, 74, 0.25);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .quick-booking-banner .content {
      flex: 1;
      min-width: 220px;
    }

    .quick-booking-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      min-width: 280px;
    }

    .quick-booking-select {
      flex: 1;
      min-width: 200px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.95);
      color: #0f172a;
      font-weight: 600;
      font-size: 14px;
    }

    .quick-booking-btn {
      padding: 12px 22px;
      background: #fff;
      color: #2c71b7;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .quick-booking-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 35px rgba(0,0,0,0.2);
    }

    @media (max-width: 640px) {
      .quick-booking-controls {
        width: 100%;
        flex-direction: column;
      }
      .quick-booking-select,
      .quick-booking-btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Section Styles */
    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--blue);
      margin: 40px 0 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    /* Consultation Cards Grid */
    .consultations-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      padding: 24px 0;
    }

    /* My Consultations Specific Styles */
    .my-consultations .consultation-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .consultation-header {
      margin-bottom: 20px;
    }

    .consultation-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--gray);
      font-size: 14px;
    }

    .detail-item i {
      width: 16px;
      color: var(--blue);
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending { background: #FEF3C7; color: var(--pending); }
    .status-approved { background: #D1FAE5; color: var(--approved); }
    .status-rejected { background: #FEE2E2; color: var(--rejected); }
    .status-scheduled { background: #DBEAFE; color: var(--scheduled); }
    .status-completed { background: #D1FAE5; color: var(--completed); }
    .status-cancelled { background: #F1F5F9; color: var(--cancelled); }

    /* Cancel Button Styles */
    .cancel-btn {
      width: 100%;
      padding: 8px 16px;
      background-color: var(--red);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.2s;
    }

    .cancel-btn:hover {
      background-color: #b91c1c;
    }

    .full-width {
      width: 100% !important;
      margin-top: 12px;
    }

    .meeting-link {
      color: var(--blue);
      text-decoration: none;
      font-weight: 600;
    }

    .meeting-link:hover {
      text-decoration: underline;
    }

    .consultation-notes {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      font-size: 14px;
      color: var(--gray);
    }

    .no-consultations {
      grid-column: 1 / -1;
      text-align: center;
      padding: 48px;
      background: white;
      border-radius: 16px;
      color: var(--gray);
    }

    .consultation-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .consultation-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    }

    .card-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-bottom: 1px solid var(--border);
    }

    .card-content {
      padding: 24px;
    }

    .specialty {
      color: var(--blue);
      font-weight: 700;
      font-size: 20px;
      margin: 0 0 12px;
    }

    .doctor-name {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 8px;
    }

    .doctor-info {
      color: var(--gray);
      font-size: 14px;
      margin: 0 0 16px;
      line-height: 1.6;
    }

    .availability {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--success);
      margin-bottom: 16px;
    }

    .book-btn {
      background: var(--blue);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.2s;
    }

    .book-btn:hover {
      background: var(--blue2);
    }

    .stats {
      display: flex;
      justify-content: space-between;
      padding: 16px 0;
      border-top: 1px solid var(--border);
      margin-top: 16px;
      font-size: 14px;
      color: var(--gray);
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .consultations-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .consultations-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Consultation Booking Form Styles */
    .consultation-form {
      max-width: 600px;
      width: 100%;
    }

    .form-doctor-info {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 24px;
      background: #f8fafc;
      border-radius: 16px;
      margin-bottom: 32px;
    }

    .doctor-photo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 3px solid white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .form-section {
      padding: 24px;
      background: white;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      color: var(--blue);
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 24px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 8px;
    }

    .form-group input[type="date"],
    .form-group input[type="time"] {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      color: var(--ink);
      transition: all 0.2s;
    }

    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      color: var(--ink);
      resize: vertical;
      min-height: 120px;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(11, 61, 145, 0.1);
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 32px;
    }

    .submit-btn {
      background: var(--blue);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .submit-btn:hover {
      background: var(--blue2);
      transform: translateY(-2px);
    }

    /* Animation Classes */
    .booking-overlay {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
    }

    .booking-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .booking-panel {
      transform: translateY(20px) scale(0.95);
      opacity: 0;
      transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }

    .booking-overlay.active .booking-panel {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    @media (max-width: 640px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .form-doctor-info {
        flex-direction: column;
        text-align: center;
      }
    }

    /* Tabs Container Styles */
    .tabs-container {
      margin-bottom: 40px;
    }

    .tabs-header {
      display: flex;
      gap: 0;
      border-bottom: 3px solid var(--border);
      margin-bottom: 0;
      flex-wrap: wrap;
    }

    .tab-button {
      padding: 16px 24px;
      background: none;
      border: none;
      color: var(--gray);
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 3px solid transparent;
      margin-bottom: -3px;
    }

    .tab-button:hover {
      color: var(--blue);
    }

    .tab-button.active {
      color: var(--blue);
      border-bottom-color: var(--blue);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 640px) {
      .tab-button {
        padding: 12px 16px;
        font-size: 14px;
      }

      .tabs-header {
        gap: 4px;
      }
    }
  </style>
{% endblock %}

{% block content %}
  {% csrf_token %}
  <!-- Page Header -->
  <header class="page-header">
    <div class="std-wrap">
      <h1 class="page-title">Appointments</h1>
      <p class="page-description">Connect with our experienced specialists for personalized medical care and expert advice. Book your appointment with our leading healthcare professionals.</p>
    </div>
  </header>

    {% if not is_logged_in %}
      <!-- Compact Encouraging Message for Non-Logged-In Users -->
    <div style="background: linear-gradient(135deg, #2c71b7 0%, #2c71b7 100%); color: white; padding: 20px; border-radius: 12px; margin: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
          <div style="flex: 1; min-width: 250px;">
            <h3 style="font-size: 20px; font-weight: 700; margin: 0 0 8px 0;">Welcome to MediSafe+ Appointments</h3>
            <p style="font-size: 14px; opacity: 0.9; margin: 0; line-height: 1.4;">{{ encouraging_message }}</p>
          </div>
          <button class="standard-login-btn" onclick="document.getElementById('loginBtn')?.click();" aria-label="Login to Book Appointments">
            <i class="fas fa-sign-in-alt" style="margin-right: 6px;"></i>Login to Book Appointments
          </button>
        </div>
      </div>
      
      <!-- Login Button now triggers standardized header login modal -->
    {% endif %}

  <div class="quick-booking-banner std-wrap">
    <div class="content">
      <p style="text-transform:uppercase; letter-spacing:1px; font-size:12px; opacity:0.8; margin:0 0 6px;">Need a doctor fast?</p>
      <h3 style="margin:0 0 6px; font-size:22px; font-weight:800;">Instant Doctor Booking</h3>
      <p style="margin:0; opacity:0.85;">Pick a specialist below and jump straight into the booking flowâ€”same experience as the cards, zero scrolling.</p>
    </div>
    <div class="quick-booking-controls">
      <select id="heroQuickSelectDoctor" class="quick-booking-select" aria-label="Select doctor for quick booking">
        <option value="">Select a doctor</option>
        {% for doctor in doctors %}
        <option value="{{ doctor.doctor_id }}">Dr. {{ doctor.first_name }} {{ doctor.last_name }} â€” {{ doctor.specialization }}</option>
        {% endfor %}
      </select>
      <button type="button" id="heroQuickBookBtn" class="quick-booking-btn">
        <i class="fas fa-bolt"></i> Book Now
      </button>
    </div>
  </div>

  <!-- Main Content with Tabbed UI -->
  <main class="std-wrap">
    <!-- Tabs Container -->
    <div class="tabs-container">
      <!-- Tab Buttons -->
      <div class="tabs-header">
        <button class="tab-button active" data-tab="book-tab">
          <i class="fas fa-calendar-plus"></i> Book New Appointment
        </button>
        <button class="tab-button" data-tab="my-appointments-tab">
          <i class="fas fa-list"></i> My Upcoming Appointments
        </button>
        <button class="tab-button" data-tab="all-appointments-tab">
          <i class="fas fa-history"></i> All Appointments
        </button>
      </div>

      <!-- Tab 1: Book New Appointment (Primary) -->
      <div id="book-tab" class="tab-content active">
        <section class="book-consultation">
          <h2 class="section-title">Book New Appointment</h2>
          <div class="consultations-grid">
            {% for doctor in doctors %}
            <div class="consultation-card" data-availability='{{ doctor.availability|escapejs }}' data-appointment-count='{{ doctor.appointment_count|default:0 }}'>
              {% if doctor.photo_url %}
              <img src="{{ doctor.photo_url }}" alt="{{ doctor.specialization }}" class="card-image">
            {% else %}
              <img src="/static/images/default-doctor.jpg" alt="{{ doctor.specialization }}" class="card-image">
            {% endif %}
            <div class="card-content">
              <h2 class="specialty">{{ doctor.specialization }}</h2>
              <h3 class="doctor-name">Dr. {{ doctor.first_name }} {{ doctor.last_name }}, MD</h3>
              <p class="doctor-info">Experienced {{ doctor.specialization|lower }} specialist with {{ doctor.years_of_experience }}+ years of experience.</p>
              <div class="availability">
                <i class="fas fa-circle"></i>
                <span class="availability-text">
                  {% if doctor.availability.available %}
                    Available Today
                  {% else %}
                    Next Available: Tomorrow
                  {% endif %}
                </span>
              </div>
              <button class="book-btn" data-doctor-id="{{ doctor.doctor_id }}">Book Appointment</button>
              <div class="stats">
                <span class="stat appointments"><i class="fas fa-user-md"></i> {{ doctor.appointment_count|default:0 }} Appointments</span>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="no-doctors">
            <p>No doctors are currently available.</p>
          </div>
          {% endfor %}
        </div>
      </section>
      </div>

      <!-- Tab 2: My Upcoming Appointments -->
      <div id="my-appointments-tab" class="tab-content">
        <section class="my-consultations">
          <h2 class="section-title">My Upcoming Appointments</h2>
          <div class="consultations-grid" id="upcomingAppointmentsGrid">
            {% for consultation in consultations %}
            {% if consultation.status != 'Completed' and consultation.status != 'Cancelled' %}
            {% now "Y-m-d" as today_date %}
            {% if consultation.consultation_date|date:"Y-m-d" >= today_date %}
          <div class="consultation-card {% if consultation.consultation_type == 'Tele' %}tele-consult{% endif %}">
            <div class="card-content">
              <div class="consultation-header">
                <h3 class="doctor-name">Dr. {{ consultation.doctor.user.userprofile.first_name }} {{ consultation.doctor.user.userprofile.last_name }}</h3>
                <p class="specialty">{{ consultation.doctor.specialization }}</p>
              </div>
              
              <div class="consultation-details">
                <div class="detail-item">
                  <i class="fas {% if consultation.consultation_type == 'F2F' %}fa-user-md{% else %}fa-video{% endif %}"></i>
                  <span>{{ consultation.consultation_type }}</span>
                </div>
                <div class="detail-item">
                  <i class="far fa-calendar"></i>
                  <span>{{ consultation.consultation_date }}</span>
                </div>
                <div class="detail-item">
                  <i class="far fa-clock"></i>
                  <span>{{ consultation.consultation_time }}</span>
                </div>
                {% if consultation.approval_status == 'Approved' and consultation.appointment_number %}
                <div class="detail-item">
                  <i class="fas fa-hashtag"></i>
                  <span>Appointment No.: <strong>{{ consultation.appointment_number }}</strong></span>
                </div>
                {% endif %}
                <div class="detail-item">
                  <i class="fas fa-clipboard-check"></i>
                  <span class="status-badge status-{{ consultation.approval_status|lower }}">{{ consultation.approval_status }}</span>
                </div>
                <div class="detail-item">
                  <i class="fas fa-tasks"></i>
                  <span class="status-badge status-{{ consultation.status|lower }}">{{ consultation.status }}</span>
                </div>
                {% if consultation.consultation_type == 'Tele' and consultation.meeting_link %}
                <div class="detail-item">
                  <i class="fas fa-link"></i>
                  <a href="{{ consultation.meeting_link }}" target="_blank" class="meeting-link">Join Meeting</a>
                </div>
                {% endif %}
                {% if consultation.status != 'Cancelled' and consultation.status != 'Completed' %}
                <div class="detail-item full-width">
                  <button class="cancel-btn" data-consultation-id="{{ consultation.consultation_id }}">
                    <i class="fas fa-times-circle"></i> Cancel Appointment
                  </button>
                </div>
                {% endif %}
              </div>

              {% if consultation.notes %}
              <div class="consultation-notes">
                <p><strong>Notes:</strong> {{ consultation.notes }}</p>
              </div>
              {% endif %}
            </div>
          </div>
            {% endif %}
            {% endif %}
            {% empty %}
            <div class="no-consultations">
              <p>You don't have any upcoming appointments.</p>
            </div>
            {% endfor %}
        </div>
      </section>
      </div>

      <!-- Tab 3: All Appointments (Table View) -->
      <div id="all-appointments-tab" class="tab-content">
        <section class="all-appointments">
          <h2 class="section-title">All Appointments History</h2>
          
          <!-- Book Appointment with Doctor Selection Section -->
          <div style="background: linear-gradient(135deg, var(--blue) 0%, #003d80 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
              <div style="flex: 1; min-width: 250px;">
                <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-calendar-check"></i> Quick Book Appointment
                </h3>
                <p style="margin: 0; opacity: 0.9; font-size: 14px;">Select a doctor and schedule an appointment directly</p>
              </div>
              <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; min-width: 300px;">
                <select id="quickSelectDoctor" style="flex: 1; min-width: 180px; padding: 10px 14px; background: white; color: var(--ink); border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                  <option value="">-- Select Doctor --</option>
                  {% for doctor in doctors %}
                  <option value="{{ doctor.doctor_id }}" data-doctor-name="Dr. {{ doctor.user.userprofile.first_name }} {{ doctor.user.userprofile.last_name }}" data-doctor-spec="{{ doctor.specialization }}">Dr. {{ doctor.user.userprofile.first_name }} {{ doctor.user.userprofile.last_name }} - {{ doctor.specialization }}</option>
                  {% endfor %}
                </select>
                <button onclick="bookAppointmentWithDoctor()" style="padding: 10px 20px; background: white; color: var(--blue); border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                  <i class="fas fa-plus-circle"></i> Book Now
                </button>
              </div>
            </div>
          </div>
          
          <!-- Statistics Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px;">
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <p style="color: var(--gray); font-size: 14px; margin: 0 0 8px;">Total Appointments</p>
              <h3 style="font-size: 28px; font-weight: 700; color: var(--blue); margin: 0;" id="totalAppointmentsCount">{{ consultations|length }}</h3>
            </div>
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <p style="color: var(--gray); font-size: 14px; margin: 0 0 8px;">Completed</p>
              <h3 style="font-size: 28px; font-weight: 700; color: var(--success); margin: 0;" id="completedAppointmentsCount">0</h3>
            </div>
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <p style="color: var(--gray); font-size: 14px; margin: 0 0 8px;">Upcoming</p>
              <h3 style="font-size: 28px; font-weight: 700; color: var(--pending); margin: 0;" id="upcomingAppointmentsCount">0</h3>
            </div>
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <p style="color: var(--gray); font-size: 14px; margin: 0 0 8px;">Cancelled</p>
              <h3 style="font-size: 28px; font-weight: 700; color: var(--cancelled); margin: 0;" id="cancelledAppointmentsCount">0</h3>
            </div>
          </div>
          
          <!-- Search & Filter Controls - Enhanced Design -->
          <div style="background: white; padding: 24px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <!-- Main search bar -->
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 700; margin-bottom: 8px; color: var(--ink); font-size: 14px;">Search Appointments</label>
              <input type="text" id="allApptSearch" placeholder="ðŸ” Search by doctor name, specialization, type, or notes..." style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border 0.2s;" onmouseover="this.style.borderColor='#cbd5e1'" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='#e2e8f0'">
            </div>
            
            <!-- Filter Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 16px;">
              <!-- Date From -->
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--ink); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">From Date</label>
                <input type="date" id="allApptDateFrom" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; background: white; cursor: pointer;" onchange="applyAllApptFilters()">
              </div>
              
              <!-- Date To -->
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--ink); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">To Date</label>
                <input type="date" id="allApptDateTo" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; background: white; cursor: pointer;" onchange="applyAllApptFilters()">
              </div>
              
              <!-- Status Filter -->
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--ink); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Status</label>
                <select id="allApptStatusFilter" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; background: white; cursor: pointer;" onchange="applyAllApptFilters()">
                  <option value="">All Status</option>
                  <option value="Scheduled">Scheduled</option>
                  <option value="Completed">Completed</option>
                  <option value="Cancelled">Cancelled</option>
                  <option value="Past">Past</option>
                </select>
              </div>
              
              <!-- Approval Status Filter -->
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--ink); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Approval</label>
                <select id="allApptApprovalFilter" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; background: white; cursor: pointer;" onchange="applyAllApptFilters()">
                  <option value="">All Status</option>
                  <option value="Pending">Pending</option>
                  <option value="Approved">Approved</option>
                  <option value="Rejected">Rejected</option>
                </select>
              </div>
              
              <!-- Type Filter -->
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--ink); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Type</label>
                <select id="allApptTypeFilter" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; background: white; cursor: pointer;" onchange="applyAllApptFilters()">
                  <option value="">All Types</option>
                  <option value="F2F">Face to Face</option>
                  <option value="Tele">Tele-Consultation</option>
                </select>
              </div>
              
              <!-- Sort By -->
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--ink); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Sort By</label>
                <select id="allApptSortOrder" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px; background: white; cursor: pointer;" onchange="applyAllApptFilters()">
                  <option value="date-desc">Newest First</option>
                  <option value="date-asc">Oldest First</option>
                  <option value="doctor-asc">Doctor (A-Z)</option>
                  <option value="status-asc">Status (A-Z)</option>
                </select>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="clearAllApptFilters()" style="padding: 10px 16px; background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                <i class="fas fa-redo"></i> Reset Filters
              </button>
              <button onclick="exportAllAppointments()" style="padding: 10px 16px; background: var(--blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: background 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#1e40af'" onmouseout="this.style.background='var(--blue)'">
                <i class="fas fa-download"></i> Export CSV
              </button>
            </div>
          </div>

          <!-- Appointments Table -->
          <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="background: var(--blue); color: white;">
                <tr>
                  <th style="padding: 15px; text-align: left; font-weight: 700;">Doctor</th>
                  <th style="padding: 15px; text-align: left; font-weight: 700;">Specialization</th>
                  <th style="padding: 15px; text-align: left; font-weight: 700;">Type</th>
                  <th style="padding: 15px; text-align: left; font-weight: 700;">Date</th>
                  <th style="padding: 15px; text-align: left; font-weight: 700;">Time</th>
                  <th style="padding: 15px; text-align: left; font-weight: 700;">Approval Status</th>
                  <th style="padding: 15px; text-align: left; font-weight: 700;">Status</th>
                  <th style="padding: 15px; text-align: center; font-weight: 700;">Actions</th>
                </tr>
              </thead>
              <tbody id="allAppointmentsTableBody">
                {% for consultation in consultations %}
                <tr class="appointment-row" 
                    style="border-bottom: 1px solid #e2e8f0; transition: background 0.2s;" 
                    onmouseover="this.style.background='#f8fafc'" 
                    onmouseout="this.style.background=''"
                    data-date="{{ consultation.consultation_date|date:'Y-m-d' }}"
                    data-status="{{ consultation.status }}"
                    data-approval-status="{{ consultation.approval_status }}"
                    data-type="{{ consultation.consultation_type }}"
                    data-doctor="Dr. {{ consultation.doctor.user.userprofile.first_name }} {{ consultation.doctor.user.userprofile.last_name }}"
                    data-specialization="{{ consultation.doctor.specialization }}"
                    data-consultation-id="{{ consultation.consultation_id }}"
                    data-notes="{{ consultation.notes|default:''|escapejs }}">
                  <td style="padding: 12px 15px;">Dr. {{ consultation.doctor.user.userprofile.first_name }} {{ consultation.doctor.user.userprofile.last_name }}</td>
                  <td style="padding: 12px 15px;">{{ consultation.doctor.specialization }}</td>
                  <td style="padding: 12px 15px;">
                    <span style="{% if consultation.consultation_type == 'F2F' %}background: #dbeafe; color: #1e40af;{% else %}background: #e0e7ff; color: #3730a3;{% endif %} padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                      {{ consultation.consultation_type }}
                    </span>
                  </td>
                  <td style="padding: 12px 15px;">{{ consultation.consultation_date }}</td>
                  <td style="padding: 12px 15px;">{{ consultation.consultation_time }}</td>
                  <td style="padding: 12px 15px;">
                    <span style="{% if consultation.approval_status == 'Approved' %}background: #dcfce7; color: #166534;{% elif consultation.approval_status == 'Rejected' %}background: #fee2e2; color: #991b1b;{% else %}background: #fef3c7; color: #92400e;{% endif %} padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                      {{ consultation.approval_status }}
                    </span>
                  </td>
                  <td style="padding: 12px 15px;">
                    <span style="{% if consultation.status == 'Completed' %}background: #dcfce7; color: #166534;{% elif consultation.status == 'Cancelled' %}background: #e5e7eb; color: #374151;{% elif consultation.status == 'Scheduled' %}background: #dbeafe; color: #1e40af;{% else %}background: #f3f4f6; color: #4b5563;{% endif %} padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                      {{ consultation.status }}
                    </span>
                  </td>
                  <td style="padding: 12px 15px; text-align: center;">
                    <div style="display: flex; gap: 8px; justify-content: center; align-items: center; flex-wrap: wrap;">
                      <!-- Check if appointment is in the future -->
                      <script>
                        (function() {
                          const appointmentDate = '{{ consultation.consultation_date|date:"Y-m-d" }}';
                          const appointmentTime = '{{ consultation.consultation_time }}';
                          const appointmentDateTime = new Date(appointmentDate + 'T' + appointmentTime);
                          const now = new Date();
                          const isPast = appointmentDateTime < now;
                          
                          if (!isPast) {
                            // Only show join/cancel buttons for upcoming appointments
                            const consultationId = {{ consultation.consultation_id }};
                            const consultationType = '{{ consultation.consultation_type }}';
                            const meetingLink = '{{ consultation.meeting_link }}';
                            const status = '{{ consultation.status }}';
                            
                            let html = '';
                            if (consultationType === 'Tele' && meetingLink && status !== 'Cancelled') {
                              html += `<a href="${meetingLink}" target="_blank" style="color: var(--blue); text-decoration: none; font-weight: 600; padding: 4px 8px; border-radius: 6px; background: #dbeafe; transition: background 0.2s;" onmouseover="this.style.background='#bfdbfe'" onmouseout="this.style.background='#dbeafe'"><i class="fas fa-video"></i> Join</a>`;
                            }
                            if (status !== 'Cancelled' && status !== 'Completed') {
                              html += `<button onclick="cancelAppointment(${consultationId})" style="background: #fee2e2; color: #991b1b; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: background 0.2s;" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'"><i class="fas fa-times"></i> Cancel</button>`;
                            }
                            document.currentScript.parentElement.innerHTML = html;
                          }
                        })();
                      </script>
                      
                      {% if consultation.status == 'Completed' %}
                      <button onclick="viewAppointmentDetails({{ consultation.consultation_id }})" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: background 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                        <i class="fas fa-eye"></i> Details
                      </button>
                      <button onclick="viewPrescription({{ consultation.consultation_id }})" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: background 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                        <i class="fas fa-prescription-bottle-alt"></i> Prescription
                      </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="8" style="padding: 30px; text-align: center; color: var(--gray);">
                    <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
                    You don't have any appointments yet.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Booking Modal -->
  <div class="booking-modal" id="bookingModal" style="display: none;">
    <div class="modal-content">
      <h2>Book Appointment</h2>
      <form id="bookingForm" method="POST" action="{% url 'book_consultation' %}">
        {% csrf_token %}
        <input type="hidden" name="doctor_id" id="selectedDoctorId">
        <!-- Add your booking form fields here -->
      </form>
    </div>
  </div>

  <!-- Old booking modal script removed - using new booking overlay system -->
          
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Consultation Type Selection Overlay -->
  <div id="bookingOverlay" class="booking-overlay">
    <div class="overlay-background"></div>
    <div class="booking-panel">
      <button class="close-btn">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="booking-content">
        <div class="doctor-preview">
          <div class="doctor-image">
            <!-- Doctor image will be set by JavaScript -->
          </div>
          <div class="doctor-details">
            <h2 class="doctor-specialty"></h2>
            <h3 class="doctor-name"></h3>
            <p class="doctor-bio"></p>
            <div class="doctor-stats">
              <span class="stat"><i class="fas fa-user-md"></i> <span class="consultations"></span></span>
            </div>
            <div class="doctor-availability">
              <i class="fas fa-circle"></i>
              <span class="availability-text"></span>
            </div>
          </div>
        </div>

        <div class="booking-section">
          <h2 class="booking-title">Select Consultation Type</h2>
          <p class="booking-subtitle">Choose your preferred consultation method</p>
          
          <div class="consultation-options">
            <button class="option-btn face-to-face" data-type="F2F">
              <div class="option-icon">
                <i class="fas fa-user-md"></i>
              </div>
              <div class="option-text">
                <h3>Face-to-Face Consultation</h3>
                <p>Visit our clinic for an in-person consultation</p>
              </div>
            </button>
            
            <button class="option-btn tele-consult" data-type="Tele">
              <div class="option-icon">
                <i class="fas fa-video"></i>
              </div>
              <div class="option-text">
                <h3>Tele-Consultation</h3>
                <p>Consult with our doctor through video call</p>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Consultation Booking Form Overlay -->
  <div id="bookingFormOverlay" class="booking-overlay">
    <div class="overlay-background"></div>
    <div class="booking-panel">
      <button class="close-btn">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="booking-content">
        <form id="consultationBookingForm" class="consultation-form">
          {% csrf_token %}
          <input type="hidden" name="doctor_id" id="bookingDoctorId">
          <input type="hidden" name="consultation_type" id="bookingConsultationType">

          <!-- Doctor Info Section -->
          <div class="form-doctor-info">
            <div class="doctor-photo">
              <!-- Will be set by JavaScript -->
            </div>
            <div class="doctor-text">
              <h3 class="doctor-name"><!-- Will be set by JavaScript --></h3>
              <p class="doctor-specialty"><!-- Will be set by JavaScript --></p>
            </div>
          </div>

          <!-- Progress Indicator for Non-Logged-In Users -->
          <div id="bookingProgress" style="display: none; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <span style="font-weight: 600; color: #2c71b7;">Booking Progress</span>
              <span id="progressText" style="font-size: 14px; color: #64748b;">Step 1 of 3</span>
            </div>
            <div style="background: #e2e8f0; height: 6px; border-radius: 3px; overflow: hidden;">
              <div id="progressBar" style="background: linear-gradient(90deg, #2c71b7, #3b82f6); height: 100%; width: 33%; transition: width 0.3s ease;"></div>
            </div>
          </div>
          
          <!-- Patient Information Section (for non-logged-in users) -->
          <div class="form-section" id="patientInfoSection" style="display: none;">
            <h3 class="section-title">Patient Information</h3>
            
            <!-- Scrollable container for patient info with horizontal layout -->
            <div style="max-height: 350px; overflow-y: auto; padding-right: 15px; margin-bottom: 20px; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px;">
              <!-- Row 1: Name fields -->
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="form-group">
                  <label for="firstName">First Name *</label>
                  <input type="text" id="firstName" name="first_name" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                </div>
                
                <div class="form-group">
                  <label for="middleName">Middle Name</label>
                  <input type="text" id="middleName" name="middle_name" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                </div>
                
                <div class="form-group">
                  <label for="lastName">Last Name *</label>
                  <input type="text" id="lastName" name="last_name" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                </div>
              </div>

              <!-- Row 2: Contact info -->
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="form-group">
                  <label for="email">Email Address *</label>
                  <input type="email" id="email" name="email" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                </div>
                
                <div class="form-group">
                  <label for="phoneNumber">Phone Number *</label>
                  <input type="tel" id="phoneNumber" name="phone_number" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                </div>
                
                <div class="form-group">
                  <label for="birthday">Date of Birth *</label>
                  <input type="date" id="birthday" name="birthday" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                </div>
              </div>

              <!-- Row 3: Address -->
              <div style="margin-bottom: 20px;">
                <div class="form-group">
                  <label for="address">Address</label>
                  <textarea id="address" name="address" rows="2" placeholder="Your complete address" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; resize: vertical;"></textarea>
                </div>
              </div>

              <!-- Row 4: Emergency contacts -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                  <label for="emergencyContact">Emergency Contact Name</label>
                  <input type="text" id="emergencyContact" name="emergency_contact" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                </div>
                
                <div class="form-group">
                  <label for="emergencyPhone">Emergency Contact Phone</label>
                  <input type="tel" id="emergencyPhone" name="emergency_phone" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
                </div>
              </div>
            </div>
          </div>

          <!-- Consultation Details -->
          <div class="form-section">
            <h3 class="section-title">Appointment Details</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="consultationDate">Preferred Date *</label>
                <input type="date" id="consultationDate" name="consultation_date" required 
                       min="{{ today|date:'Y-m-d' }}">
              </div>
              
              <div class="form-group">
                <label for="consultationTime">Preferred Time *</label>
                <input type="time" id="consultationTime" name="consultation_time" required>
              </div>
            </div>

            <div class="form-group full-width" id="reasonForVisitSection">
              <label for="reasonForVisit">Reason for Visit</label>
              <textarea id="reasonForVisit" name="reason_for_visit" rows="3" 
                        placeholder="Brief description of why you need the appointment (optional)"></textarea>
            </div>

            <div class="form-group full-width">
              <label for="consultationNotes">Notes (Optional)</label>
              <textarea id="consultationNotes" name="notes" rows="4" 
                        placeholder="Additional information or concerns you'd like the doctor to know"></textarea>
            </div>
          </div>

          <div class="form-actions">
            {% if not is_logged_in %}
            <button type="submit" class="submit-btn">
              <i class="fas fa-calendar-check"></i>
              Book Appointment
            </button>
            {% else %}
            <button type="button" class="submit-btn" id="createAppointmentBtn" style="display:none;">
              <i class="fas fa-plus-circle"></i>
              Create Appointment
            </button>
            <button type="button" class="submit-btn" id="newCreateAppointmentBtn" style="background: #10B981;">
              <i class="fas fa-check"></i>
              Submit Appointment
            </button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>

  <style>
    /* Booking Overlay Styles */
    .booking-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .booking-overlay.active {
      display: flex;
    }

    .overlay-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(4px);
    }

    .booking-panel {
      position: relative;
      width: 95%;
      max-width: 800px;
      max-height: 90vh;
      background: white;
      border-radius: 24px;
      padding: 30px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.3s ease-out;
      overflow-y: auto;
    }

    .booking-overlay.active .booking-panel {
      transform: translateY(0);
      opacity: 1;
    }

    .close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      border-radius: 20px;
      border: none;
      background: #f1f5f9;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: #e2e8f0;
      color: #0f172a;
    }

    .booking-content {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .doctor-preview {
      display: flex;
      gap: 24px;
      padding-bottom: 32px;
      border-bottom: 1px solid var(--border);
    }

    .doctor-image {
      width: 120px;
      height: 120px;
      border-radius: 16px;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
    }

    .doctor-details {
      flex: 1;
      text-align: left;
    }

    .doctor-specialty {
      color: var(--blue);
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 8px;
    }

    .doctor-name {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 8px;
      color: var(--ink);
    }

    .doctor-bio {
      color: var(--gray);
      font-size: 14px;
      line-height: 1.6;
      margin: 0 0 16px;
    }

    .doctor-stats {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      color: var(--gray);
      font-size: 14px;
    }

    .doctor-availability {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--success);
      font-size: 14px;
    }

    .doctor-availability i {
      font-size: 10px;
    }

    .booking-section {
      text-align: center;
    }

    .booking-title {
      color: var(--blue);
      font-size: 28px;
      font-weight: 800;
      margin: 0 0 8px;
    }

    .booking-subtitle {
      color: var(--gray);
      font-size: 16px;
      margin: 0 0 32px;
    }

    .consultation-options {
      display: grid;
      gap: 16px;
      grid-template-columns: 1fr;
    }

    .option-btn {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 24px;
      border: 2px solid var(--border);
      border-radius: 16px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .option-btn:hover {
      border-color: var(--blue);
      background: #f8fafc;
      transform: translateY(-2px);
    }

    .option-icon {
      width: 56px;
      height: 56px;
      border-radius: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .face-to-face .option-icon {
      background: #dbeafe;
      color: var(--blue);
    }

    .tele-consult .option-icon {
      background: #fee2e2;
      color: var(--red);
    }

    .option-text h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 4px;
      color: var(--ink);
    }

    .option-text p {
      font-size: 14px;
      color: var(--gray);
      margin: 0;
    }

    @media (min-width: 640px) {
      .consultation-options {
        grid-template-columns: 1fr 1fr;
      }
      
      .option-btn {
        flex-direction: column;
        text-align: center;
        padding: 32px 24px;
      }
    }
  </style>

  <script>
    // ==================== TAB MANAGEMENT ====================
    function initializeTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabName = button.getAttribute('data-tab');
          
          // Remove active class from all buttons and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Add active class to clicked button and corresponding content
          button.classList.add('active');
          document.getElementById(tabName).classList.add('active');
          
          // Save active tab to localStorage
          localStorage.setItem('consultationsActiveTab', tabName);
        });
      });

      // Restore active tab from localStorage
      const savedTab = localStorage.getItem('consultationsActiveTab') || 'book-tab';
      const savedTabButton = document.querySelector(`[data-tab="${savedTab}"]`);
      if (savedTabButton) {
        savedTabButton.click();
      }
    }

    // Initialize tabs when DOM is ready
    document.addEventListener('DOMContentLoaded', initializeTabs);

    // Populate availability text on doctor cards using data-availability JSON
    function populateDoctorCardsAvailability() {
      document.querySelectorAll('.consultation-card').forEach(card => {
        const data = card.dataset.availability;
        let availText = null;
        try {
          const av = JSON.parse(data || '{}');
          if (av.available) {
            availText = 'Available Today';
          } else if (av.schedules && av.schedules.length > 0) {
            const s = av.schedules[0];
            const days = (s.days && s.days.length) ? s.days.join(', ') : '';
            if (s.start && s.end) {
              availText = days ? `${days}: ${s.start} - ${s.end}` : `${s.start} - ${s.end}`;
            } else if (days) {
              availText = `Next: ${days}`;
            }
          }
        } catch(e) {
          availText = null;
        }

        const el = card.querySelector('.availability-text');
        if (el) {
          el.textContent = availText || el.textContent || 'Next Available: Tomorrow';
        }

        // Ensure consultations stat reflects annotated count
        const consultationsEl = card.querySelector('.stat.appointments');
        if (consultationsEl) {
          const count = card.dataset.appointmentCount || '0';
          consultationsEl.innerHTML = `<i class="fas fa-user-md"></i> ${count} Appointments`;
        }
      });
    }

    document.addEventListener('DOMContentLoaded', populateDoctorCardsAvailability);

    // Get DOM elements
    const bookingOverlay = document.getElementById('bookingOverlay');
    const bookingFormOverlay = document.getElementById('bookingFormOverlay');
    const closeButtons = document.querySelectorAll('.close-btn');
    const overlayBackgrounds = document.querySelectorAll('.overlay-background');
    let currentDoctorData = null;

    function triggerBookFlowForDoctor(doctorId) {
      if (!doctorId) {
        showNotification('Please select a doctor', 'error');
        return false;
      }
      const targetButton = document.querySelector(`.book-btn[data-doctor-id="${doctorId}"]`);
      if (targetButton) {
        targetButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => targetButton.click(), 120);
        return true;
      }
      showNotification('Selected doctor is not available right now.', 'error');
      return false;
    }

    // Add click handler for booking buttons
    document.querySelectorAll('.book-btn').forEach(button => {
      button.addEventListener('click', function() {
        const card = this.closest('.consultation-card');
        const cardContent = card.querySelector('.card-content');

        // Parse availability JSON from data attribute if present
        let availabilityData = {};
        try {
          availabilityData = JSON.parse(card.dataset.availability || '{}');
        } catch (e) {
          availabilityData = {};
        }

        // Store doctor information
        currentDoctorData = {
          id: this.dataset.doctorId,
          name: cardContent.querySelector('.doctor-name').textContent,
          specialty: cardContent.querySelector('.specialty').textContent,
          info: cardContent.querySelector('.doctor-info').textContent,
          image: card.querySelector('.card-image').src,
          availability: availabilityData,
          consultations: card.dataset.appointmentCount || '0'
        };

        // Update type selection overlay content
        updateTypeSelectionOverlay(currentDoctorData);

        // Show overlay with animation
        showOverlay(bookingOverlay);
      });
    });

    // Update type selection overlay content
    function updateTypeSelectionOverlay(doctorData) {
      const overlay = document.getElementById('bookingOverlay');
      overlay.querySelector('.doctor-specialty').textContent = doctorData.specialty;
      overlay.querySelector('.doctor-name').textContent = doctorData.name;
      overlay.querySelector('.doctor-bio').textContent = doctorData.info;
      overlay.querySelector('.doctor-image').style.backgroundImage = `url(${doctorData.image})`;
      // Build a friendly availability string
      let availText = 'Next Available: Tomorrow';
      try {
        const av = doctorData.availability || {};
        if (av.available) {
          availText = 'Available Today';
        } else if (av.schedules && av.schedules.length > 0) {
          const s = av.schedules[0];
          const days = (s.days && s.days.length) ? s.days.join(', ') : '';
          if (s.start && s.end) {
            availText = days ? `${days}: ${s.start} - ${s.end}` : `${s.start} - ${s.end}`;
          } else if (days) {
            availText = `Next: ${days}`;
          }
        }
      } catch(e) {
        availText = 'Next Available: Tomorrow';
      }
      overlay.querySelector('.availability-text').textContent = availText;
      // Rating removed; update consultations count
      overlay.querySelector('.consultations').textContent = doctorData.consultations + ' Appointments';
    }

    // Update booking form content
        function updateBookingForm(doctorData, consultationType) {
          const form = document.getElementById('consultationBookingForm');
          const formOverlay = document.getElementById('bookingFormOverlay');
          const patientInfoSection = document.getElementById('patientInfoSection');
          const bookingProgress = document.getElementById('bookingProgress');
          
          // Set hidden inputs
          form.querySelector('#bookingDoctorId').value = doctorData.id;
          form.querySelector('#bookingConsultationType').value = consultationType;
          
          console.log('Form populated with:');
          console.log('Doctor ID:', doctorData.id);
          console.log('Consultation Type:', consultationType);
          
          // Update doctor info display
          formOverlay.querySelector('.doctor-photo').style.backgroundImage = `url(${doctorData.image})`;
          formOverlay.querySelector('.doctor-name').textContent = doctorData.name;
          formOverlay.querySelector('.doctor-specialty').textContent = doctorData.specialty;
          
          // Show/hide patient info section and reason for visit based on login status
          const isLoggedIn = "{{ is_logged_in|yesno:'true,false' }}" === 'true';
          const reasonForVisitSection = document.getElementById('reasonForVisitSection');
          
          if (!isLoggedIn) {
            patientInfoSection.style.display = 'block';
            bookingProgress.style.display = 'block';
            updateProgress(1);
            // Hide reason for visit section for guests
            if (reasonForVisitSection) reasonForVisitSection.style.display = 'none';
            // Set form action for guest booking
            form.action = '{% url "book_consultation_guest" %}';
          } else {
            patientInfoSection.style.display = 'none';
            bookingProgress.style.display = 'none';
            // Show reason for visit section for logged-in users
            if (reasonForVisitSection) reasonForVisitSection.style.display = 'block';
            // Set form action for logged-in user booking - using new create_appointment view
            form.action = '{% url "create_appointment" %}';
            console.log('Form configured for logged-in user with create_appointment URL');
          }
        }
        
        // Progress indicator functions
        function updateProgress(step) {
          const progressBar = document.getElementById('progressBar');
          const progressText = document.getElementById('progressText');
          const steps = ['Patient Information', 'Appointment Details', 'Confirmation'];
          
          progressBar.style.width = `${(step / 3) * 100}%`;
          progressText.textContent = `Step ${step} of 3: ${steps[step - 1]}`;
        }
        
        // Add progress tracking to form sections
        document.addEventListener('DOMContentLoaded', function() {
          const patientSection = document.getElementById('patientInfoSection');
          const appointmentSection = document.querySelector('.form-section:last-of-type');
          
          // Load saved form data
          loadSavedFormData();
          
          if (patientSection) {
            const patientInputs = patientSection.querySelectorAll('input, textarea');
            patientInputs.forEach(input => {
              input.addEventListener('blur', function() {
                const filledInputs = Array.from(patientInputs).filter(inp => inp.value.trim() !== '');
                if (filledInputs.length >= 3) { // At least 3 fields filled
                  updateProgress(2);
                }
                // Save form data as user types
                saveFormData();
              });
            });
          }
          
          if (appointmentSection) {
            const appointmentInputs = appointmentSection.querySelectorAll('input, select, textarea');
            appointmentInputs.forEach(input => {
              input.addEventListener('change', function() {
                const filledInputs = Array.from(appointmentInputs).filter(inp => inp.value.trim() !== '');
                if (filledInputs.length >= 2) { // At least 2 fields filled
                  updateProgress(3);
                }
                // Save form data as user types
                saveFormData();
              });
            });
          }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
          const heroQuickBookBtn = document.getElementById('heroQuickBookBtn');
          if (heroQuickBookBtn) {
            heroQuickBookBtn.addEventListener('click', function() {
              bookAppointmentFromHero();
            });
          }
        });
        
        // Save form data to localStorage
        function saveFormData() {
          const formData = {};
          const form = document.getElementById('consultationBookingForm');
          const inputs = form.querySelectorAll('input, select, textarea');
          
          inputs.forEach(input => {
            if (input.name && input.value) {
              formData[input.name] = input.value;
            }
          });
          
          localStorage.setItem('bookingFormData', JSON.stringify(formData));
        }
        
        // Load saved form data from localStorage
        function loadSavedFormData() {
          const savedData = localStorage.getItem('bookingFormData');
          if (savedData) {
            const formData = JSON.parse(savedData);
            const form = document.getElementById('consultationBookingForm');
            
            Object.keys(formData).forEach(name => {
              const input = form.querySelector(`[name="${name}"]`);
              if (input) {
                input.value = formData[name];
              }
            });
          }
        }
        
        // Clear saved form data after successful submission
        function clearSavedFormData() {
          localStorage.removeItem('bookingFormData');
        }
        
        // Enhanced form validation with notifications
        function validateBookingForm() {
          const form = document.getElementById('consultationBookingForm');
          const isLoggedIn = "{{ is_logged_in|yesno:'true,false' }}" === 'true';
          let isValid = true;
          let errorMessages = [];
          
          console.log('Validating form for logged-in user:', isLoggedIn);
          
          if (!isLoggedIn) {
            // Validate patient information
            const requiredFields = ['first_name', 'last_name', 'email', 'phone_number', 'birthday'];
            requiredFields.forEach(fieldName => {
              const field = form.querySelector(`[name="${fieldName}"]`);
              if (!field || !field.value.trim()) {
                isValid = false;
                errorMessages.push(`${fieldName.replace('_', ' ').toUpperCase()} is required`);
              }
            });
            
            // Validate email format
            const emailField = form.querySelector('[name="email"]');
            if (emailField && emailField.value) {
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(emailField.value)) {
                isValid = false;
                errorMessages.push('Please enter a valid email address');
              }
            }
          }
          
          // Validate appointment details
          const dateField = form.querySelector('[name="consultation_date"]');
          const timeField = form.querySelector('[name="consultation_time"]');
          
          console.log('Date field:', dateField, 'Value:', dateField ? dateField.value : 'null');
          console.log('Time field:', timeField, 'Value:', timeField ? timeField.value : 'null');
          
          if (!dateField || !dateField.value) {
            isValid = false;
            errorMessages.push('Appointment date is required');
          }
          
          if (!timeField || !timeField.value) {
            isValid = false;
            errorMessages.push('Appointment time is required');
          }
          
          // Show validation results
          if (!isValid) {
            showNotification(errorMessages.join('<br>'), 'error');
            return false;
          }
          
          return true;
        }
        
        // Notification system
        function showNotification(message, type = 'info') {
          // Remove existing notifications
          const existingNotifications = document.querySelectorAll('.notification');
          existingNotifications.forEach(notification => notification.remove());
          
          const notification = document.createElement('div');
          notification.className = 'notification';
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
          `;
          
          // Set colors based on type
          if (type === 'error') {
            notification.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
          } else if (type === 'success') {
            notification.style.background = 'linear-gradient(135deg, #10b981, #059669)';
          } else {
            notification.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
          }
          
          notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
              <span>${message}</span>
            </div>
          `;
          
          document.body.appendChild(notification);
          
          // Auto remove after 5 seconds
          setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
          }, 5000);
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);

    // Show overlay with animation
    function showOverlay(overlay) {
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // Close overlay function
    function closeOverlay(overlay) {
      overlay.classList.remove('active');
      if (!document.querySelector('.booking-overlay.active')) {
        document.body.style.overflow = '';
      }
    }

    // Close button click handlers
    closeButtons.forEach(button => {
      button.addEventListener('click', function() {
        closeOverlay(this.closest('.booking-overlay'));
      });
    });

    // Background click handlers
    overlayBackgrounds.forEach(background => {
      background.addEventListener('click', function() {
        closeOverlay(this.closest('.booking-overlay'));
      });
    });

    // Prevent panel clicks from closing overlay
    document.querySelectorAll('.booking-panel').forEach(panel => {
      panel.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    });

    // Handle consultation type selection
    document.querySelectorAll('.option-btn').forEach(button => {
      button.addEventListener('click', function() {
        const consultationType = this.dataset.type;
        
        // Close type selection overlay and show booking form
        closeOverlay(bookingOverlay);
        updateBookingForm(currentDoctorData, consultationType);
        showOverlay(bookingFormOverlay);
      });
    });

    // Handle booking form submission - wrapped in DOMContentLoaded to ensure form exists
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up form submission handler');
    const consultationBookingForm = document.getElementById('consultationBookingForm');
    console.log('Consultation booking form found:', consultationBookingForm);
      
    if (consultationBookingForm) {
      console.log('Adding event listener to consultation booking form');
        
        // Also add click handler to the submit button for debugging
        const submitButton = consultationBookingForm.querySelector('button[type="submit"]');
        if (submitButton) {
          console.log('Found submit button:', submitButton);
          submitButton.addEventListener('click', function() {
            console.log('Submit button clicked!');
          });
        }
        
      consultationBookingForm.addEventListener('submit', async function(e) {
        e.preventDefault();
          console.log('Booking form submitted event fired');
        
        // Check if user is logged in - handle differently for logged-in vs guest
        const isLoggedIn = "{{ is_logged_in|yesno:'true,false' }}" === 'true';
        
        console.log('User logged in:', isLoggedIn);
        
        // Validate form before submission
        if (!validateBookingForm()) {
          console.log('Form validation failed');
          return;
        }
        
        console.log('Form validation passed');
        
        try {
          const formData = new FormData(this);
          
          // Determine which URL to use based on login status
          const bookingUrl = this.action; // Use the form's action attribute
          
          console.log('Booking URL:', bookingUrl);

          // Get CSRF token from cookie
          function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
                }
              }
            }
            return cookieValue;
          }

            // Try to get CSRF token
            let csrfToken = getCookie('csrftoken');
            console.log('CSRF Token found:', csrfToken ? 'Yes' : 'No');
            console.log('CSRF Token value:', csrfToken);

          const response = await fetch(bookingUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken || ''
            },
              body: formData,
              credentials: 'same-origin'
          });

          console.log('Response status:', response.status);
          console.log('Response content-type:', response.headers.get('content-type'));
          
          // Check if response is OK before parsing JSON
          let data;
          try {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
              const text = await response.text();
              console.error('Non-JSON response:', text);
              throw new Error('Server returned invalid response. Please check the console for details.');
            }
            data = await response.json();
          } catch (e) {
            console.error('Failed to parse response:', e);
            if (e.message.includes('Server returned invalid response')) {
              throw e;
            }
            throw new Error('Invalid response from server. Please try again.');
          }
          console.log('Response data:', data);
          
          if (response.ok && data.status === 'success') {
            showNotification(data.message || 'Appointment booked successfully!', 'success');
            clearSavedFormData(); // Clear saved form data
            closeOverlay(bookingFormOverlay);
            // Refresh list to show newly booked appointment
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            throw new Error(data.message || 'Failed to book appointment');
          }
        } catch (error) {
          console.error('Booking error:', error);
          console.error('Error details:', error);
          showNotification(error.message || 'An error occurred while booking the appointment', 'error');
        }
      });
      } else {
        console.error('Consultation booking form not found!');
    }
    });

    // Close overlays with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.booking-overlay.active').forEach(overlay => {
          closeOverlay(overlay);
        });
      }
    });

    // Set min date for consultation date picker to today
    document.addEventListener('DOMContentLoaded', function() {
      const consultationDateField = document.getElementById('consultationDate');
      if (consultationDateField) {
        consultationDateField.min = new Date().toISOString().split('T')[0];
      }
      
      // NEW INDEPENDENT BUTTON HANDLER
      console.log('Setting up independent appointment button handler');
      const newCreateBtn = document.getElementById('newCreateAppointmentBtn');
      const form = document.getElementById('consultationBookingForm');
      
      // Setup handler for the new independent button
      if (newCreateBtn && form) {
        console.log('Found new button and form, setting up handler');
        
        // Add click handler to new button
        newCreateBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('NEW BUTTON CLICKED! Starting appointment creation...');
          
          // Show loading state
          this.disabled = true;
          this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
          
          try {
            // Get all form data
            const doctorId = document.getElementById('bookingDoctorId').value;
            const consultationType = document.getElementById('bookingConsultationType').value;
            const consultationDate = document.getElementById('consultationDate').value;
            const consultationTime = document.getElementById('consultationTime').value;
            const notes = document.getElementById('consultationNotes').value;
            const reasonForVisit = document.getElementById('reasonForVisit') ? document.getElementById('reasonForVisit').value : '';
            
            console.log('Form data collected:');
            console.log('- Doctor ID:', doctorId);
            console.log('- Type:', consultationType);
            console.log('- Date:', consultationDate);
            console.log('- Time:', consultationTime);
            
            // Validate
            if (!doctorId || !consultationType || !consultationDate || !consultationTime) {
              throw new Error('Please fill in all required fields');
            }
            
            // Get CSRF token
            function getCookie(name) {
              let cookieValue = null;
              if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                  }
                }
              }
              return cookieValue;
            }
            
            const csrfToken = getCookie('csrftoken');
            console.log('CSRF Token:', csrfToken ? 'Found' : 'Not found');
            
            // Create form data
            const formData = new FormData();
            formData.append('doctor_id', doctorId);
            formData.append('consultation_type', consultationType);
            formData.append('consultation_date', consultationDate);
            formData.append('consultation_time', consultationTime);
            formData.append('notes', notes);
            if (reasonForVisit) {
              formData.append('reason_for_visit', reasonForVisit);
            }
            
            // Get CSRF from hidden input if available
            const csrfInput = form.querySelector('[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
              formData.append('csrfmiddlewaretoken', csrfInput.value);
            }
            
            console.log('Sending request to create_appointment...');
            const response = await fetch('{% url "create_appointment" %}', {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrfToken || (csrfInput ? csrfInput.value : '')
              },
              body: formData,
              credentials: 'same-origin'
            });
            
            console.log('Response status:', response.status);
            const responseText = await response.text();
            console.log('Response text:', responseText.substring(0, 200));
            
            let data;
            try {
              data = JSON.parse(responseText);
            } catch (e) {
              console.error('Failed to parse response as JSON:', e);
              throw new Error('Server returned invalid response: ' + responseText.substring(0, 100));
            }
            
            console.log('Response data:', data);
            
            if (response.ok && data.status === 'success') {
              showNotification(data.message || 'Appointment created successfully!', 'success');
              console.log('Appointment created successfully!');
              
              // Close overlay and reload page
              setTimeout(() => {
                closeOverlay(document.getElementById('bookingFormOverlay'));
                window.location.reload();
              }, 2000);
            } else {
              throw new Error(data.message || 'Failed to create appointment');
            }
            
          } catch (error) {
            console.error('ERROR creating appointment:', error);
            showNotification(error.message || 'An error occurred while creating the appointment', 'error');
            
            // Reset button
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check"></i> Submit Appointment';
          }
        });
        
        console.log('Independent button handler set up successfully');
      } else {
        console.log('New button or form not found', { newCreateBtn: !!newCreateBtn, form: !!form });
      }
    });


    // Handle consultation cancellation
    async function cancelConsultation(consultationId) {
      if (!confirm('Are you sure you want to cancel this consultation?')) {
        return;
      }

      try {
        const response = await fetch('{% url "cancel_consultation" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ consultation_id: consultationId })
        });

        const data = await response.json();
        
        if (response.ok) {
          alert(data.message);
          // Reload the page to show updated status
          window.location.reload();
        } else {
          throw new Error(data.message || 'Failed to cancel consultation');
        }
      } catch (error) {
        alert(error.message);
      }
    }
  </script>

  {# Removed duplicate login modal; base.html includes shared auth modals for guests #}

  <!-- Signup Modal -->
  <div id="signupModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
      <div class="bg-gradient-to-br from-red-50 via-white to-blue-50 rounded-2xl p-8 max-w-4xl w-full mx-4 relative shadow-2xl modal-enter max-h-[90vh] overflow-hidden flex flex-col">
          <button id="closeSignup" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl transition-colors duration-200 hover:bg-gray-100 rounded-full w-10 h-10 flex items-center justify-center">
              <i class="fas fa-times"></i>
          </button>
          
          <div class="text-center mb-6 flex-shrink-0">
              <div class="bg-gradient-to-r from-healthcare-red to-red-600 text-white w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                  <i class="fas fa-user-plus text-3xl"></i>
              </div>
              <h2 class="text-3xl font-bold text-healthcare-blue">Join MediSafe+</h2>
              <p class="text-gray-600 mt-2">Create your healthcare account today</p>
          </div>
          
          <!-- Scrollable Form Container -->
          <div class="flex-1 overflow-y-auto pr-2">
              <form id="signupForm" class="space-y-5" enctype="multipart/form-data">
              <div class="grid grid-cols-2 gap-4">
                  <div>
                      <label class="block text-sm font-semibold text-healthcare-blue mb-2">First Name</label>
                      <input type="text" name="first_name" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" placeholder="First name" required>
                  </div>
                  <div>
                      <label class="block text-sm font-semibold text-healthcare-blue mb-2">Last Name</label>
                      <input type="text" name="last_name" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" placeholder="Last name" required>
                  </div>
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Middle Name</label>
                  <input type="text" name="middle_name" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" placeholder="Middle name (optional)">
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Birthday</label>
                  <input type="date" name="birthday" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" required>
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Email Address</label>
                  <input type="email" name="email" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" placeholder="your.email@example.com" required>
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Sex</label>
                  <div class="flex space-x-4">
                      <label class="flex items-center">
                          <input type="radio" name="sex" value="male" class="mr-2">
                          <span>Male</span>
                      </label>
                      <label class="flex items-center">
                          <input type="radio" name="sex" value="female" class="mr-2">
                          <span>Female</span>
                      </label>
                      <label class="flex items-center">
                          <input type="radio" name="sex" value="other" class="mr-2">
                          <span>Other</span>
                      </label>
                  </div>
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Civil Status</label>
                  <select name="civil_status" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" required>
                      <option value="">Select Civil Status</option>
                      <option value="single">Single</option>
                      <option value="married">Married</option>
                      <option value="divorced">Divorced</option>
                      <option value="widowed">Widowed</option>
                      <option value="separated">Separated</option>
                  </select>
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Address</label>
                  <textarea name="address" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" placeholder="Enter your complete address" required></textarea>
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Contact Person</label>
                  <input type="text" name="contact_person" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" placeholder="Emergency contact person" required>
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Relationship to Patient</label>
                  <input type="text" name="relationship_to_patient" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" placeholder="e.g., Spouse, Parent, Sibling" required>
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Contact Number</label>
                  <input type="text" name="contact_number" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" placeholder="Emergency contact number" required>
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Patient Photo</label>
                  <div class="space-y-3">
                      <input type="file" name="photo_url" id="photo_url" accept="image/*" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white">
                      <button type="button" id="cameraBtn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-200 font-semibold">
                          <i class="fas fa-camera mr-2"></i>Take Photo with Camera
                      </button>
                      <div id="cameraPreview" class="hidden">
                          <video id="cameraVideo" class="w-full h-48 bg-gray-100 rounded-xl"></video>
                          <div class="flex space-x-2 mt-2">
                              <button type="button" id="captureBtn" class="flex-1 bg-green-500 text-white py-2 rounded-xl hover:bg-green-600 transition-all duration-200">
                                  <i class="fas fa-camera mr-2"></i>Capture
                              </button>
                              <button type="button" id="cancelCameraBtn" class="flex-1 bg-red-500 text-white py-2 rounded-xl hover:bg-red-600 transition-all duration-200">
                                  <i class="fas fa-times mr-2"></i>Cancel
                              </button>
                          </div>
                      </div>
                      <canvas id="photoCanvas" class="hidden"></canvas>
                  </div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                  <div>
                      <label class="block text-sm font-semibold text-healthcare-blue mb-2">Phone Number</label>
                      <input type="tel" name="phone_number" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" placeholder="+63 912 345 6789" required>
                  </div>
                  <div>
                      <label class="block text-sm font-semibold text-healthcare-blue mb-2">Phone Type</label>
                      <select name="phone_type" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" required>
                          <option value="">Select Type</option>
                          <option value="mobile">Mobile</option>
                          <option value="home">Home</option>
                          <option value="work">Work</option>
                          <option value="other">Other</option>
                      </select>
                  </div>
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Username</label>
                  <input type="text" name="username" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" placeholder="Choose a username" required>
              </div>
              
              <div>
                  <label class="block text-sm font-semibold text-healthcare-blue mb-2">Password</label>
                  <input type="password" name="password" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-healthcare-red focus:border-transparent outline-none transition-all duration-200 bg-white" placeholder="Create a secure password" required>
              </div>
              
              <div class="flex items-start space-x-3">
                  <input type="checkbox" name="data_privacy_consent" id="data_privacy_consent" class="mt-1" required>
                  <label for="data_privacy_consent" class="text-sm text-gray-700">
                      I agree to the <button type="button" id="privacyPolicyBtn" class="text-healthcare-blue hover:underline font-semibold">Data Privacy Policy</button> and consent to the processing of my personal data.
                  </label>
              </div>
              
              </form>
          </div>
          
          <!-- Fixed Submit Button -->
          <div class="flex-shrink-0 mt-6 pt-4 border-t border-gray-200">
              <button type="submit" form="signupForm" class="w-full bg-gradient-to-r from-healthcare-red to-red-600 text-white py-3 rounded-xl hover:from-red-600 hover:to-red-700 transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105">
                  <i class="fas fa-user-plus mr-2"></i>Create Account
              </button>
              
              <div class="text-center mt-4">
                  <div class="text-gray-600 text-sm">
                      Already have an account? 
                      <button type="button" id="switchToLogin" class="text-healthcare-light-blue hover:underline font-semibold">Sign In Here</button>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- Data Privacy Policy Modal -->
  <div id="privacyPolicyModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
      <div class="bg-white rounded-2xl max-w-4xl w-full mx-4 relative shadow-2xl max-h-[90vh] overflow-y-auto modal-enter">
          <button id="closePrivacyPolicy" class="absolute top-6 right-6 text-gray-500 hover:text-gray-700 text-2xl z-10 bg-gray-100 rounded-full w-12 h-12 flex items-center justify-center transition-all duration-200 hover:bg-gray-200">
              <i class="fas fa-times"></i>
          </button>
          
          <div class="p-8">
              <h2 class="text-3xl font-bold text-healthcare-blue mb-6">Data Privacy Policy</h2>
              
              <div class="prose max-w-none">
                  <h3 class="text-xl font-semibold text-gray-800 mb-4">1. Information We Collect</h3>
                  <p class="text-gray-700 mb-4">
                      We collect personal information that you provide directly to us, including but not limited to:
                  </p>
                  <ul class="list-disc list-inside text-gray-700 mb-6 space-y-2">
                      <li>Personal identification information (name, date of birth, gender, civil status)</li>
                      <li>Contact information (address, phone numbers, email)</li>
                      <li>Medical information and health records</li>
                      <li>Emergency contact information</li>
                      <li>Profile photographs</li>
                  </ul>

                  <h3 class="text-xl font-semibold text-gray-800 mb-4">2. How We Use Your Information</h3>
                  <p class="text-gray-700 mb-4">
                      We use your personal information for the following purposes:
                  </p>
                  <ul class="list-disc list-inside text-gray-700 mb-6 space-y-2">
                      <li>To provide healthcare services and medical consultations</li>
                      <li>To maintain accurate medical records</li>
                      <li>To communicate with you about appointments and medical care</li>
                      <li>To contact emergency contacts when necessary</li>
                      <li>To improve our healthcare services</li>
                  </ul>

                  <h3 class="text-xl font-semibold text-gray-800 mb-4">3. Information Sharing</h3>
                  <p class="text-gray-700 mb-4">
                      We do not sell, trade, or otherwise transfer your personal information to third parties without your consent, except:
                  </p>
                  <ul class="list-disc list-inside text-gray-700 mb-6 space-y-2">
                      <li>When required by law or legal process</li>
                      <li>To protect our rights and the safety of our users</li>
                      <li>With your explicit consent</li>
                      <li>In case of medical emergencies</li>
                  </ul>

                  <h3 class="text-xl font-semibold text-gray-800 mb-4">4. Data Security</h3>
                  <p class="text-gray-700 mb-4">
                      We implement appropriate security measures to protect your personal information against unauthorized access, alteration, disclosure, or destruction.
                  </p>

                  <h3 class="text-xl font-semibold text-gray-800 mb-4">5. Your Rights</h3>
                  <p class="text-gray-700 mb-4">
                      You have the right to:
                  </p>
                  <ul class="list-disc list-inside text-gray-700 mb-6 space-y-2">
                      <li>Access your personal information</li>
                      <li>Correct inaccurate information</li>
                      <li>Request deletion of your information</li>
                      <li>Withdraw consent at any time</li>
                      <li>File a complaint with relevant authorities</li>
                  </ul>

                  <h3 class="text-xl font-semibold text-gray-800 mb-4">6. Contact Information</h3>
                  <p class="text-gray-700 mb-4">
                      If you have any questions about this Privacy Policy, please contact us at:
                  </p>
                  <p class="text-gray-700">
                      Email: privacy@medisafe.com<br>
                      Phone: +1 (555) 123-4567<br>
                      Address: 123 Healthcare Ave, Medical District, NY 10001
                  </p>
              </div>
              
              <div class="mt-8 pt-6 border-t border-gray-200">
                  <button id="acceptPrivacyPolicy" class="w-full bg-gradient-to-r from-healthcare-blue to-healthcare-light-blue text-white py-3 rounded-xl hover:from-healthcare-light-blue hover:to-blue-700 transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl">
                      <i class="fas fa-check mr-2"></i>I Understand and Accept
                  </button>
              </div>
          </div>
      </div>
  </div>

  <script>
      // Modal elements
      const loginBtn = document.getElementById('loginBtn');
      const loginModal = document.getElementById('loginModal');
      const signupModal = document.getElementById('signupModal');
      const privacyPolicyModal = document.getElementById('privacyPolicyModal');
      const closeLogin = document.getElementById('closeLogin');
      const closeSignup = document.getElementById('closeSignup');
      const closePrivacyPolicy = document.getElementById('closePrivacyPolicy');
      const switchToSignup = document.getElementById('switchToSignup');
      const switchToLogin = document.getElementById('switchToLogin');
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const privacyPolicyBtn = document.getElementById('privacyPolicyBtn');
      const acceptPrivacyPolicy = document.getElementById('acceptPrivacyPolicy');
      
      // Camera elements
      const cameraBtn = document.getElementById('cameraBtn');
      const cameraPreview = document.getElementById('cameraPreview');
      const cameraVideo = document.getElementById('cameraVideo');
      const captureBtn = document.getElementById('captureBtn');
      const cancelCameraBtn = document.getElementById('cancelCameraBtn');
      const photoCanvas = document.getElementById('photoCanvas');
      const patientPhotoInput = document.getElementById('photo_url');
      
      let stream = null;

      // Show modal with animation
      function showModal(modal) {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          modal.style.opacity = '0';
          modal.style.transition = 'opacity 0.3s ease-in';
          setTimeout(() => {
              modal.style.opacity = '1';
          }, 50);
      }

      // Hide modal with animation
      function hideModal(modal) {
          modal.style.opacity = '0';
          modal.style.transition = 'opacity 0.3s ease-out';
          setTimeout(() => {
              modal.classList.add('hidden');
              modal.classList.remove('flex');
              modal.style.opacity = '1';
          }, 300);
      }

      // Show login modal
      if (loginBtn) {
          loginBtn.addEventListener('click', () => showModal(loginModal));
      }

      // Close modals
      if (closeLogin) {
          closeLogin.addEventListener('click', () => hideModal(loginModal));
      }
      if (closeSignup) {
          closeSignup.addEventListener('click', () => hideModal(signupModal));
      }
      if (closePrivacyPolicy) {
          closePrivacyPolicy.addEventListener('click', () => hideModal(privacyPolicyModal));
      }
      
      // Privacy Policy Modal
      if (privacyPolicyBtn) {
          privacyPolicyBtn.addEventListener('click', () => showModal(privacyPolicyModal));
      }
      if (acceptPrivacyPolicy) {
          acceptPrivacyPolicy.addEventListener('click', () => {
              hideModal(privacyPolicyModal);
              document.getElementById('data_privacy_consent').checked = true;
          });
      }

      // Switch between login and signup
      if (switchToSignup) {
          switchToSignup.addEventListener('click', () => {
              hideModal(loginModal);
              setTimeout(() => showModal(signupModal), 100);
          });
      }

      if (switchToLogin) {
          switchToLogin.addEventListener('click', () => {
              hideModal(signupModal);
              setTimeout(() => showModal(loginModal), 100);
          });
      }

      // Close modals when clicking outside
      [loginModal, signupModal, privacyPolicyModal].forEach(modal => {
          if (modal) {
              modal.addEventListener('click', (e) => {
                  if (e.target === modal) {
                      hideModal(modal);
                  }
              });
          }
      });
      
      // Camera functionality
      if (cameraBtn) {
          cameraBtn.addEventListener('click', async () => {
              try {
                  stream = await navigator.mediaDevices.getUserMedia({ 
                      video: { 
                          facingMode: 'user',
                          width: { ideal: 640 },
                          height: { ideal: 480 }
                      } 
                  });
                  cameraVideo.srcObject = stream;
                  cameraPreview.classList.remove('hidden');
                  cameraBtn.classList.add('hidden');
              } catch (error) {
                  alert('Camera access denied. Please allow camera access to take a photo.');
                  console.error('Camera error:', error);
              }
          });
      }
      
      if (captureBtn) {
          captureBtn.addEventListener('click', () => {
              const canvas = photoCanvas;
              const video = cameraVideo;
              const ctx = canvas.getContext('2d');
              
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              
              // Convert canvas to blob and set as file input
              canvas.toBlob((blob) => {
                  const file = new File([blob], 'photo_url.jpg', { type: 'image/jpeg' });
                  const dataTransfer = new DataTransfer();
                  dataTransfer.items.add(file);
                  patientPhotoInput.files = dataTransfer.files;
              }, 'image/jpeg', 0.8);
              
              // Stop camera
              if (stream) {
                  stream.getTracks().forEach(track => track.stop());
              }
              
              cameraPreview.classList.add('hidden');
              cameraBtn.classList.remove('hidden');
              
              alert('Photo captured successfully!');
          });
      }
      
      if (cancelCameraBtn) {
          cancelCameraBtn.addEventListener('click', () => {
              if (stream) {
                  stream.getTracks().forEach(track => track.stop());
              }
              cameraPreview.classList.add('hidden');
              cameraBtn.classList.remove('hidden');
          });
      }

      // Login form submission
      if (loginForm) {
          loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
              console.log('Login form submitted');
              const username = loginForm.querySelector('input[name="username"]').value;
              const password = loginForm.querySelector('input[name="password"]').value;
              const csrfToken = loginForm.querySelector('input[name="csrfmiddlewaretoken"]').value;
              console.log('Login data:', { username });

          try {
            const response = await fetch('/login/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
              },
              body: JSON.stringify({ username, password }),
              credentials: 'same-origin'
            });

            const data = await response.json();
                  console.log('Login response:', data);
            
                  const errorDiv = document.getElementById('loginError');
            if (response.ok) {
                      errorDiv.classList.add('hidden');
                      
                      // Show welcome message if available
                      if (data.welcome_message) {
                          const welcomeDiv = document.createElement('div');
                          welcomeDiv.style.position = 'fixed';
                          welcomeDiv.style.top = '20px';
                          welcomeDiv.style.right = '20px';
                          welcomeDiv.style.backgroundColor = '#d1fae5';
                          welcomeDiv.style.borderLeft = '4px solid #10b981';
                          welcomeDiv.style.color = '#065f46';
                          welcomeDiv.style.padding = '14px 16px';
                          welcomeDiv.style.borderRadius = '8px';
                          welcomeDiv.style.fontWeight = '600';
                          welcomeDiv.style.fontSize = '14px';
                          welcomeDiv.style.zIndex = '9999';
                          welcomeDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                          welcomeDiv.textContent = data.welcome_message;
                          document.body.appendChild(welcomeDiv);
                          
                          // Auto remove after 4 seconds
                          setTimeout(() => {
                              welcomeDiv.style.opacity = '0';
                              welcomeDiv.style.transition = 'opacity 0.3s ease-out';
                              setTimeout(() => welcomeDiv.remove(), 300);
                          }, 4000);
                      }
                      
                      // Redirect after brief delay to allow welcome message to show
                      setTimeout(() => {
                          window.location.href = data.redirect;
                      }, 500);
            } else {
              errorDiv.textContent = data.message || 'Login failed. Please check your credentials.';
                      errorDiv.classList.remove('hidden');
            }
          } catch (error) {
            console.error('Login error:', error);
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = 'A network error occurred. Please check your connection and try again.';
                  errorDiv.classList.remove('hidden');
                  errorDiv.classList.add('bg-red-50', 'border', 'border-red-100');
          }
        });
      }

      // Handle signup form submission
      if (signupForm) {
          signupForm.addEventListener('submit', async (e) => {
          e.preventDefault();
              const form = e.target;

              // Remove any existing error states
              form.querySelectorAll('input').forEach(input => {
                  input.classList.remove('border-red-500', 'bg-red-50');
              });

          const userData = {
                  first_name: form.querySelector('input[name="first_name"]').value.trim(),
                  middle_name: form.querySelector('input[name="middle_name"]').value.trim(),
                  last_name: form.querySelector('input[name="last_name"]').value.trim(),
                  birthday: form.querySelector('input[name="birthday"]').value,
                  email: form.querySelector('input[name="email"]').value.trim(),
                  sex: form.querySelector('input[name="sex"]:checked')?.value,
                  civil_status: form.querySelector('select[name="civil_status"]').value,
                  address: form.querySelector('textarea[name="address"]').value.trim(),
                  contact_person: form.querySelector('input[name="contact_person"]').value.trim(),
                  relationship_to_patient: form.querySelector('input[name="relationship_to_patient"]').value.trim(),
                  contact_number: form.querySelector('input[name="contact_number"]').value.trim(),
                  phone_number: form.querySelector('input[name="phone_number"]').value.trim(),
                  phone_type: form.querySelector('select[name="phone_type"]').value,
                  username: form.querySelector('input[name="username"]').value.trim(),
                  password: form.querySelector('input[name="password"]').value,
                  data_privacy_consent: form.querySelector('input[name="data_privacy_consent"]').checked,
            role: 'patient'
          };

          try {
                  const result = await HealthcareAPI.register(userData);
                  // The HealthcareAPI.register function will handle all success cases
              } catch (error) {
                  // Show error message
                  const errorMessage = document.createElement('div');
                  errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
                  
                  // Handle specific error cases
                  let errorText = 'Registration failed. Please try again.';
                  if (error.message.includes('Email already exists')) {
                      errorText = 'This email address is already registered. Please use a different email or login to your existing account.';
                      // Highlight the email field
                      const emailInput = form.querySelector('input[name="email"]');
                      emailInput.classList.add('border-red-500', 'bg-red-50');
                      emailInput.focus();
                  } else if (error.message.includes('Username already exists')) {
                      errorText = 'This username is already taken. Please choose a different username.';
                      // Highlight the username field
                      const usernameInput = form.querySelector('input[name="username"]');
                      usernameInput.classList.add('border-red-500', 'bg-red-50');
                      usernameInput.focus();
                  }
                  
                  errorMessage.innerHTML = `
                      <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                      </svg>
                      <span>${errorText}</span>
                  `;
                  document.body.appendChild(errorMessage);
                  
                  // Remove error highlighting when user starts typing
                  const inputs = form.querySelectorAll('input');
                  inputs.forEach(input => {
                      input.addEventListener('input', function() {
                          this.classList.remove('border-red-500', 'bg-red-50');
                      });
                  });

                  // Remove error message after 5 seconds
                  setTimeout(() => {
                      errorMessage.style.opacity = '0';
                      errorMessage.style.transition = 'opacity 0.5s ease-out';
                      setTimeout(() => {
                          document.body.removeChild(errorMessage);
                      }, 500);
                  }, 5000);
              }
          });
      }

      // Close modals with Escape key
      document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
              hideModal(loginModal);
              hideModal(signupModal);
              hideModal(privacyPolicyModal);
          }
      });

      // Tab switching functionality for All Appointments
      function filterAllAppointments() {
          const searchTerm = (document.getElementById('allApptSearch')?.value || '').toLowerCase();
          const dateFrom = document.getElementById('allApptDateFrom')?.value || '';
          const dateTo = document.getElementById('allApptDateTo')?.value || '';
          const statusFilter = document.getElementById('allApptStatusFilter')?.value || '';
          const approvalFilter = document.getElementById('allApptApprovalFilter')?.value || '';
          const typeFilter = document.getElementById('allApptTypeFilter')?.value || '';
          const sortOrder = document.getElementById('allApptSortOrder')?.value || 'date-desc';
          
          const rows = Array.from(document.querySelectorAll('#allAppointmentsTableBody .appointment-row'));
          let completedCount = 0;
          let upcomingCount = 0;
          let cancelledCount = 0;
          const today = new Date().toISOString().split('T')[0];
          
          rows.forEach(row => {
              const rowDate = row.getAttribute('data-date') || '';
              const rowStatus = (row.getAttribute('data-status') || '').toLowerCase();
              const rowApprovalStatus = (row.getAttribute('data-approval-status') || '').toLowerCase();
              const rowType = row.getAttribute('data-type') || '';
              const doctor = (row.getAttribute('data-doctor') || '').toLowerCase();
              const specialization = (row.getAttribute('data-specialization') || '').toLowerCase();
              const notes = (row.getAttribute('data-notes') || '').toLowerCase();
              
              // Check if appointment is in the past
              const isPast = rowDate < today && rowStatus.toLowerCase() !== 'completed' && rowStatus.toLowerCase() !== 'cancelled';
              
              let show = true;
              
              // Search filter
              if (searchTerm) {
                  const matches = doctor.includes(searchTerm) || 
                                 specialization.includes(searchTerm) ||
                                 rowType.toLowerCase().includes(searchTerm) ||
                                 notes.includes(searchTerm);
                  if (!matches) show = false;
              }
              
              // Date range filter
              if (rowDate) {
                  if (dateFrom && rowDate < dateFrom) show = false;
                  if (dateTo && rowDate > dateTo) show = false;
              } else if (dateFrom || dateTo) {
                  show = false;
              }
              
              // Status filter (including Past)
              if (statusFilter) {
                  if (statusFilter === 'Past') {
                      if (!isPast) show = false;
                  } else if (rowStatus !== statusFilter.toLowerCase()) {
                      show = false;
                  }
              }
              
              // Approval status filter
              if (approvalFilter && rowApprovalStatus !== approvalFilter.toLowerCase()) {
                  show = false;
              }
              
              // Type filter
              if (typeFilter && rowType !== typeFilter) {
                  show = false;
              }
              
              row.style.display = show ? '' : 'none';
              
              // Update statistics
              if (show) {
                  if (rowStatus === 'completed') completedCount++;
                  else if (rowStatus === 'cancelled') cancelledCount++;
                  else if (rowDate >= today) upcomingCount++;
              }
          });
          
          // Update statistics
          document.getElementById('completedAppointmentsCount').textContent = completedCount;
          document.getElementById('upcomingAppointmentsCount').textContent = upcomingCount;
          document.getElementById('cancelledAppointmentsCount').textContent = cancelledCount;
          
          // Sort visible rows
          const tbody = document.querySelector('#allAppointmentsTableBody');
          if (tbody) {
              const visibleRows = rows.filter(row => row.style.display !== 'none');
              visibleRows.sort((a, b) => {
                  const dateA = a.getAttribute('data-date') || '';
                  const dateB = b.getAttribute('data-date') || '';
                  const doctorA = (a.getAttribute('data-doctor') || '').toLowerCase();
                  const doctorB = (b.getAttribute('data-doctor') || '').toLowerCase();
                  const statusA = (a.getAttribute('data-status') || '').toLowerCase();
                  const statusB = (b.getAttribute('data-status') || '').toLowerCase();
                  
                  switch (sortOrder) {
                      case 'date-asc':
                          return dateA.localeCompare(dateB);
                      case 'date-desc':
                          return dateB.localeCompare(dateA);
                      case 'doctor-asc':
                          return doctorA.localeCompare(doctorB);
                      case 'status-asc':
                          return statusA.localeCompare(statusB);
                      default:
                          return 0;
                  }
              });
              visibleRows.forEach(row => tbody.appendChild(row));
          }
      }

      // Alias for new filter call
      function applyAllApptFilters() {
          filterAllAppointments();
      }
      
      function bookAppointmentWithDoctor() {
          const selectElement = document.getElementById('quickSelectDoctor');
          if (!selectElement) return;
          const doctorId = selectElement.value;
          
          if (!doctorId) {
              showNotification('Please select a doctor from the dropdown', 'error');
              return;
          }
          
          triggerBookFlowForDoctor(doctorId);
      }

      function bookAppointmentFromHero() {
          const selectElement = document.getElementById('heroQuickSelectDoctor');
          if (!selectElement) return;
          const doctorId = selectElement.value;
          if (!doctorId) {
              showNotification('Choose a doctor to continue', 'error');
              return;
          }
          triggerBookFlowForDoctor(doctorId);
      }
      
      function clearAllApptFilters() {
          document.getElementById('allApptSearch').value = '';
          document.getElementById('allApptDateFrom').value = '';
          document.getElementById('allApptDateTo').value = '';
          document.getElementById('allApptStatusFilter').value = '';
          document.getElementById('allApptApprovalFilter').value = '';
          document.getElementById('allApptTypeFilter').value = '';
          document.getElementById('allApptSortOrder').value = 'date-desc';
          filterAllAppointments();
      }
      
      function exportAllAppointments() {
          const rows = Array.from(document.querySelectorAll('#allAppointmentsTableBody .appointment-row'));
          const visibleRows = rows.filter(row => row.style.display !== 'none');
          
          if (visibleRows.length === 0) {
              alert('No appointments to export');
              return;
          }
          
          let csv = 'Doctor,Specialization,Type,Date,Time,Approval Status,Status\n';
          visibleRows.forEach(row => {
              const cells = row.querySelectorAll('td');
              const doctor = cells[0]?.textContent.trim() || '';
              const specialization = cells[1]?.textContent.trim() || '';
              const type = cells[2]?.textContent.trim() || '';
              const date = cells[3]?.textContent.trim() || '';
              const time = cells[4]?.textContent.trim() || '';
              const approvalStatus = cells[5]?.textContent.trim() || '';
              const status = cells[6]?.textContent.trim() || '';
              csv += `"${doctor}","${specialization}","${type}","${date}","${time}","${approvalStatus}","${status}"\n`;
          });
          
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `appointments_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
      }
      
        async function viewAppointmentDetails(consultationId) {
          // Immediately show a lightweight modal from table row data so user gets instant feedback
          const row = document.querySelector(`tr[data-consultation-id="${consultationId}"]`);
          if (row) {
            const cells = row.querySelectorAll('td');
            const basicData = {
              doctor: cells[0]?.textContent.trim() || '',
              specialization: cells[1]?.textContent.trim() || '',
              type: cells[2]?.textContent.trim() || '',
              date: cells[3]?.textContent.trim() || '',
              time: cells[4]?.textContent.trim() || '',
              approval_status: cells[5]?.textContent.trim() || '',
              status: cells[6]?.textContent.trim() || '',
              notes: row.getAttribute('data-notes') || ''
            };
            showAppointmentDetailsModal(basicData);
          }

          try {
            const response = await fetch(`/consultations/api/get-consultation-details/${consultationId}/`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json'
              }
            });

            if (!response.ok) {
              throw new Error('Failed to fetch appointment details');
            }

            const data = await response.json();
            // Replace modal contents with full details
            showAppointmentDetailsModal(data);
          } catch (error) {
            console.error('Error fetching appointment details:', error);
            // If no row-based modal was shown, show a simple alert
            if (!row) {
              alert('Appointment details not available at this time.');
            }
          }
        }
      
      function showAppointmentDetailsModal(data) {
          // Create modal if it doesn't exist
          let modal = document.getElementById('appointmentDetailsModal');
          if (!modal) {
              modal = document.createElement('div');
              modal.id = 'appointmentDetailsModal';
              modal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
              modal.style.display = 'none';
              modal.innerHTML = `
                  <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" style="position: relative;">
                      <button onclick="closeAppointmentDetailsModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">
                          <i class="fas fa-times"></i>
                      </button>
                      <h2 class="text-2xl font-bold text-healthcare-blue mb-6">Appointment Details</h2>
                      <div id="appointmentDetailsContent"></div>
                      <div class="mt-6 flex justify-end">
                          <button onclick="closeAppointmentDetailsModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                              Close
                          </button>
                      </div>
                  </div>
              `;
              document.body.appendChild(modal);
          }
          
          // Populate content
          const content = document.getElementById('appointmentDetailsContent');
          content.innerHTML = `
              <div class="space-y-4">
                  <div class="grid grid-cols-2 gap-4">
                      <div>
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Doctor</label>
                          <p class="text-gray-900">${data.doctor || 'N/A'}</p>
                      </div>
                      <div>
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Specialization</label>
                          <p class="text-gray-900">${data.specialization || 'N/A'}</p>
                      </div>
                      <div>
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Type</label>
                          <p class="text-gray-900">${data.type || data.consultation_type || 'N/A'}</p>
                      </div>
                      <div>
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Date</label>
                          <p class="text-gray-900">${data.date || data.consultation_date || 'N/A'}</p>
                      </div>
                      <div>
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Time</label>
                          <p class="text-gray-900">${data.time || data.consultation_time || 'N/A'}</p>
                      </div>
                      <div>
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Status</label>
                          <p class="text-gray-900">${data.status || 'N/A'}</p>
                      </div>
                      <div>
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Approval Status</label>
                          <p class="text-gray-900">${data.approval_status || data.approvalStatus || 'N/A'}</p>
                      </div>
                      ${data.reason_for_visit ? `
                      <div class="col-span-2">
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Reason for Visit</label>
                          <p class="text-gray-900">${data.reason_for_visit}</p>
                      </div>
                      ` : ''}
                      ${data.notes || data.notes ? `
                      <div class="col-span-2">
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Notes</label>
                          <p class="text-gray-900">${data.notes || 'N/A'}</p>
                      </div>
                      ` : ''}
                      ${data.vital_signs ? `
                      <div class="col-span-2">
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Vital Signs</label>
                          <pre class="text-gray-900 bg-gray-50 p-3 rounded">${JSON.stringify(data.vital_signs, null, 2)}</pre>
                      </div>
                      ` : ''}
                      ${data.diagnosis ? `
                      <div class="col-span-2">
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Diagnosis</label>
                          <p class="text-gray-900">${data.diagnosis}</p>
                      </div>
                      ` : ''}
                      ${data.treatment_plan ? `
                      <div class="col-span-2">
                          <label class="block text-sm font-semibold text-gray-600 mb-1">Treatment Plan</label>
                          <p class="text-gray-900">${data.treatment_plan}</p>
                      </div>
                      ` : ''}
                  </div>
              </div>
          `;
          
          // Show modal
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
      }
      
      function closeAppointmentDetailsModal() {
          const modal = document.getElementById('appointmentDetailsModal');
          if (modal) {
              modal.style.display = 'none';
              document.body.style.overflow = '';
          }
      }
      
      function viewPrescription(consultationId) {
          // Redirect to prescriptions page with consultation ID to highlight the prescription
          window.location.href = `{% url 'prescriptions' %}?consultation_id=${consultationId}`;
      }
      
      // Initialize filters on page load
      document.addEventListener('DOMContentLoaded', function() {
          // Add event listeners for filters
          const filterInputs = ['allApptSearch', 'allApptDateFrom', 'allApptDateTo', 'allApptStatusFilter', 'allApptApprovalFilter', 'allApptTypeFilter', 'allApptSortOrder'];
          filterInputs.forEach(id => {
              const element = document.getElementById(id);
              if (element) {
                  element.addEventListener('input', filterAllAppointments);
                  element.addEventListener('change', filterAllAppointments);
              }
          });
          
          // Initial filter to update statistics
          filterAllAppointments();
      });

          function cancelAppointment(consultationId, btn) {
            if (!confirm('Are you sure you want to cancel this appointment?')) return;

          // Use API URL defined in consultations urls: /api/cancel-consultation/
          // Send JSON body with consultation_id and include CSRF token
          function getCsrfToken() {
            const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (el) return el.value;
            // fallback to cookie
            const match = document.cookie.match(new RegExp('(^| )csrftoken=([^;]+)'));
            return match ? match[2] : '';
          }

            const csrfToken = getCsrfToken();

            // show inline spinner on the button if provided
            try { if (btn) showButtonSpinner(btn, true); } catch(_) {}

            fetch('/api/cancel-consultation/', {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ consultation_id: consultationId }),
            credentials: 'same-origin'
          })
          .then(res => res.json())
          .then(data => {
            if (data && data.status === 'success') {
              // Friendly UI update: remove or mark appointment as cancelled without full reload
              const row = document.querySelector('[data-consultation-id="' + consultationId + '"]');
              if (row) {
                // update status badge if present
                const statusBadge = row.querySelector('.status-badge.status-');
                // simplest: reload to reflect accurate server state
                location.reload();
              } else {
                location.reload();
              }
              } else {
                alert('Error cancelling appointment: ' + (data && (data.message || data.error) ? (data.message || data.error) : 'Unknown error'));
              }
              try { if (btn) hideButtonSpinner(btn); } catch(_) {}
          })
          .catch(err => {
            console.error('Error cancelling appointment:', err);
            alert('Error cancelling appointment');
              try { if (btn) hideButtonSpinner(btn); } catch(_) {}
          });
        }

        // Attach listeners to card-style cancel buttons (class cancel-btn) to call cancelAppointment
          document.addEventListener('DOMContentLoaded', function(){
            document.querySelectorAll('.cancel-btn').forEach(function(btn){
              btn.addEventListener('click', function(e){
                var id = this.getAttribute('data-consultation-id');
                if (id) cancelAppointment(id, this);
              });
            });
          });

      // Tab content switcher
      const tabButtons = document.querySelectorAll('[data-tab]');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(btn => {
          btn.addEventListener('click', () => {
              const tabName = btn.getAttribute('data-tab');
              
              // Hide all tabs
              tabContents.forEach(content => content.classList.remove('active'));
              tabButtons.forEach(b => b.classList.remove('active'));
              
              // Show selected tab
              const selectedTab = document.getElementById(tabName);
              if (selectedTab) {
                  selectedTab.classList.add('active');
                  btn.classList.add('active');
              }
          });
      });
  </script>
  
  <!-- Load HealthcareAPI from app.js -->
  <script src="{% static 'app.js' %}"></script>
{% endblock %}