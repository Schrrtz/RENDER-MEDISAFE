<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doctor Portal</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  {% load static %}
  <link rel="stylesheet" href="{% static 'doctors.css' %}">
  <script src="{% static 'js/doctors.js' %}"></script>
</head>
<body>
  <div id="pageLoader" style="display:none;position:fixed;inset:0;background:rgba(255,255,255,.85);z-index:2000;align-items:center;justify-content:center">
    <div style="display:flex;flex-direction:column;align-items:center;gap:14px">
      <div style="width:54px;height:54px;border:6px solid #e5e7eb;border-top-color:#3b82f6;border-radius:999px;animation:spin 1s linear infinite"></div>
      <div style="font-weight:800;color:#213A57">Loading…</div>
    </div>
  </div>
  <style>@keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }</style>
  <div class="layout">
    <header class="top">
      <div class="brand" style="display:flex;align-items:center;gap:12px">
        <img src="/media/logo/Medisafe%20Logo.jpg" alt="MediSafe" style="height:44px;width:auto;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)" />
        <div style="display:flex;flex-direction:column;line-height:1">
          <div style="font-weight:800;font-size:18px">MediSafe</div>
          <div style="font-size:12px;color:#6b7280">Doctor Portal</div>
        </div>
      </div>
      <button class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
      <nav class="nav">
        <a href="#dashboard" onclick="show('dashboard');toggleMenu();return false;" class="active"><i class="fas fa-grid-2"></i> Dashboard</a>
        <a href="#appointments" onclick="show('appointments');toggleMenu();return false;"><i class="fas fa-calendar-alt"></i> Appointments</a>
        <a href="#patients" onclick="show('patients');toggleMenu();return false;"><i class="fas fa-user-friends"></i> My Patients</a>
        <a href="#lab" onclick="show('lab');toggleMenu();return false;"><i class="fas fa-vial"></i> Laboratory</a>
        <a href="#rx" onclick="show('rx');toggleMenu();return false;"><i class="fas fa-prescription"></i> Prescriptions</a>
      </nav>
      <div class="hdr-actions">
        <div style="display:flex;align-items:center;gap:12px">
          <button onclick="showKeyboardShortcuts()" class="pill" style="border:none;background:transparent;position:relative;padding:8px;cursor:pointer;color:#374151" title="Show keyboard shortcuts (or press ?)">
            <i class="fas fa-keyboard" style="font-size:16px"></i>
          </button>
          <div style="position:relative">
            <button id="notifBtn" onclick="toggleNotifWindow()" class="pill" style="border:none;background:transparent;position:relative;padding:8px;cursor:pointer">
              <i class="fas fa-bell" style="font-size:16px;color:#374151"></i>
              <span id="notifBadge" style="display:inline-block;min-width:18px;padding:2px 6px;border-radius:999px;background:#ef4444;color:#fff;font-size:12px;position:absolute;top:-6px;right:-6px;line-height:1;text-align:center;{% if notif_unread_count == 0 %}display:none;{% endif %}">{{ notif_unread_count }}</span>
            </button>
            <div id="notifDropdown" style="display:none;position:absolute;right:0;top:40px;background:#fff;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.08);width:340px;border-radius:8px;z-index:1200;">
              <div style="padding:10px 12px;border-bottom:1px solid #f3f4f6;font-weight:800">Notifications</div>
              <div id="notifItems" style="max-height:300px;overflow:auto">
                {% for n in notifications %}
                <div class="notif-item" data-notif-id="{{ n.notification_id }}" style="padding:10px 12px;border-bottom:1px solid #f8fafc;display:flex;justify-content:space-between;align-items:flex-start">
                  <div style="flex:1">
                    <div style="font-weight:700">{{ n.title }}</div>
                    <div style="font-size:13px;color:#374151;white-space:pre-wrap">{{ n.message|truncatechars:140 }}</div>
                    <div style="font-size:12px;color:#6b7280;margin-top:6px">{{ n.created_at|date:"M d, Y H:i" }}</div>
                  </div>
                  <div style="margin-left:10px;flex-shrink:0;text-align:right">
                    {% if not n.is_read %}
                    <button onclick="markDoctorNotifRead('{{ n.notification_id }}', this)" class="pill" style="background:#f0f9ff;color:#0369a1;border-radius:6px;padding:6px 8px;border:none">Mark</button>
                    {% else %}
                    <span class="pill" style="background:#eef2ff;color:#0369a1;border-radius:6px;padding:6px 8px;display:inline-block">Read</span>
                    {% endif %}
                  </div>
                </div>
                {% empty %}
                <div style="padding:12px;color:#64748b">No notifications.</div>
                {% endfor %}
              </div>
              <div style="padding:8px;border-top:1px solid #f3f4f6;text-align:right">
                <a href="{% url 'alertnotification' %}" style="font-size:13px;color:#0369a1;text-decoration:none">View all</a>
              </div>
            </div>
          </div>

          <button class="user-btn" id="userMenuBtn" onclick="toggleProfileMenu()">
          <div class="avatar" id="hdrAvatar" style="width:28px;height:28px;font-size:12px">
            {% if user_profile.photo_url %}
              <img src="{{ user_profile.photo_url }}" alt="Profile Photo" style="width:100%;height:100%;object-fit:cover;border-radius:999px">
            {% else %}
              {{ user_profile.first_name|default:user.username|slice:":1" }}{{ user_profile.last_name|default:""|slice:":1" }}
            {% endif %}
          </div>
          <div style="text-align:left">
            <div style="font-weight:900;line-height:1;color:var(--brand)">Dr. {{ user_profile.first_name|default:user.username }}{% if user_profile.last_name %} {{ user_profile.last_name }}{% endif %}</div>
            <div style="font-size:11px;color:#6b7280;line-height:1">{{ doctor.specialization|default:"" }}</div>
          </div>
          <i class="fas fa-chevron-down caret" id="caretIcon" style="font-size:12px;color:#6b7280"></i>
        </button>
        <div class="dropdown" id="profileDropdown">
          <a href="#" class="dd-item" onclick="openSystemSettings(event);return false;"><i class="fas fa-cog"></i><span>Settings</span></a>
          <a href="#" class="dd-item" onclick="openProfileSettings(event);return false;"><i class="fas fa-gear"></i><span>Profile Settings</span></a>
          <a href="#" class="dd-item" onclick="if(typeof closeProfileDropdown === 'function') closeProfileDropdown(); show('dashboard'); return false;"><i class="fas fa-bell"></i><span>Notifications</span></a>
          <a href="{% url 'logout' %}" class="dd-item logout"><i class="fas fa-right-from-bracket"></i><span>Logout</span></a>
        </div>
      </div>
    </header>
    <section>
      <main>
        <div id="dashboard" data-tab style="margin-bottom:0;padding-bottom:0">
          <!-- Doctor Statistical Dashboard Cards - Top Section -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#dbeafe;padding:12px;border-radius:12px">
                    <i class="fas fa-calendar-check" style="color:#3b82f6;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Total Appointments</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ appointments_count }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">All scheduled appointments</div>
            </div>
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#fef3c7;padding:12px;border-radius:12px">
                    <i class="fas fa-calendar-day" style="color:#f59e0b;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Today's Schedule</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ today_appointments|length }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Appointments today</div>
            </div>
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#d1fae5;padding:12px;border-radius:12px">
                    <i class="fas fa-user-injured" style="color:#10b981;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Active Patients</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ patients|length }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Total registered patients</div>
            </div>
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#dcfce7;padding:12px;border-radius:12px">
                    <i class="fas fa-prescription" style="color:#10b981;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Recent Prescriptions</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ prescriptions|length }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Total prescriptions issued</div>
            </div>
          </div>
          <!-- Quick Actions Section -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:24px">
            <button onclick="refreshDashboard()" class="pill dark" style="background:#3b82f6;color:#fff;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button onclick="exportDashboardData()" class="pill dark" style="background:#10B981;color:#fff;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px">
              <i class="fas fa-download"></i> Export Data
            </button>
            <button onclick="show('appointments');toggleMenu()" class="pill dark" style="background:#f59e0b;color:#fff;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px">
              <i class="fas fa-calendar-alt"></i> Appointments
            </button>
            <button onclick="show('rx');toggleMenu()" class="pill dark" style="background:#ef4444;color:#fff;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px">
              <i class="fas fa-prescription"></i> Prescriptions
            </button>
          </div>
          <div class="dashboard-grid" style="grid-template-columns:1fr 2.5fr;gap:16px;grid-auto-flow:dense">
            <div class="dashboard-card" style="grid-column:1;grid-row:1;">
              <div class="dashboard-card-header"><i class="fas fa-bell"></i> Notifications <span style="float:right;font-size:12px;color:#6b7280">{{ notifications|length }}</span></div>
              <div class="dashboard-card-content">
                <div style="max-height:450px;overflow-y:auto">
                  {% if notifications and notifications|length > 0 %}
                    <ul style="margin:0;padding:0;list-style:none">
                      {% for n in notifications %}
                      <li data-notif-id="{{ n.notification_id }}" style="padding:10px;border-bottom:1px solid #eef2ff;display:flex;justify-content:space-between;align-items:flex-start">
                        <div style="flex:1">
                          <div style="font-weight:700;color:#111">{{ n.title }}</div>
                          <div style="font-size:13px;color:#374151;white-space:pre-wrap">{{ n.message|truncatechars:120 }}</div>
                          <div style="font-size:12px;color:#6b7280;margin-top:6px">{{ n.created_at|date:"M d, Y H:i" }}</div>
                        </div>
                        <div style="margin-left:12px;text-align:right">
                          {% if not n.is_read %}
                          <button onclick="markDoctorNotifRead({{ n.notification_id }}, this)" class="pill" style="background:#f0f9ff;color:#0369a1;border-radius:6px;padding:6px 8px;border:none;cursor:pointer;font-size:11px">Mark read</button>
                          {% else %}
                          <span class="pill" style="background:#eef2ff;color:#0369a1;border-radius:6px;padding:6px 8px;display:inline-block;font-size:11px">Read</span>
                          {% endif %}
                        </div>
                      </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <div style="color:#64748b;text-align:center;padding:20px">No notifications.</div>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="dashboard-card" style="grid-column:2;grid-row:1;border:none;padding:0;background:transparent;box-shadow:none;display:flex;flex-direction:column">
              <div class="dashboard-card-header"><i class="fas fa-calendar-alt"></i> Latest Appointments <span style="float:right;font-size:12px;color:#6b7280">{{ appointments_count }}</span> <button onclick="show('appointments');toggleMenu()" class="pill dark" style="float:right;margin-left:8px;background:#3b82f6;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:11px;cursor:pointer;margin-right:8px">View All</button></div>
              <div style="padding:10px 14px;border-top:1px solid #e5e7eb;background:#f8fafc">
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:12px">
                  <input id="dashApptSearch" type="text" placeholder="Filter..." style="padding:6px 8px;border-radius:6px;border:1px solid #d1d5db;font-size:11px;min-width:140px" onkeyup="filterDashboardAppointments()" />
                  <select id="dashApptTypeFilter" onchange="filterDashboardAppointments()" style="padding:6px;border-radius:6px;border:1px solid #d1d5db;font-size:11px">
                    <option value="all">All Types</option>
                    <option value="Consultation">Consultation</option>
                    <option value="Follow-up">Follow-up</option>
                    <option value="Telemedicine">Telemedicine</option>
                  </select>
                  <select id="dashApptStatusFilter" onchange="filterDashboardAppointments()" style="padding:6px;border-radius:6px;border:1px solid #d1d5db;font-size:11px">
                    <option value="all">All Status</option>
                    <option value="Approved">Approved</option>
                    <option value="Pending">Pending</option>
                  </select>
                  <button class="pill" onclick="resetDashboardApptFilters()" style="font-size:11px;padding:6px 10px">Reset</button>
                </div>
              </div>
              <div class="dashboard-card-content" style="flex:1;overflow-y:auto">
                <div style="max-height:260px;overflow-y:auto;">
                  <ul style="margin:0;padding:0;list-style:none">
                    {% for appt in appointments|slice:":15" %}
                    <li class="dash-appt-item" data-type="{{ appt.consultation_type }}" data-status="{{ appt.approval_status }}" style="margin-bottom:22px;padding-bottom:14px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:18px">
                      <b style="min-width:160px;display:inline-block">{{ appt.patient.userprofile.first_name|default:appt.patient.username }}{% if appt.patient.userprofile.last_name %} {{ appt.patient.userprofile.last_name }}{% endif %}</b>
                      <span style="color:#111;min-width:100px">{{ appt.consultation_date }}</span>
                      <span style="color:#dc2626;min-width:80px">{{ appt.consultation_time }}</span>
                      <span style="background:#dc2626;color:#fff;border-radius:8px;padding:2px 10px;font-size:12px;margin-left:8px">{{ appt.approval_status }}</span>
                      <span class="pill" style="margin-left:8px;font-size:12px">{{ appt.consultation_type }}</span>
                      <button onclick="startAppointment({{ appt.consultation_id }})" class="pill dark" style="margin-left:8px;background:#10B981;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;">
                        <i class="fas fa-video"></i> Start
                      </button>
                    </li>
                    {% empty %}
                    <li style="color:#64748b">No recent appointments.</li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
              <!-- Nested: Appointments Today and Last Prescriptions underneath -->
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;border:none;padding:0;background:transparent;box-shadow:none;margin-top:0;align-items:stretch">
                <!-- Appointments Today - Left -->
                <div class="dashboard-card" style="border-right:1px solid #e5e7eb;border-top-right-radius:0;border-bottom-right-radius:0;margin:0;border-top:none;border-top-left-radius:0;height:100%;min-height:350px;max-height:450px;display:flex;flex-direction:column">
                  <div class="dashboard-card-header"><i class="fas fa-calendar-day"></i> Appointments Today <span style="float:right;font-size:12px;color:#6b7280">{{ today_appointments|length }} scheduled</span></div>
                  <div class="dashboard-card-content" style="flex:1;overflow-y:auto">
                    <div style="max-height:350px;overflow-y:auto;">
                      {% if today_appointments and today_appointments|length > 0 %}
                      <ul style="margin:0;padding:0;list-style:none">
                        {% for tappt in today_appointments %}
                        <li class="appt-item" data-appt-date="{{ tappt.consultation_date }}" style="margin-bottom:12px;padding:10px;border:1px solid #eef2f7;border-radius:10px;display:flex;align-items:center;justify-content:space-between;gap:12px;transition:box-shadow 0.3s" onmouseover="this.style.boxShadow='0 4px 12px rgba(51,65,85,0.1)'" onmouseout="this.style.boxShadow=''">
                          <div style="display:flex;gap:12px;align-items:center;flex:1">
                            <div class="dot" style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800">{{ tappt.patient.userprofile.first_name|default:tappt.patient.username|slice:":1"|upper }}</div>
                            <div>
                              <div style="font-weight:800;font-size:14px">{{ tappt.patient.userprofile.first_name|default:tappt.patient.username }}{% if tappt.patient.userprofile.last_name %} {{ tappt.patient.userprofile.last_name }}{% endif %}</div>
                              <div style="font-size:12px;color:#64748b">{{ tappt.consultation_time }} · {{ tappt.consultation_type }}</div>
                            </div>
                          </div>
                          <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button onclick="startAppointment({{ tappt.consultation_id }})" class="pill dark" style="background:#10B981;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap">
                              <i class="fas fa-video"></i> Start
                            </button>
                            <button class="pill" onclick="openApptDetails({{ tappt.consultation_id }})" style="font-size:12px;padding:6px 10px;white-space:nowrap">Details</button>
                          </div>
                        </li>
                        {% endfor %}
                      </ul>
                      {% else %}
                        <div style="color:#64748b;text-align:center;padding:20px">
                          <i class="fas fa-calendar-check" style="font-size:32px;opacity:0.4;margin-bottom:10px;display:block"></i>
                          <div>No appointments for today.</div>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <!-- Last Prescriptions - Right -->
                <div class="dashboard-card" style="border-top-left-radius:0;border-bottom-left-radius:0;margin:0;border-top:none;height:fit-content;max-height:450px;display:flex;flex-direction:column">
                  <div class="dashboard-card-header"><i class="fas fa-prescription"></i> Last Prescriptions <span style="float:right;font-size:12px;color:#6b7280">{{ prescriptions|length }} total</span></div>
                  <div style="padding:10px 14px;border-top:1px solid #e5e7eb;background:#f8fafc">
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:12px">
                      <input id="rxDashSearch" type="text" placeholder="Search..." style="flex:1;min-width:120px;padding:6px 8px;border-radius:6px;border:1px solid #d1d5db;font-size:11px" onkeyup="filterDashboardPrescriptions()" />
                      <button class="pill" onclick="resetDashboardRxFilters()" style="font-size:11px;padding:6px 10px">Reset</button>
                      <button class="pill dark" onclick="exportDashboardRxCSV()" style="font-size:11px;padding:6px 10px;background:#10B981;color:#fff;border:none;cursor:pointer"><i class="fas fa-download"></i></button>
                    </div>
                  </div>
                  <div class="dashboard-card-content" style="flex:1;overflow-y:auto;min-height:350px;max-height:350px;">
                    <div id="prescriptionsList" style="max-height:350px;overflow-y:auto">
                      {% if prescriptions and prescriptions|length > 0 %}
                        <ul style="margin:0;padding:0;list-style:none">
                          {% for rx in prescriptions %}
                          <li class="rx-item" data-created-at="{{ rx.created_at|date:'Y-m-d' }}" data-patient="{{ rx.live_appointment.appointment.patient.get_full_name|lower }}" style="padding:12px;border-bottom:1px solid #eef2f7;display:flex;align-items:center;justify-content:space-between;gap:12px;transition:background-color 0.2s" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor=''">
                            <div>
                              <div style="font-weight:800;font-size:13px">Rx #{{ rx.prescription_number }} · {{ rx.live_appointment.appointment.patient.get_full_name }}</div>
                              <div style="font-size:12px;color:#64748b">Created: {{ rx.created_at|date:'M d, Y' }} · Status: <span style="color:#10B981;font-weight:600">{{ rx.status|upper }}</span></div>
                            </div>
                            <div style="display:flex;gap:8px">
                              <button class="pill" onclick="viewPrescriptionDetails('{{ rx.prescription_id }}')" style="font-size:12px;padding:6px 10px;white-space:nowrap">View</button>
                            </div>
                          </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <div style="color:#64748b;text-align:center;padding:20px">
                          <i class="fas fa-prescription" style="font-size:32px;opacity:0.4;margin-bottom:10px;display:block"></i>
                          <div>No prescriptions found.</div>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <!-- Remove extra space below dashboard cards -->
        <style>
          /* Remove margin-bottom from dashboard card container */
          .dashboard-card-content { margin-bottom: 0 !important; }
          /* Remove padding/margin from parent if present */
          .dashboard-card { margin-bottom: 0 !important; }
        </style>
        </div>
        <div id="appointments" data-tab style="display:none">
          <h1 class="page-title">Appointments Management</h1>
          <!-- Statistical Cards -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#dbeafe;padding:12px;border-radius:12px">
                    <i class="fas fa-calendar-check" style="color:#3b82f6;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Total Appointments</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ appointments_count }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">All scheduled appointments</div>
            </div>
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#fef3c7;padding:12px;border-radius:12px">
                    <i class="fas fa-clock" style="color:#f59e0b;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Today's Appointments</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ today_appointments|length }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Scheduled for today</div>
            </div>
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#d1fae5;padding:12px;border-radius:12px">
                    <i class="fas fa-check-circle" style="color:#10b981;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Approved</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0" id="apptApprovedCount">-</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Approved appointments</div>
            </div>
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#fee2e2;padding:12px;border-radius:12px">
                    <i class="fas fa-hourglass-half" style="color:#ef4444;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Pending</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0" id="apptPendingCount">-</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Pending approval</div>
            </div>
          </div>
          <div class="toolbar">
            <div class="seg">
              <button class="active" id="listBtn" onclick="switchApptView('list')">List View</button>
              <button id="calBtn" onclick="switchApptView('cal')">Calendar View</button>
            </div>
          </div>
          <!-- Professional Filters Panel matching mod_consultations -->
          <div class="card" style="margin-bottom:18px;background:#f8fafc;border:1px solid #e5e7eb">
            <div class="body">
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px">
                <div>
                  <label style="font-size:13px;font-weight:700;color:#374151;margin-bottom:6px;display:block">Search Patient</label>
                  <input id="apptPageSearch" type="text" placeholder="Name or ID..." style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;width:100%;font-size:13px" onkeyup="filterApptPageAdvanced()" />
                </div>
                <div>
                  <label style="font-size:13px;font-weight:700;color:#374151;margin-bottom:6px;display:block">Consultation Type</label>
                  <select id="apptPageType" onchange="filterApptPageAdvanced()" style="padding:8px;border-radius:8px;border:1px solid #e5e7eb;width:100%;font-size:13px">
                    <option value="all">All Types</option>
                    <option value="Consultation">Consultation</option>
                    <option value="Follow-up">Follow-up</option>
                    <option value="Telemedicine">Telemedicine</option>
                  </select>
                </div>
                <div>
                  <label style="font-size:13px;font-weight:700;color:#374151;margin-bottom:6px;display:block">Date From</label>
                  <input type="date" id="apptDateFrom" onchange="filterApptPageAdvanced()" style="padding:8px;border-radius:8px;border:1px solid #e5e7eb;width:100%;font-size:13px" />
                </div>
                <div>
                  <label style="font-size:13px;font-weight:700;color:#374151;margin-bottom:6px;display:block">Date To</label>
                  <input type="date" id="apptDateTo" onchange="filterApptPageAdvanced()" style="padding:8px;border-radius:8px;border:1px solid #e5e7eb;width:100%;font-size:13px" />
                </div>
                <div>
                  <label style="font-size:13px;font-weight:700;color:#374151;margin-bottom:6px;display:block">Status</label>
                  <select id="apptStatusFilter" onchange="filterApptPageAdvanced()" style="padding:8px;border-radius:8px;border:1px solid #e5e7eb;width:100%;font-size:13px">
                    <option value="all">All Status</option>
                    <option value="Approved">Approved</option>
                    <option value="Pending">Pending</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              <div style="display:flex;gap:8px;justify-content:flex-end">
                <button onclick="clearApptFiltersAdvanced()" class="pill" style="background:#e5e7eb;color:#374151;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:13px"><i class="fas fa-times"></i> Clear All</button>
                <button onclick="exportApptTableAdvanced()" class="pill dark" style="background:#10B981;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:13px"><i class="fas fa-download"></i> Export CSV</button>
                <button onclick="printApptTable()" class="pill dark" style="background:#3b82f6;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:13px"><i class="fas fa-print"></i> Print</button>
              </div>
              <div style="margin-top:10px;padding:10px;background:#dbeafe;border-left:4px solid #0369a1;border-radius:6px">
                <div style="font-size:12px;color:#0369a1"><i class="fas fa-info-circle"></i> <span id="apptFilterFeedback">Showing all appointments</span></div>
              </div>
            </div>
          </div>
          <div class="card" style="margin-bottom:18px">
            <div class="head">All Appointments</div>
            <div class="body">
              <div class="list" id="apptList">
                {% for appt in appointments %}
                <div class="row appt-list-row" data-patient="{{ appt.patient.userprofile.first_name|default:appt.patient.username|lower }}" data-type="{{ appt.consultation_type|lower }}" data-status="{{ appt.approval_status|lower }}" data-date="{{ appt.consultation_date }}" style="margin-bottom:8px">
                  <div class="left">
                    <div class="pill">{{ appt.consultation_time|default:"--:--" }}</div>
                    <div>
                      <div style="font-weight:800">{{ appt.patient.userprofile.first_name|default:appt.patient.username }}{% if appt.patient.userprofile.last_name %} {{ appt.patient.userprofile.last_name }}{% endif %}</div>
                      <div class="muted" style="color:#64748b">{{ appt.consultation_date }} | {{ appt.approval_status }}</div>
                      <div class="muted" style="color:#64748b">Type: {{ appt.consultation_type }} | Status: {{ appt.status|default:"Pending" }}</div>
                    </div>
                  </div>
                  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                    <button onclick="startAppointment({{ appt.consultation_id }})" class="pill dark" style="background:#10B981;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap">
                      <i class="fas fa-video"></i> Start
                    </button>
                    <button class="pill dark" onclick="openApptDetails({{ appt.consultation_id }})" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;box-shadow:0 2px 8px rgba(102,126,234,0.3);transition:all 0.3s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 8px rgba(102,126,234,0.3)'">
                      <i class="fas fa-info-circle"></i> Details
                    </button>
                  </div>
                </div>
                {% empty %}
                <div style="color:#64748b;text-align:center;padding:20px">No appointments found.</div>
                {% endfor %}
              </div>
            </div>
          </div>
          <div id="apCal" style="display:none">
            <div class="card" style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden">
              <div style="padding:20px;background:#f8fafc;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center">
                <div>
                  <h3 style="margin:0;font-size:20px;font-weight:800;color:#1f2937">Appointment Calendar</h3>
                  <p style="margin:4px 0 0 0;color:#6b7280;font-size:14px">View your appointments in calendar format</p>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                  <button onclick="changeCalendarMonth(-1)" class="pill" style="background:#e5e7eb;color:#374151;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <div id="calendarMonthYear" style="font-weight:700;color:#1f2937;font-size:16px;min-width:180px;text-align:center"></div>
                  <button onclick="changeCalendarMonth(1)" class="pill" style="background:#e5e7eb;color:#374151;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                  <button onclick="changeCalendarMonth(0)" class="pill dark" style="background:#3b82f6;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;margin-left:8px">
                    <i class="fas fa-calendar-day"></i> Today
                  </button>
                </div>
              </div>
              <div style="padding:20px">
                <div class="calendar" style="background:#fff">
                  <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px">
                    <div class="cal-day" style="padding:12px;text-align:center;font-weight:700;color:#374151;background:#f8fafc;border-radius:8px">Sun</div>
                    <div class="cal-day" style="padding:12px;text-align:center;font-weight:700;color:#374151;background:#f8fafc;border-radius:8px">Mon</div>
                    <div class="cal-day" style="padding:12px;text-align:center;font-weight:700;color:#374151;background:#f8fafc;border-radius:8px">Tue</div>
                    <div class="cal-day" style="padding:12px;text-align:center;font-weight:700;color:#374151;background:#f8fafc;border-radius:8px">Wed</div>
                    <div class="cal-day" style="padding:12px;text-align:center;font-weight:700;color:#374151;background:#f8fafc;border-radius:8px">Thu</div>
                    <div class="cal-day" style="padding:12px;text-align:center;font-weight:700;color:#374151;background:#f8fafc;border-radius:8px">Fri</div>
                    <div class="cal-day" style="padding:12px;text-align:center;font-weight:700;color:#374151;background:#f8fafc;border-radius:8px">Sat</div>
                  </div>
                  <div id="calendarGrid" class="cal-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="patients" data-tab style="display:none">
          <h1 class="page-title">My Patients</h1>
          <!-- Statistical Cards -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#d1fae5;padding:12px;border-radius:12px">
                    <i class="fas fa-user-injured" style="color:#10b981;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Total Patients</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ patients|length }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Registered patients</div>
            </div>
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#fef3c7;padding:12px;border-radius:12px">
                    <i class="fas fa-calendar-check" style="color:#f59e0b;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Active This Week</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ today_appointments|length }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Appointments this week</div>
            </div>
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#e0e7ff;padding:12px;border-radius:12px">
                    <i class="fas fa-flask" style="color:#6366f1;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Lab Results</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ latest_lab_results|length }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Available lab results</div>
            </div>
          </div>
          <div class="card" style="background:#fff;border:none;box-shadow:none;padding:0">
            <div style="padding:18px">

              <!-- Search and Filter -->
              <div style="display:flex;gap:10px;margin-bottom:16px;align-items:flex-end">
                <div style="flex:1">
                  <label style="font-size:13px;font-weight:700;color:#374151;margin-bottom:6px;display:block">Search Patients</label>
                  <input id="patientSearch" type="text" placeholder="Name, ID, Email, Phone..." style="width:100%;padding:12px 14px;border-radius:8px;border:2px solid #e5e7eb;font-size:14px;font-family:inherit" onkeyup="filterPatientList()" />
                </div>
                <button class="pill dark" onclick="resetPatientSearch()" style="background:#6b7280;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;font-size:13px">Reset</button>
                <button class="pill dark" onclick="exportPatientList()" style="background:#10B981;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;font-size:13px"><i class="fas fa-download"></i> Export</button>
              </div>

              <div style="padding:10px;background:#dbeafe;border-left:4px solid #0369a1;border-radius:6px;margin-bottom:16px">
                <div style="font-size:12px;color:#0369a1"><i class="fas fa-info-circle"></i> <span id="patientFilterFeedback">Showing {{ patients|length }} patient{{ patients|length|pluralize }}</span></div>
              </div>

              <div id="patientList">
                {% for p in patients %}
                <div class="patient-item" data-patient-id="{{ p.user.user_id }}" data-name="{{ p.profile.first_name|default:p.user.username|lower }}" data-email="{{ p.user.email|lower }}" style="background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);border-radius:12px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;padding:18px 24px;transition:transform 0.2s;cursor:default" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 20px rgba(51,65,85,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                  <div style="display:flex;align-items:center;gap:16px;flex:1">
                    <div class="avatar" style="width:48px;height:48px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;border-radius:50%">
                      {% if p.profile.first_name and p.profile.last_name %}
                        {{ p.profile.first_name|slice:":1" }}{{ p.profile.last_name|slice:":1" }}
                      {% else %}
                        {{ p.user.username|slice:":2"|upper }}
                      {% endif %}
                    </div>
                    <div style="flex:1">
                      <div style="font-weight:800;font-size:16px;color:#1f2937">
                        {% if p.profile.first_name and p.profile.last_name %}
                          {{ p.profile.first_name }} {{ p.profile.last_name }}
                        {% else %}
                          {{ p.user.username }}
                        {% endif %}
                      </div>
                      <div style="font-size:13px;color:#64748b;margin-top:4px">ID: {{ p.user.user_id }} · {{ p.user.email }}</div>
                      <div style="font-size:12px;color:#6b7280;margin-top:2px">
                        {% if p.profile.phone_number %}Phone: {{ p.profile.phone_number }}{% endif %}
                        {% if p.profile.sex %}· Gender: {{ p.profile.sex|title }}{% endif %}
                      </div>
                    </div>
                  </div>
                  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
                    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                      <button class="pill dark" onclick="openPatientProfile({{ p.user.user_id }})" style="background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;box-shadow:0 2px 8px rgba(59,130,246,0.3);transition:all 0.3s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 8px rgba(59,130,246,0.3)'">
                        <i class="fas fa-id-card"></i> Profile
                      </button>
                      <button class="pill dark" onclick="viewPatientLabResults({{ p.user.user_id }}, '{{ p.profile.first_name|default:p.user.username }} {{ p.profile.last_name|default:'' }}')" style="background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;box-shadow:0 2px 8px rgba(16,185,129,0.3);transition:all 0.3s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 8px rgba(16,185,129,0.3)'">
                        <i class="fas fa-flask"></i> Lab Results
                      </button>
                    </div>
                    <div style="font-size:11px;color:#6b7280">Last Appt: <span style="color:#374151;font-weight:600">{{ p.user|add:"" }}</span></div>
                  </div>
                </div>
                {% empty %}
                <div style="text-align:center;padding:40px;color:#64748b">
                  <i class="fas fa-users" style="font-size:48px;margin-bottom:16px;opacity:0.5"></i>
                  <p style="font-size:16px">No patients found</p>
                  <p style="font-size:14px">Start by scheduling appointments with patients</p>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div id="lab" data-tab style="display:none">
          <h1 class="page-title">Laboratory Results Management</h1>
          <!-- Statistical Cards -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#e0e7ff;padding:12px;border-radius:12px">
                    <i class="fas fa-flask" style="color:#6366f1;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Total Lab Results</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ latest_lab_results|length }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">All lab results</div>
            </div>
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#dbeafe;padding:12px;border-radius:12px">
                    <i class="fas fa-user-injured" style="color:#3b82f6;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Patients</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ patients|length }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Patients with results</div>
            </div>
          </div>
          
          <!-- Patient Search Panel -->
          <div class="card" style="margin-bottom:18px">
            <div class="head">
              <div><i class="fas fa-search"></i> Search Patient Lab Results</div>
            </div>
            <div class="body">
              <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap">
                <input type="text" id="patientSearchInput" placeholder="Search by patient name, email, or username..." 
                       style="flex:1;min-width:240px;padding:12px 16px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;font-family:inherit"
                       onkeyup="searchPatients(this.value)">
                <button class="pill dark" onclick="clearPatientSearch()" style="background:#6b7280;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;white-space:nowrap">
                  <i class="fas fa-times"></i> Clear
                </button>
              </div>
              <div id="patientSearchResults" style="display:none">
                <!-- Search results will be populated here -->
              </div>
            </div>
          </div>
          
          <!-- Latest Lab Results Panel with Advanced Filtering -->
          <div class="card" style="margin-bottom:18px">
            <div class="head">
              <div><i class="fas fa-flask"></i> Latest Lab Results <span style="float:right;font-size:12px;color:#6b7280">{{ latest_lab_results|length }} Results</span></div>
            </div>
            <div style="padding:12px 14px;border-top:1px solid #e5e7eb;background:#f8fafc;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
              <div>
                <label style="font-size:11px;font-weight:700;color:#374151;display:block;margin-bottom:4px">Lab Type</label>
                <select id="labTypeFilter" onchange="filterLabResultsAdvanced()" style="padding:6px;border-radius:6px;border:1px solid #d1d5db;font-size:11px;width:100%">
                  <option value="all">All Types</option>
                  {% for lr in latest_lab_results|slice:":10" %}
                    <option value="{{ lr.lab_type|escapejs }}">{{ lr.lab_type }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#374151;display:block;margin-bottom:4px">Date From</label>
                <input type="date" id="labDateFrom" onchange="filterLabResultsAdvanced()" style="padding:6px;border-radius:6px;border:1px solid #d1d5db;font-size:11px;width:100%" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#374151;display:block;margin-bottom:4px">Date To</label>
                <input type="date" id="labDateTo" onchange="filterLabResultsAdvanced()" style="padding:6px;border-radius:6px;border:1px solid #d1d5db;font-size:11px;width:100%" />
              </div>
              <div style="display:flex;gap:6px;align-items:flex-end">
                <button class="pill" onclick="clearLabFilters()" style="font-size:11px;padding:6px 10px;background:#e5e7eb;color:#374151;border:none;cursor:pointer;border-radius:6px">Reset</button>
                <button class="pill dark" onclick="exportLabResultsCSV()" style="font-size:11px;padding:6px 10px;background:#10B981;color:#fff;border:none;cursor:pointer;border-radius:6px"><i class="fas fa-download"></i> Export</button>
                <button class="pill dark" onclick="refreshLabResults()" style="font-size:11px;padding:6px 10px;background:#3b82f6;color:#fff;border:none;cursor:pointer;border-radius:6px"><i class="fas fa-sync-alt"></i> Refresh</button>
              </div>
            </div>
            <div style="padding:10px 14px;border-top:1px solid #e5e7eb;background:#dbeafe;margin:0">
              <div style="font-size:12px;color:#0369a1"><i class="fas fa-info-circle"></i> <span id="labFilterFeedback">Showing {{ latest_lab_results|length }} lab result{{ latest_lab_results|length|pluralize }}</span></div>
            </div>
            <div class="body">
              {% if latest_lab_results %}
              <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse">
                  <thead>
                    <tr style="background:#f8fafc;border-bottom:2px solid #e5e7eb">
                      <th style="padding:12px 16px;text-align:left;font-weight:800;color:#1f2937;font-size:13px">Lab Result ID</th>
                      <th style="padding:12px 16px;text-align:left;font-weight:800;color:#1f2937;font-size:13px">Patient Name</th>
                      <th style="padding:12px 16px;text-align:left;font-weight:800;color:#1f2937;font-size:13px">Lab Type</th>
                      <th style="padding:12px 16px;text-align:left;font-weight:800;color:#1f2937;font-size:13px">Date Uploaded</th>
                      <th style="padding:12px 16px;text-align:left;font-weight:800;color:#1f2937;font-size:13px">Uploaded By</th>
                      <th style="padding:12px 16px;text-align:center;font-weight:800;color:#1f2937;font-size:13px">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="labResultsTable">
                    {% for lab_result in latest_lab_results %}
                    <tr class="lab-result-row" data-lab-type="{{ lab_result.lab_type|lower }}" data-upload-date="{{ lab_result.upload_date|date:'Y-m-d' }}" style="border-bottom:1px solid #e5e7eb;transition:background-color 0.2s" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor='transparent'">
                      <td style="padding:12px 16px;font-weight:700;color:#3b82f6">{{ lab_result.lab_result_id }}</td>
                      <td style="padding:12px 16px">
                        <div style="display:flex;align-items:center;gap:8px">
                          <div class="avatar" style="width:32px;height:32px;background:#3b82f6;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:11px;border-radius:50%">
                            {% if lab_result.user.userprofile.first_name and lab_result.user.userprofile.last_name %}
                              {{ lab_result.user.userprofile.first_name|slice:":1" }}{{ lab_result.user.userprofile.last_name|slice:":1" }}
                            {% else %}
                              {{ lab_result.user.username|slice:":2"|upper }}
                            {% endif %}
                          </div>
                          <div>
                            <div style="font-weight:600;color:#1f2937;font-size:13px">
                              {% if lab_result.user.userprofile.first_name and lab_result.user.userprofile.last_name %}
                                {{ lab_result.user.userprofile.first_name }} {{ lab_result.user.userprofile.last_name }}
                              {% else %}
                                {{ lab_result.user.username }}
                              {% endif %}
                            </div>
                            <div style="font-size:12px;color:#64748b">{{ lab_result.user.email }}</div>
                          </div>
                        </div>
                      </td>
                      <td style="padding:12px 16px;font-weight:600;color:#1f2937">{{ lab_result.lab_type }}</td>
                      <td style="padding:12px 16px;color:#64748b">
                        <div style="font-weight:600">{{ lab_result.upload_date|date:"M d, Y" }}</div>
                        <div style="font-size:12px">{{ lab_result.upload_date|time:"H:i" }}</div>
                      </td>
                      <td style="padding:12px 16px;color:#64748b">
                        {% if lab_result.uploaded_by %}
                          <span class="pill" style="background:#dbeafe;color:#1e40af;font-size:12px">{{ lab_result.uploaded_by.username }}</span>
                        {% else %}
                          <span class="pill" style="background:#f3f4f6;color:#6b7280;font-size:12px">System</span>
                        {% endif %}
                      </td>
                      <td style="padding:12px 16px;text-align:center">
                        <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap">
                          <a href="/doctors/download-lab-result/{{ lab_result.lab_result_id }}/" class="pill dark" style="text-decoration:none;font-size:12px;background:#10B981;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;gap:4px">
                            <i class="fas fa-download"></i> Download
                          </a>
                          {% if lab_result.notes %}
                          <button class="pill" onclick="viewLabResultNotes('{{ lab_result.lab_result_id }}', '{{ lab_result.notes|escapejs }}')" style="font-size:12px;background:#dbeafe;color:#1e40af;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;gap:4px">
                            <i class="fas fa-eye"></i> Notes
                          </button>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <div style="text-align:center;padding:40px;color:#64748b">
                <i class="fas fa-flask" style="font-size:48px;margin-bottom:16px;opacity:0.5"></i>
                <div style="font-size:16px;margin-bottom:8px">No lab results found</div>
                <div style="font-size:14px">No lab results have been uploaded to the system yet</div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        <div id="rx" data-tab style="display:none">
          <h1 class="page-title">Prescriptions Management</h1>
          <!-- Statistical Cards -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#dcfce7;padding:12px;border-radius:12px">
                    <i class="fas fa-prescription" style="color:#10b981;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Total Prescriptions</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0">{{ prescriptions|length }}</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">All prescriptions</div>
            </div>
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#d1fae5;padding:12px;border-radius:12px">
                    <i class="fas fa-check-circle" style="color:#10b981;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">Active</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0" id="rxActiveCount">-</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Active prescriptions</div>
            </div>
            <div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s" onmouseover="this.style.borderColor='#0066CC';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:16px">
                  <div style="background:#fef3c7;padding:12px;border-radius:12px">
                    <i class="fas fa-calendar-check" style="color:#f59e0b;font-size:24px"></i>
                  </div>
                  <div>
                    <h3 style="font-size:16px;font-weight:700;color:#374151;margin:0">This Month</h3>
                    <p style="font-size:32px;font-weight:900;color:#003366;margin:4px 0 0 0" id="rxMonthCount">-</p>
                  </div>
                </div>
              </div>
              <div style="font-size:12px;color:#6b7280">Prescriptions this month</div>
            </div>
          </div>
          <div class="card">
            <div class="head">
              <div><i class="fas fa-prescription-bottle-medical"></i> All Prescriptions</div>
              <button class="btn-grad" style="background:#10B981;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:13px"><i class="fas fa-plus"></i> New Prescription</button>
            </div>
            <!-- Advanced Filtering Panel -->
            <div style="padding:12px 14px;border-bottom:1px solid #e5e7eb;background:#f8fafc;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
              <div>
                <label style="font-size:11px;font-weight:700;color:#374151;display:block;margin-bottom:4px">Search</label>
                <input id="rxPageSearch" type="text" placeholder="Rx #, patient..." style="width:100%;padding:6px 10px;border-radius:6px;border:1px solid #d1d5db;font-size:11px" onkeyup="filterRxPageAdvanced()" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#374151;display:block;margin-bottom:4px">Status</label>
                <select id="rxStatusFilter" onchange="filterRxPageAdvanced()" style="width:100%;padding:6px;border-radius:6px;border:1px solid #d1d5db;font-size:11px">
                  <option value="all">All Status</option>
                  <option value="Active">Active</option>
                  <option value="Completed">Completed</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#374151;display:block;margin-bottom:4px">Date From</label>
                <input type="date" id="rxPageDateFrom" onchange="filterRxPageAdvanced()" style="width:100%;padding:6px;border-radius:6px;border:1px solid #d1d5db;font-size:11px" />
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#374151;display:block;margin-bottom:4px">Date To</label>
                <input type="date" id="rxPageDateTo" onchange="filterRxPageAdvanced()" style="width:100%;padding:6px;border-radius:6px;border:1px solid #d1d5db;font-size:11px" />
              </div>
              <div style="display:flex;gap:6px;align-items:flex-end">
                <button class="pill" onclick="clearRxFilters()" style="font-size:11px;padding:6px 10px;background:#e5e7eb;color:#374151;border:none;cursor:pointer;border-radius:6px">Reset</button>
                <button class="pill dark" onclick="exportRxCSV()" style="font-size:11px;padding:6px 10px;background:#10B981;color:#fff;border:none;cursor:pointer;border-radius:6px"><i class="fas fa-download"></i> Export</button>
              </div>
            </div>
            <div style="padding:10px 14px;background:#dbeafe;border-bottom:1px solid #e5e7eb">
              <div style="font-size:12px;color:#0369a1"><i class="fas fa-info-circle"></i> <span id="rxFilterFeedback">Showing {{ prescriptions|length }} prescription{{ prescriptions|length|pluralize }}</span></div>
            </div>
            <div class="body">
              <div class="list" id="rxPageList">
                {% if prescriptions %}
                {% for rx in prescriptions %}
                  <div class="row rx-page-item" data-created-at="{{ rx.created_at|date:'Y-m-d' }}" data-status="{{ rx.status|lower }}" data-patient="{{ rx.live_appointment.appointment.patient.get_full_name|lower }}" style="margin-bottom:12px;transition:all 0.3s">
                    <div class="left">
                      <div class="pill" style="background:#dcfce7;color:#14532d;font-weight:600">{{ rx.status|upper }}</div>
                      <div>
                        <div style="font-weight:800;font-size:14px">Rx #{{ rx.prescription_number }}</div>
                        <div class="muted" style="color:#64748b;font-size:13px">
                          Patient: {{ rx.live_appointment.appointment.patient.get_full_name }} · 
                          Created: {{ rx.created_at|date:"M d, Y" }} · 
                          Duration: {{ rx.duration_days|default:"30" }} days
                        </div>
                        <div class="muted" style="color:#6b7280;font-size:12px">
                          Refills: {% if rx.refills_remaining %}{{ rx.refills_remaining }} remaining{% else %}None{% endif %}
                        </div>
                      </div>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                      <button class="pill dark" onclick="viewPrescriptionDetails('{{ rx.prescription_id }}')" style="background:#3b82f6;color:#fff;border:none;padding:8px 12px;border-radius:6px;font-size:12px;cursor:pointer;white-space:nowrap">
                        <i class="fas fa-eye"></i> View
                      </button>
                      <button class="pill dark" onclick="downloadPrescription('{{ rx.prescription_id }}')" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;box-shadow:0 2px 8px rgba(102,126,234,0.3);transition:all 0.3s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 8px rgba(102,126,234,0.3)'">
                        <i class="fas fa-download"></i> Download Prescription
                      </button>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div style="padding:40px;text-align:center;color:#64748b">
                  <i class="fas fa-prescription-bottle" style="font-size:48px;margin-bottom:16px;opacity:0.5;display:block"></i>
                  <p style="font-size:16px;margin:0">No prescriptions created yet</p>
                  <p style="font-size:14px;margin:8px 0 0 0">Start creating prescriptions from appointments</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </main>
    </section>

    <!-- All Modals - Moved outside main/section to ensure they work on all pages -->
    <!-- Appointment Details Modal - Professional Design -->
    <div id="apptDetailsModal" class="overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;align-items:center;justify-content:center">
      <div class="overlay-content" style="background:#fff;border-radius:16px;max-width:700px;width:92vw;position:relative;z-index:10001;box-shadow:0 30px 80px rgba(0,0,0,.3);overflow:hidden">
        <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:24px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0;font-size:24px;font-weight:900;color:#fff">Appointment Details</h2>
            <p style="margin:6px 0 0 0;opacity:.9;font-size:14px">View complete appointment information</p>
          </div>
          <button onclick="closeApptDetails()" class="pill" style="position:static;background:#fff;color:#764ba2;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:18px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:700">✕</button>
        </div>
        <div style="padding:24px;max-height:70vh;overflow-y:auto">
          <div id="apptDetailsBody" style="display:grid;grid-template-columns:1fr 1fr;gap:16px"></div>
        </div>
      </div>
    </div>

    <!-- Patient Profile Modal -->
    <!-- Patient Profile Modal - Professional Design -->
    <div id="patientProfileModal" class="overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;align-items:center;justify-content:center">
      <div class="overlay-content" style="background:#fff;border-radius:16px;max-width:700px;width:92vw;position:relative;z-index:10001;box-shadow:0 30px 80px rgba(0,0,0,.3);overflow:hidden">
        <div style="background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;padding:24px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0;font-size:24px;font-weight:900;color:#fff">Patient Profile</h2>
            <p style="margin:6px 0 0 0;opacity:.9;font-size:14px">View complete patient information</p>
          </div>
          <button onclick="closePatientProfile()" class="pill" style="position:static;background:#fff;color:#2563eb;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:18px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:700">✕</button>
        </div>
        <div style="padding:24px;max-height:70vh;overflow-y:auto">
          <div id="patientProfileBody" style="display:grid;grid-template-columns:1fr 1fr;gap:16px"></div>
        </div>
      </div>
    </div>

    <!-- Patient Lab Results Modal - Professional Design -->
    <div id="patientLabResultsModal" class="overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;align-items:center;justify-content:center">
      <div class="overlay-content" style="background:#fff;border-radius:16px;max-width:900px;width:95vw;position:relative;box-shadow:0 30px 80px rgba(0,0,0,.3);max-height:80vh;overflow-y:auto;z-index:10001">
        <div style="background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:#fff;padding:24px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10">
          <div>
            <h2 style="margin:0;font-size:24px;font-weight:900;color:#fff" id="patientLabResultsTitle">Patient Lab Results</h2>
            <p style="margin:6px 0 0 0;opacity:.9;font-size:14px">View and manage patient laboratory results</p>
          </div>
          <button onclick="closePatientLabResults()" class="pill" style="position:static;background:#fff;color:#059669;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:18px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:700">✕</button>
        </div>
        <div style="padding:24px">
          <div id="patientLabResultsBody">
            <!-- Patient lab results will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Prescription Details Modal - Professional Design -->
    <div id="prescriptionDetailsModal" class="overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;align-items:center;justify-content:center">
      <div class="overlay-content" style="background:#fff;border-radius:16px;max-width:800px;width:92vw;position:relative;z-index:10001;box-shadow:0 30px 80px rgba(0,0,0,.3);overflow:hidden">
        <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:24px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0;font-size:24px;font-weight:900;color:#fff">Prescription Details</h2>
            <p style="margin:6px 0 0 0;opacity:.9;font-size:14px">View complete prescription information</p>
          </div>
          <button onclick="closePrescriptionDetails()" class="pill" style="position:static;background:#fff;color:#764ba2;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:18px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:700">✕</button>
        </div>
        <div style="padding:24px;max-height:70vh;overflow-y:auto">
          <div id="prescriptionDetailsBody" style="display:grid;grid-template-columns:1fr 1fr;gap:16px"></div>
        </div>
      </div>
    </div>

    <!-- System Settings Modal - Professional Design -->
    <div id="systemSettingsModal" class="overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;align-items:center;justify-content:center">
      <div class="overlay-content" style="background:#fff;border-radius:16px;max-width:700px;width:92vw;position:relative;z-index:10001;box-shadow:0 30px 80px rgba(0,0,0,.3);overflow:hidden;max-height:85vh;overflow-y:auto">
        <div style="background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);color:#fff;padding:24px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10">
          <div>
            <h2 style="margin:0;font-size:24px;font-weight:900;color:#fff">System Settings</h2>
            <p style="margin:6px 0 0 0;opacity:.9;font-size:14px">Configure your system preferences</p>
          </div>
          <button onclick="closeSystemSettings()" class="pill" style="position:static;background:#fff;color:#8b5cf6;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:18px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:700">✕</button>
        </div>
        <div style="padding:24px">
          <div style="margin-bottom:24px">
            <h3 style="font-size:18px;font-weight:800;color:#1f2937;margin-bottom:16px;display:flex;align-items:center;gap:8px">
              <i class="fas fa-bell" style="color:#6366f1"></i> Notifications
            </h3>
            <div style="padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb;margin-bottom:12px">
              <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer">
                <span style="font-weight:600;color:#374151">Email Notifications</span>
                <input type="checkbox" checked style="width:20px;height:20px;cursor:pointer">
              </label>
            </div>
            <div style="padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb;margin-bottom:12px">
              <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer">
                <span style="font-weight:600;color:#374151">Appointment Reminders</span>
                <input type="checkbox" checked style="width:20px;height:20px;cursor:pointer">
              </label>
            </div>
          </div>
          <div style="margin-bottom:24px">
            <h3 style="font-size:18px;font-weight:800;color:#1f2937;margin-bottom:16px;display:flex;align-items:center;gap:8px">
              <i class="fas fa-palette" style="color:#6366f1"></i> Appearance
            </h3>
            <div style="padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb;margin-bottom:12px">
              <label style="font-weight:600;color:#374151;display:block;margin-bottom:8px">Medisafe Color Theme</label>
              <select id="medisafeTheme" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:14px">
                <option value="default">Default (Blue & Purple)</option>
                <option value="professional">Professional (Blue Gradient)</option>
                <option value="medical">Medical (Teal & Blue)</option>
                <option value="classic">Classic (Navy & White)</option>
              </select>
              <div style="font-size:12px;color:#6b7280;margin-top:6px">Choose your preferred Medisafe color scheme</div>
            </div>
            <div style="padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb;margin-bottom:12px">
              <label style="font-weight:600;color:#374151;display:block;margin-bottom:8px">Dashboard Layout</label>
              <select id="dashboardLayout" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:14px">
                <option value="compact">Compact</option>
                <option value="standard" selected>Standard</option>
                <option value="spacious">Spacious</option>
              </select>
            </div>
            <div style="padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb;margin-bottom:12px">
              <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer">
                <div>
                  <div style="font-weight:600;color:#374151">Show Animations</div>
                  <div style="font-size:12px;color:#6b7280">Enable smooth transitions and animations</div>
                </div>
                <input type="checkbox" id="showAnimations" checked style="width:20px;height:20px;cursor:pointer">
              </label>
            </div>
            <div style="padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb;margin-bottom:12px">
              <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer">
                <div>
                  <div style="font-weight:600;color:#374151">Compact Mode</div>
                  <div style="font-size:12px;color:#6b7280">Reduce spacing for more content visibility</div>
                </div>
                <input type="checkbox" id="compactMode" style="width:20px;height:20px;cursor:pointer">
              </label>
            </div>
            <div style="padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb">
              <label style="font-weight:600;color:#374151;display:block;margin-bottom:8px">Font Size</label>
              <select id="fontSize" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:14px">
                <option value="small">Small</option>
                <option value="medium" selected>Medium</option>
                <option value="large">Large</option>
              </select>
            </div>
          </div>
          <div style="margin-bottom:24px">
            <h3 style="font-size:18px;font-weight:800;color:#1f2937;margin-bottom:16px;display:flex;align-items:center;gap:8px">
              <i class="fas fa-clock" style="color:#6366f1"></i> Time Zone
            </h3>
            <div style="padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb">
              <label style="font-weight:600;color:#374151;display:block;margin-bottom:8px">Select Time Zone</label>
              <select id="timeZone" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:14px">
                <option value="UTC">UTC (Coordinated Universal Time)</option>
                <option value="EST">EST (Eastern Standard Time)</option>
                <option value="PST">PST (Pacific Standard Time)</option>
                <option value="CST">CST (Central Standard Time)</option>
                <option value="MST">MST (Mountain Standard Time)</option>
              </select>
            </div>
          </div>
          <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;padding-top:24px;border-top:1px solid #e5e7eb">
            <button onclick="closeSystemSettings()" class="pill" style="background:#e5e7eb;color:#374151;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600">Cancel</button>
            <button onclick="saveSystemSettings()" class="pill dark" style="background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600">Save Settings</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Settings Modal - Professional Redesign -->
    <div id="profileSettingsModal" class="overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;align-items:center;justify-content:center">
      <div class="overlay-content" style="background:#fff;border-radius:16px;max-width:900px;width:92vw;position:relative;box-shadow:0 30px 80px rgba(0,0,0,.3);max-height:85vh;overflow-y:auto;z-index:10001">
            <!-- Header with gradient -->
            <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:24px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0">
              <div>
                <h2 style="margin:0;font-size:28px;font-weight:900">Profile Settings</h2>
                <p style="margin:6px 0 0 0;opacity:.9">Manage your professional profile and preferences</p>
              </div>
              <button onclick="closeProfileSettings()" class="pill" style="position:static;background:#fff;color:#764ba2;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:18px;width:40px;height:40px;display:flex;align-items:center;justify-content:center">✕</button>
            </div>

            <!-- Tabs -->
            <div style="display:flex;gap:0;border-bottom:2px solid #e5e7eb;background:#f8fafc;padding:0">
              <button class="profile-tab-btn active" data-tab="personal" onclick="switchProfileTab('personal')" style="flex:1;padding:14px;border:none;background:transparent;cursor:pointer;font-weight:700;color:#6b7280;border-bottom:3px solid transparent;margin-bottom:-2px" data-active-color="#764ba2">
                <i class="fas fa-user"></i> Personal
              </button>
              <button class="profile-tab-btn" data-tab="professional" onclick="switchProfileTab('professional')" style="flex:1;padding:14px;border:none;background:transparent;cursor:pointer;font-weight:700;color:#6b7280;border-bottom:3px solid transparent;margin-bottom:-2px" data-active-color="#764ba2">
                <i class="fas fa-briefcase"></i> Professional
              </button>
              <button class="profile-tab-btn" data-tab="notifications" onclick="switchProfileTab('notifications')" style="flex:1;padding:14px;border:none;background:transparent;cursor:pointer;font-weight:700;color:#6b7280;border-bottom:3px solid transparent;margin-bottom:-2px" data-active-color="#764ba2">
                <i class="fas fa-bell"></i> Notifications
              </button>
              <button class="profile-tab-btn" data-tab="privacy" onclick="switchProfileTab('privacy')" style="flex:1;padding:14px;border:none;background:transparent;cursor:pointer;font-weight:700;color:#6b7280;border-bottom:3px solid transparent;margin-bottom:-2px" data-active-color="#764ba2">
                <i class="fas fa-lock"></i> Privacy
              </button>
            </div>

            <div style="padding:24px">
              <!-- Personal Tab -->
              <div id="profile-tab-personal" class="profile-tab-content" style="display:block">
                <form id="doctorProfileForm" method="POST" action="{% url 'doctor_update_profile' %}" enctype="multipart/form-data" style="display:grid;gap:20px">
                  {% csrf_token %}
                  <!-- Profile Photo -->
                  <div style="display:flex;align-items:center;gap:16px;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);padding:18px;border-radius:12px;border-left:4px solid #667eea">
                    <div class="avatar" id="profilePreview" style="width:100px;height:100px;border-radius:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:36px">{{ user_profile.first_name|default:user.username|slice:":1" }}{{ user_profile.last_name|default:""|slice:":1" }}</div>
                    <div>
                      <div style="font-weight:700;margin-bottom:8px">Profile Photo</div>
                      <label class="pill" style="display:inline-block;background:#667eea;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;border:none;font-size:12px">
                        <input type="file" name="profile_photo" accept="image/*" style="display:none" onchange="previewProfilePhoto(event)">
                        <i class="fas fa-upload"></i> Upload Photo
                      </label>
                      {% if user_profile.photo_url %}
                      <a href="{{ user_profile.photo_url }}" target="_blank" class="pill" style="display:inline-block;background:#f3f4f6;color:#374151;padding:8px 12px;border-radius:6px;text-decoration:none;font-size:12px;margin-left:8px">
                        <i class="fas fa-eye"></i> View current
                      </a>
                      {% endif %}
                    </div>
                  </div>

                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div>
                      <label style="font-weight:700;color:#1f2937;margin-bottom:6px;display:block">First Name</label>
                      <input type="text" name="first_name" value="{{ user_profile.first_name }}" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px">
                    </div>
                    <div>
                      <label style="font-weight:700;color:#1f2937;margin-bottom:6px;display:block">Last Name</label>
                      <input type="text" name="last_name" value="{{ user_profile.last_name }}" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px">
                    </div>
                    <div>
                      <label style="font-weight:700;color:#1f2937;margin-bottom:6px;display:block">Gender</label>
                      <select name="sex" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px">
                        <option value="">Select Gender</option>
                        <option value="male" {% if user_profile.sex == 'male' %}selected{% endif %}>Male</option>
                        <option value="female" {% if user_profile.sex == 'female' %}selected{% endif %}>Female</option>
                        <option value="other" {% if user_profile.sex == 'other' %}selected{% endif %}>Other</option>
                      </select>
                    </div>
                    <div>
                      <label style="font-weight:700;color:#1f2937;margin-bottom:6px;display:block">Birth Date</label>
                      <input type="date" name="birthday" value="{{ user_profile.birthday|date:'Y-m-d' }}" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px">
                    </div>
                    <div>
                      <label style="font-weight:700;color:#1f2937;margin-bottom:6px;display:block">Contact Number</label>
                      <input type="text" name="phone_number" value="{{ user_profile.phone_number }}" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px">
                    </div>
                    <div>
                      <label style="font-weight:700;color:#1f2937;margin-bottom:6px;display:block">Emergency Contact</label>
                      <input type="text" name="contact_person" value="{{ user_profile.contact_person }}" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px">
                    </div>
                  </div>
                  <div style="grid-column:1/-1">
                    <label style="font-weight:700;color:#1f2937;margin-bottom:6px;display:block">Address</label>
                    <input type="text" name="address" value="{{ user_profile.address }}" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px">
                  </div>
                </form>
              </div>

              <!-- Professional Tab -->
              <div id="profile-tab-professional" class="profile-tab-content" style="display:none">
                <div style="background:#f8fafc;padding:16px;border-radius:10px;border-left:4px solid #764ba2;margin-bottom:16px">
                  <div style="font-weight:700;color:#1f2937;margin-bottom:8px"><i class="fas fa-stethoscope"></i> Professional Information</div>
                  <div style="color:#6b7280;font-size:13px">View your professional credentials and specialization details</div>
                </div>
                <div style="display:grid;gap:12px">
                  <div>
                    <label style="font-weight:700;color:#1f2937;margin-bottom:6px;display:block">Specialization</label>
                    <input type="text" value="{{ doctor.specialization|default:'' }}" readonly style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px;background:#f3f4f6;color:#6b7280">
                  </div>
                  <div>
                    <label style="font-weight:700;color:#1f2937;margin-bottom:6px;display:block">License Number</label>
                    <input type="text" value="{{ doctor.license_number|default:'' }}" readonly style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px;background:#f3f4f6;color:#6b7280">
                  </div>
                  <div style="padding:12px;background:#dcfce7;border-radius:10px;border-left:4px solid #10B981;font-size:13px">
                    <strong>Note:</strong> Professional information cannot be modified. Contact administration if updates are needed.
                  </div>
                </div>
              </div>

              <!-- Notifications Tab -->
              <div id="profile-tab-notifications" class="profile-tab-content" style="display:none">
                <div style="background:#f8fafc;padding:16px;border-radius:10px;border-left:4px solid #764ba2;margin-bottom:16px">
                  <div style="font-weight:700;color:#1f2937;margin-bottom:8px"><i class="fas fa-bell"></i> Notification Preferences</div>
                  <div style="color:#6b7280;font-size:13px">Manage how and when you receive notifications</div>
                </div>
                <div style="display:grid;gap:12px">
                  <label style="display:flex;align-items:center;gap:10px;padding:12px;background:#f9fafb;border-radius:10px;cursor:pointer;border:1px solid #e5e7eb">
                    <input type="checkbox" checked style="width:18px;height:18px">
                    <div>
                      <div style="font-weight:600;color:#1f2937">New Appointment Notifications</div>
                      <div style="font-size:12px;color:#6b7280">Receive alerts when patients book new appointments</div>
                    </div>
                  </label>
                  <label style="display:flex;align-items:center;gap:10px;padding:12px;background:#f9fafb;border-radius:10px;cursor:pointer;border:1px solid #e5e7eb">
                    <input type="checkbox" checked style="width:18px;height:18px">
                    <div>
                      <div style="font-weight:600;color:#1f2937">Lab Results Notifications</div>
                      <div style="font-size:12px;color:#6b7280">Get notified when new lab results are available</div>
                    </div>
                  </label>
                  <label style="display:flex;align-items:center;gap:10px;padding:12px;background:#f9fafb;border-radius:10px;cursor:pointer;border:1px solid #e5e7eb">
                    <input type="checkbox" checked style="width:18px;height:18px">
                    <div>
                      <div style="font-weight:600;color:#1f2937">Patient Messages</div>
                      <div style="font-size:12px;color:#6b7280">Notifications for new patient messages</div>
                    </div>
                  </label>
                  <label style="display:flex;align-items:center;gap:10px;padding:12px;background:#f9fafb;border-radius:10px;cursor:pointer;border:1px solid #e5e7eb">
                    <input type="checkbox" style="width:18px;height:18px">
                    <div>
                      <div style="font-weight:600;color:#1f2937">Email Digest (Daily)</div>
                      <div style="font-size:12px;color:#6b7280">Receive a summary email of all activities</div>
                    </div>
                  </label>
                  <button class="pill dark" onclick="window.location.href='{% url 'alertnotification' %}'" style="background:#667eea;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;font-size:13px;align-self:flex-start;margin-top:8px;white-space:nowrap">
                    <i class="fas fa-arrow-right"></i> Go to All Notifications
                  </button>
                </div>
              </div>

              <!-- Privacy Tab -->
              <div id="profile-tab-privacy" class="profile-tab-content" style="display:none">
                <div style="background:#f8fafc;padding:16px;border-radius:10px;border-left:4px solid#764ba2;margin-bottom:16px">
                  <div style="font-weight:700;color:#1f2937;margin-bottom:8px"><i class="fas fa-lock"></i> Privacy & Security</div>
                  <div style="color:#6b7280;font-size:13px">Manage your privacy settings and security options</div>
                </div>
                <div style="display:grid;gap:12px">
                  <div style="padding:12px;background:#f9fafb;border-radius:10px;border-left:4px solid #3b82f6">
                    <div style="font-weight:600;color:#1f2937;margin-bottom:4px">Profile Visibility</div>
                    <div style="font-size:12px;color:#6b7280;margin-bottom:8px">Your profile is visible to patients who book appointments with you</div>
                    <label style="display:flex;align-items:center;gap:8px"><input type="radio" name="visibility" checked> Public</label>
                    <label style="display:flex;align-items:center;gap:8px;margin-top:4px"><input type="radio" name="visibility"> Private</label>
                  </div>
                  <div style="padding:12px;background:#fff3cd;border-radius:10px;border-left:4px solid #ffc107">
                    <div style="font-weight:600;color:#1f2937;margin-bottom:8px"><i class="fas fa-key"></i> Change Password</div>
                    <button class="pill dark" style="background:#ffc107;color:#1f2937;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:12px">Update Password</button>
                  </div>
                  <div style="padding:12px;background:#fee2e2;border-radius:10px;border-left:4px solid #dc2626">
                    <div style="font-weight:600;color:#1f2937;margin-bottom:8px"><i class="fas fa-exclamation-triangle"></i> Danger Zone</div>
                    <button class="pill dark" style="background:#dc2626;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:12px">Deactivate Account</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Footer with Actions -->
            <div style="padding:16px 24px;border-top:1px solid #e5e7eb;background:#f8fafc;display:flex;gap:8px;justify-content:flex-end;position:sticky;bottom:0">
              <button type="button" onclick="closeProfileSettings()" class="pill" style="background:#e5e7eb;color:#374151;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600">Cancel</button>
              <button type="submit" form="doctorProfileForm" class="pill dark" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600">Save Changes</button>
            </div>

            <div id="profileSaveToast" style="display:none;position:fixed;top:20px;right:20px;background:#10B981;color:#fff;padding:16px 20px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:10010;font-weight:600">✓ Profile updated successfully</div>
          </div>
    </div>

    <!-- Quick Profile Modal -->
    <div id="quickProfileModal" class="overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:10000;align-items:center;justify-content:center">
      <div class="overlay-content" style="background:#fff;padding:24px;border-radius:16px;max-width:520px;width:92vw;position:relative;box-shadow:0 30px 80px rgba(0,0,0,.25);z-index:10001">
        <button onclick="closeQuickProfile()" class="pill" style="position:absolute;top:16px;right:16px;z-index:10002">Close</button>
        <div style="display:flex;gap:16px;align-items:center">
          <div class="avatar" style="width:84px;height:84px">
            {% if user_profile.photo_url %}
              <img src="{{ user_profile.photo_url }}" alt="Profile Photo" style="width:100%;height:100%;object-fit:cover;border-radius:999px">
            {% else %}
              {{ user_profile.first_name|default:user.username|slice:":1" }}{{ user_profile.last_name|default:""|slice:":1" }}
            {% endif %}
          </div>
          <div>
            <div style="font-weight:900;color:#213A57;font-size:22px">Dr. {{ user_profile.first_name|default:user.username }}{% if user_profile.last_name %} {{ user_profile.last_name }}{% endif %}</div>
            <div style="color:#6b7280">{{ doctor.specialization|default:"" }}</div>
          </div>
        </div>
      </div>
    </div>

    <script>
          const apptData = {
            {% for appt in appointments %}
            {{ appt.consultation_id }}: {
              id: {{ appt.consultation_id }},
              patientName: "{{ appt.patient.userprofile.first_name|default:appt.patient.username|escapejs }}{% if appt.patient.userprofile.last_name %} {{ appt.patient.userprofile.last_name|escapejs }}{% endif %}",
              date: "{{ appt.consultation_date|date:'Y-m-d' }}",
              time: "{{ appt.consultation_time|time:'H:i' }}",
              type: "{{ appt.consultation_type|escapejs }}",
              approval: "{{ appt.approval_status|escapejs }}",
              status: "{{ appt.status|escapejs }}",
              notes: "{{ appt.notes|default:''|escapejs }}",
              meetingLink: "{{ appt.meeting_link|default:''|escapejs }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
          };

          function openApptDetails(id){
            showLoader();
            var data = apptData[id];
            if(!data){hideLoader(); return;}
            var body = document.getElementById('apptDetailsBody');
            if(!body){hideLoader(); return;}
            
            const statusColor = data.approval === 'Approved' ? '#10B981' : data.approval === 'Pending' ? '#f59e0b' : '#ef4444';
            const statusBg = data.approval === 'Approved' ? '#dcfce7' : data.approval === 'Pending' ? '#fef3c7' : '#fee2e2';
            
            body.innerHTML = ''+
              '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #667eea"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Patient Name</div><div style="font-size:16px;font-weight:800;color:#1f2937">'+ (data.patientName||'N/A') +'</div></div>'+
              '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #3b82f6"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Appointment Date</div><div style="font-size:16px;font-weight:800;color:#1f2937">'+ (data.date||'N/A') +'</div></div>'+
              '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #10b981"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Appointment Time</div><div style="font-size:16px;font-weight:800;color:#1f2937">'+ (data.time||'N/A') +'</div></div>'+
              '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #f59e0b"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Consultation Type</div><div style="font-size:16px;font-weight:800;color:#1f2937">'+ (data.type||'N/A') +'</div></div>'+
              '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid '+statusColor+'"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Approval Status</div><div style="font-size:16px;font-weight:800;color:'+statusColor+'">'+ (data.approval||'N/A') +'</div></div>'+
              '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #6366f1"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Status</div><div style="font-size:16px;font-weight:800;color:#1f2937">'+ (data.status||'N/A') +'</div></div>'+
              (data.notes ? '<div style="grid-column:1/-1;padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #8b5cf6"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Notes</div><div style="font-size:14px;color:#374151;line-height:1.6;white-space:pre-wrap">'+ (data.notes||'No notes available') +'</div></div>' : '')+
              (data.meetingLink ? '<div style="grid-column:1/-1;padding:16px;background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);border-radius:12px;border-left:4px solid #10b981"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Meeting Link</div><div><a href="'+data.meetingLink+'" target="_blank" style="display:inline-flex;align-items:center;gap:8px;background:#10b981;color:#fff;padding:10px 16px;border-radius:8px;text-decoration:none;font-weight:600;transition:all 0.3s" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(16,185,129,0.3)\'" onmouseout="this.style.transform=\'\';this.style.boxShadow=\'\'"><i class="fas fa-video"></i> Join Meeting</a></div></div>' : '');
            
            var modal = document.getElementById('apptDetailsModal');
            if(modal){
              modal.style.display = 'flex';
              modal.style.visibility = 'visible';
              modal.style.opacity = '1';
              modal.style.zIndex = '10000';
            }
            hideLoader();
          }
          function closeApptDetails(){
            var modal = document.getElementById('apptDetailsModal');
            if(modal){
              modal.style.display='none';
              modal.style.visibility='hidden';
              modal.style.opacity='0';
            }
          }

          const patientData = {
            {% for p in patients %}
            {{ p.user.user_id }}: {
              id: {{ p.user.user_id }},
              name: "{{ p.profile.first_name|default:p.user.username|escapejs }}{% if p.profile.last_name %} {{ p.profile.last_name|escapejs }}{% endif %}",
              sex: "{{ p.profile.sex|default:''|escapejs }}",
              birthDate: "{{ p.profile.birthday|default:'' }}",
              contact: "{{ p.profile.phone_number|default:''|escapejs }}",
              address: "{{ p.profile.address|default:''|escapejs }}",
              emergency: "{{ p.profile.contact_person|default:''|escapejs }}",
              photo: "{{ p.photo_url|default:''|escapejs }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
          };
          function openPatientProfile(id){
            showLoader();
            var data = patientData[id];
            if(!data){hideLoader(); return;}
            var body = document.getElementById('patientProfileBody');
            if(!body){hideLoader(); return;}
            body.innerHTML = ''+
              (data.photo ? '<div style="grid-column:1/-1;text-align:center"><img src="'+data.photo+'" alt="Profile Photo" style="width:120px;height:120px;border-radius:999px;object-fit:cover;border:3px solid #e5e7eb"></div>' : '')+
              '<div><b>Name</b><div>'+ (data.name||'') +'</div></div>'+
              '<div><b>Gender</b><div>'+ (data.sex||'') +'</div></div>'+
              '<div><b>Birth Date</b><div>'+ (data.birthDate||'') +'</div></div>'+
              '<div><b>Contact</b><div>'+ (data.contact||'') +'</div></div>'+
              '<div style="grid-column:1/-1"><b>Address</b><div>'+ (data.address||'') +'</div></div>'+
              '<div style="grid-column:1/-1"><b>Emergency Contact</b><div>'+ (data.emergency||'') +'</div></div>';
            var modal = document.getElementById('patientProfileModal');
            if(modal){
              modal.style.display = 'flex';
              modal.style.visibility = 'visible';
              modal.style.opacity = '1';
              modal.style.zIndex = '10000';
            }
            hideLoader();
          }
          function showLoader(){ var el = document.getElementById('pageLoader'); if(el){ el.style.display='flex'; } }
          function hideLoader(){ var el = document.getElementById('pageLoader'); if(el){ el.style.display='none'; } }
          function closePatientProfile(){
            var modal = document.getElementById('patientProfileModal');
            if(modal){
              modal.style.display='none';
              modal.style.visibility='hidden';
              modal.style.opacity='0';
            }
          }

          function openProfileSettings(e){
            if(e){e.preventDefault(); e.stopPropagation();}
            // Close dropdown first
            if(typeof closeProfileDropdown === 'function'){
              closeProfileDropdown();
            }
            setTimeout(()=>{
              const modal = document.getElementById('profileSettingsModal');
              if(modal){
                modal.style.display='flex';
                modal.style.visibility='visible';
                modal.style.opacity='1';
                modal.style.zIndex='10000';
                // Ensure modal is on top
                modal.style.position='fixed';
              }
            }, 100);
          }
          function openSystemSettings(e){
            if(e){e.preventDefault(); e.stopPropagation();}
            // Close dropdown first
            if(typeof closeProfileDropdown === 'function'){
              closeProfileDropdown();
            }
            setTimeout(()=>{
              const modal = document.getElementById('systemSettingsModal');
              if(modal){
                modal.style.display='flex';
                modal.style.visibility='visible';
                modal.style.opacity='1';
                modal.style.zIndex='10000';
                modal.style.position='fixed';
              }
            }, 100);
          }
          function closeSystemSettings(){
            const modal = document.getElementById('systemSettingsModal');
            if(modal){
              modal.style.display='none';
              modal.style.visibility='hidden';
              modal.style.opacity='0';
            }
          }
          function saveSystemSettings(){
            const theme = document.getElementById('medisafeTheme')?.value || 'default';
            const layout = document.getElementById('dashboardLayout')?.value || 'standard';
            const showAnimations = document.getElementById('showAnimations')?.checked || false;
            const compactMode = document.getElementById('compactMode')?.checked || false;
            const fontSize = document.getElementById('fontSize')?.value || 'medium';
            const timeZone = document.getElementById('timeZone')?.value || 'UTC';
            
            // Save to localStorage
            localStorage.setItem('medisafe_theme', theme);
            localStorage.setItem('dashboard_layout', layout);
            localStorage.setItem('show_animations', showAnimations);
            localStorage.setItem('compact_mode', compactMode);
            localStorage.setItem('font_size', fontSize);
            localStorage.setItem('time_zone', timeZone);
            
            // Apply settings immediately
            applySystemSettings();
            
            alert('System settings saved successfully!');
            closeSystemSettings();
          }
          
          function applySystemSettings(){
            const theme = localStorage.getItem('medisafe_theme') || 'default';
            const fontSize = localStorage.getItem('font_size') || 'medium';
            const compactMode = localStorage.getItem('compact_mode') === 'true';
            
            // Apply font size
            if(fontSize === 'small'){
              document.documentElement.style.fontSize = '14px';
            } else if(fontSize === 'large'){
              document.documentElement.style.fontSize = '18px';
            } else {
              document.documentElement.style.fontSize = '16px';
            }
            
            // Apply compact mode
            if(compactMode){
              document.body.classList.add('compact-mode');
            } else {
              document.body.classList.remove('compact-mode');
            }
          }
          
          // Load settings on page load
          document.addEventListener('DOMContentLoaded', function(){
            applySystemSettings();
            const savedTheme = localStorage.getItem('medisafe_theme') || 'default';
            const savedLayout = localStorage.getItem('dashboard_layout') || 'standard';
            const savedAnimations = localStorage.getItem('show_animations') === 'true';
            const savedCompact = localStorage.getItem('compact_mode') === 'true';
            const savedFontSize = localStorage.getItem('font_size') || 'medium';
            const savedTimeZone = localStorage.getItem('time_zone') || 'UTC';
            
            if(document.getElementById('medisafeTheme')) document.getElementById('medisafeTheme').value = savedTheme;
            if(document.getElementById('dashboardLayout')) document.getElementById('dashboardLayout').value = savedLayout;
            if(document.getElementById('showAnimations')) document.getElementById('showAnimations').checked = savedAnimations;
            if(document.getElementById('compactMode')) document.getElementById('compactMode').checked = savedCompact;
            if(document.getElementById('fontSize')) document.getElementById('fontSize').value = savedFontSize;
            if(document.getElementById('timeZone')) document.getElementById('timeZone').value = savedTimeZone;
          });
          function openQuickProfile(e){
            if(e){e.preventDefault(); e.stopPropagation();}
            // Close dropdown first
            if(typeof closeProfileDropdown === 'function'){
              closeProfileDropdown();
            }
            setTimeout(()=>{
              const modal = document.getElementById('quickProfileModal');
              if(modal){
                modal.style.display='flex';
                modal.style.visibility='visible';
                modal.style.opacity='1';
                modal.style.zIndex='10000';
                modal.style.position='fixed';
              }
            }, 100);
          }
          function closeQuickProfile(){
            const modal = document.getElementById('quickProfileModal');
            if(modal){
              modal.style.display='none';
              modal.style.visibility='hidden';
              modal.style.opacity='0';
            }
          }
          function closeProfileSettings(){
            const modal = document.getElementById('profileSettingsModal');
            if(modal){
              modal.style.display='none';
              modal.style.visibility='hidden';
              modal.style.opacity='0';
            }
            // Don't reset dropdown state here - let it be managed by toggleProfileMenu
          }
          function previewProfilePhoto(ev){
            const file = ev.target.files && ev.target.files[0];
            if(!file){return;}
            const reader = new FileReader();
            reader.onload = function(evt){
              const prev = document.getElementById('profilePreview');
              if(prev){
                prev.style.backgroundImage = 'url("'+evt.target.result+'")';
                prev.style.backgroundSize = 'cover';
                prev.textContent = '';
              }
            };
            reader.readAsDataURL(file);
          }
          // AJAX submit for doctor profile form for live refresh
          (function(){
            const form = document.getElementById('doctorProfileForm');
            if(!form) return;
            form.addEventListener('submit', async function(ev){
              ev.preventDefault();
              try{
                const formData = new FormData(form);
                const resp = await fetch(form.action, { method: 'POST', body: formData, credentials: 'same-origin' });
                const data = await resp.json();
                if(resp.ok && data.success){
                  // Update visible name in header
                  const first = form.querySelector('input[name="first_name"]').value || '';
                  const last = form.querySelector('input[name="last_name"]').value || '';
                  const hdr = document.querySelector('.user-btn div[style*="text-align:left"] div');
                  if(hdr){ hdr.textContent = 'Dr. ' + (first || '{{ user.username }}') + (last ? (' ' + last) : ''); }
                  // Update avatar if backend returns a photo_url
                  const preview = document.getElementById('profilePreview');
                  if(data.profile && data.profile.photo_url && preview){
                    preview.style.backgroundImage = 'url("'+data.profile.photo_url+'")';
                    preview.style.backgroundSize = 'cover';
                    preview.textContent = '';
                  }
                  // Update header avatar if available
                  const hdrAvatar = document.getElementById('hdrAvatar');
                  if(hdrAvatar && data.profile && data.profile.photo_url){
                    hdrAvatar.style.backgroundImage = 'url("'+data.profile.photo_url+'")';
                    hdrAvatar.style.backgroundSize = 'cover';
                    hdrAvatar.style.backgroundPosition = 'center';
                    hdrAvatar.style.color = 'transparent';
                    hdrAvatar.textContent = '';
                  }
                  // Toast and close
                  const toast = document.getElementById('profileSaveToast');
                  if(toast){
                    toast.style.display='block';
                    setTimeout(()=>{ toast.style.opacity='0'; toast.style.transition='opacity .4s'; setTimeout(()=>{ toast.style.display='none'; toast.style.opacity='1'; }, 400); }, 1500);
                  }
                  // Keep modal open briefly to show changes visually
                  setTimeout(()=>{ closeProfileSettings(); }, 600);
                }else{
                  alert(data.message || 'Failed to update profile');
                }
              }catch(err){
                alert('Failed to update profile');
              }
            });
          })();

          // Lab Results Functions
          function refreshLabResults() {
            location.reload();
          }

          function viewLabResultNotes(resultId, notes) {
            // Create a simple modal for viewing notes
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center';
            modal.innerHTML = `
              <div style="background:#fff;padding:24px;border-radius:12px;max-width:500px;width:90vw;position:relative">
                <button onclick="this.closest('.overlay').remove()" style="position:absolute;top:12px;right:12px;background:none;border:none;font-size:18px;cursor:pointer">×</button>
                <h3 style="margin:0 0 16px;color:#1f2937">Lab Result Notes</h3>
                <div style="background:#f8fafc;padding:16px;border-radius:8px;border:1px solid #e5e7eb;min-height:100px;white-space:pre-wrap;color:#374151">${notes || 'No notes available'}</div>
                <div style="text-align:right;margin-top:16px">
                  <button onclick="this.closest('.overlay').remove()" class="pill" style="background:#6b7280;color:#fff">Close</button>
                </div>
              </div>
            `;
            modal.className = 'overlay';
            document.body.appendChild(modal);
          }

          // Patient Search Functions
          let searchTimeout;
          function searchPatients(query) {
            if (query.length < 2) {
              document.getElementById('patientSearchResults').style.display = 'none';
              return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
              try {
                const response = await fetch(`/doctors/search-patients/?q=${encodeURIComponent(query)}`, {
                  method: 'GET',
                  headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                  },
                  credentials: 'same-origin'
                });

                if (response.ok) {
                  const data = await response.json();
                  displayPatientSearchResults(data.patients);
                } else {
                  console.error('Search failed');
                }
              } catch (error) {
                console.error('Search error:', error);
              }
            }, 300);
          }

          function displayPatientSearchResults(patients) {
            const resultsDiv = document.getElementById('patientSearchResults');
            
            if (patients.length === 0) {
              resultsDiv.innerHTML = '<div style="text-align:center;padding:20px;color:#64748b">No patients found</div>';
            } else {
              let html = '<div style="margin-bottom:12px;font-weight:800;color:#1f2937">Search Results:</div>';
              patients.forEach(patient => {
                html += `
                  <div class="row" style="margin-bottom:12px;padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between">
                    <div style="display:flex;align-items:center;gap:16px">
                      <div class="avatar" style="width:40px;height:40px;background:#3b82f6;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800">
                        ${patient.first_name ? patient.first_name.charAt(0) : patient.username.charAt(0)}${patient.last_name ? patient.last_name.charAt(0) : ''}
                      </div>
                      <div>
                        <div style="font-weight:800;font-size:16px;color:#1f2937">
                          ${patient.first_name || ''} ${patient.last_name || ''} ${patient.first_name || patient.last_name ? '' : patient.username}
                        </div>
                        <div style="color:#64748b;font-size:14px">${patient.email}</div>
                        <div style="color:#64748b;font-size:12px">ID: ${patient.user_id}</div>
                      </div>
                    </div>
                    <button class="pill dark" onclick="viewPatientLabResults(${patient.user_id}, '${(patient.first_name || '') + ' ' + (patient.last_name || '')}'.trim() || '${patient.username}')">
                      <i class="fas fa-flask"></i> View Lab Results
                    </button>
                  </div>
                `;
              });
              resultsDiv.innerHTML = html;
            }
            
            resultsDiv.style.display = 'block';
          }

          function clearPatientSearch() {
            document.getElementById('patientSearchInput').value = '';
            document.getElementById('patientSearchResults').style.display = 'none';
          }

          async function viewPatientLabResults(patientId, patientName) {
            try {
              const response = await fetch(`/doctors/patient-lab-results/${patientId}/`, {
                method: 'GET',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
              });

              if (response.ok) {
                const data = await response.json();
                displayPatientLabResults(patientName, data.lab_results);
              } else {
                alert('Failed to load lab results');
              }
            } catch (error) {
              console.error('Error loading lab results:', error);
              alert('Error loading lab results');
            }
          }

          function displayPatientLabResults(patientName, labResults) {
            const title = document.getElementById('patientLabResultsTitle');
            const body = document.getElementById('patientLabResultsBody');
            
            title.textContent = `${patientName} - Lab Results`;
            
            if (labResults.length === 0) {
              body.innerHTML = `
                <div style="text-align:center;padding:40px;color:#64748b">
                  <i class="fas fa-flask" style="font-size:48px;margin-bottom:16px;opacity:0.5"></i>
                  <div style="font-size:18px;margin-bottom:8px">No lab results found</div>
                  <div style="font-size:14px">This patient has no lab results uploaded yet</div>
                </div>
              `;
            } else {
              let html = `<div style="margin-bottom:16px;font-weight:800;color:#1f2937">${labResults.length} Lab Result(s) Found:</div>`;
              labResults.forEach(result => {
                html += `
                  <div class="row" style="margin-bottom:16px;padding:20px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb">
                    <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
                      <div class="avatar" style="width:40px;height:40px;background:#10b981;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800">
                        <i class="fas fa-flask"></i>
                      </div>
                      <div style="flex:1">
                        <div style="font-weight:800;font-size:18px;color:#1f2937;margin-bottom:8px">${result.lab_type}</div>
                        <div style="display:flex;gap:16px;margin-bottom:8px;flex-wrap:wrap">
                          <div style="color:#64748b;font-size:14px">
                            <strong>Date:</strong> ${new Date(result.upload_date).toLocaleDateString('en-US', { 
                              year: 'numeric', 
                              month: 'long', 
                              day: 'numeric' 
                            })}
                          </div>
                          <div style="color:#64748b;font-size:14px">
                            <strong>Time:</strong> ${new Date(result.upload_date).toLocaleTimeString('en-US', { 
                              hour: '2-digit', 
                              minute: '2-digit' 
                            })}
                          </div>
                          <div style="color:#64748b;font-size:14px">
                            <strong>File:</strong> ${result.file_name}
                          </div>
                        </div>
                        ${result.notes ? `<div style="color:#6b7280;font-size:12px;margin-top:4px;font-style:italic;background:#f8fafc;padding:8px;border-radius:6px;border-left:3px solid #3b82f6">Notes: ${result.notes.substring(0, 100)}${result.notes.length > 100 ? '...' : ''}</div>` : ''}
                      </div>
                    </div>
                    <div style="display:flex;gap:8px;justify-content:flex-end">
                      <a href="/doctors/download-lab-result/${result.lab_result_id}/" class="pill dark" style="text-decoration:none;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(102,126,234,0.3);transition:all 0.3s;display:inline-flex;align-items:center;gap:8px" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 8px rgba(102,126,234,0.3)'">
                        <i class="fas fa-download"></i> Download
                      </a>
                      <button class="pill dark" onclick="show('lab'); closePatientLabResults(); setTimeout(() => { document.getElementById('lab').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);" style="background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(16,185,129,0.3);transition:all 0.3s;display:inline-flex;align-items:center;gap:8px" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 8px rgba(16,185,129,0.3)'">
                        <i class="fas fa-flask"></i> View Lab Results
                      </button>
                    </div>
                  </div>
                `;
              });
              body.innerHTML = html;
            }
            
            var modal = document.getElementById('patientLabResultsModal');
            if(modal){
              modal.style.display = 'flex';
              modal.style.visibility = 'visible';
              modal.style.opacity = '1';
              modal.style.zIndex = '10000';
            }
          }

          function closePatientLabResults() {
            var modal = document.getElementById('patientLabResultsModal');
            if(modal){
              modal.style.display = 'none';
              modal.style.visibility = 'hidden';
              modal.style.opacity = '0';
            }
          }

          // Start Appointment function
          function startAppointment(appointmentId) {
            // Get doctor information from the current page
            const doctorInfo = {
              name: '{{ user_profile.first_name|default:user.username }} {{ user_profile.last_name|default:"" }}',
              specialization: '{{ doctor.specialization|default:"General Medicine" }}',
              license: '{{ doctor.license_number|default:"N/A" }}',
              photo: '{{ user_profile.photo_url|default:"" }}'
            };
            
            // Open live appointment panel in new tab with specific appointment ID and doctor info
            const liveAppointmentUrl = '{% url "live_appointment" %}?appointment_id=' + appointmentId + 
              '&doctor_name=' + encodeURIComponent(doctorInfo.name) +
              '&doctor_specialization=' + encodeURIComponent(doctorInfo.specialization) +
              '&doctor_license=' + encodeURIComponent(doctorInfo.license) +
              '&doctor_photo=' + encodeURIComponent(doctorInfo.photo);
            
            const newWindow = window.open(liveAppointmentUrl, 'LiveAppointment', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (newWindow) {
              newWindow.focus();
            } else {
              alert('Please allow popups for this site to open the live appointment panel.');
            }
          }

          async function markDoctorNotifRead(notificationId, btn) {
            try {
              const csrftoken = (function(){
                const v = document.cookie.split(';').map(c => c.trim()).find(c => c.startsWith('csrftoken='));
                return v ? decodeURIComponent(v.split('=')[1]) : '';
              })();
              const form = new FormData();
              form.append('notification_id', notificationId);
              const resp = await fetch('{% url "doctor_mark_notification_read" %}', { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: form });
              const data = await resp.json();
              if (resp.ok && data.success) {
                // update UI
                if (btn) {
                  btn.disabled = true;
                  btn.textContent = 'Read';
                  btn.style.background = '#eef2ff';
                  btn.style.color = '#0369a1';
                }
                // decrement bell badge and remove from dropdown
                try{
                  const badge = document.getElementById('notifBadge');
                  if(badge){
                    let c = parseInt(badge.textContent) || 0;
                    c = Math.max(0, c - 1);
                    badge.textContent = c;
                    if(c === 0) badge.style.display = 'none';
                  }
                  const item = document.querySelector('.notif-item[data-notif-id="'+notificationId+'"]') || document.querySelector('[data-notif-id="'+notificationId+'"]');
                  if(item) item.remove();
                }catch(e){console.warn('failed to update badge', e)}
              } else {
                alert(data.message || 'Could not mark notification read');
              }
            } catch (e) {
              console.error(e);
              alert('Error marking notification');
            }
          }

          // --------- Client-side filters & helpers (Appointments / Prescriptions) ---------
          function filterAppointments() {
            const q = (document.getElementById('apptSearch') || {value:''}).value.toLowerCase();
            const type = (document.getElementById('apptTypeFilter') || {value:'all'}).value;
            const items = document.querySelectorAll('.dashboard-card ul li');
            items.forEach(li => {
              // skip list headers or non-appointment items
              if (!li.querySelector) return;
              const text = li.innerText.toLowerCase();
              let show = true;
              if (q && !text.includes(q)) show = false;
              if (type !== 'all' && !text.includes(type.toLowerCase())) show = false;
              li.style.display = show ? 'flex' : 'none';
            });
          }

          function filterAppointmentsByDate() {
            const filter = (document.getElementById('apptDateFilter') || {value:'all'}).value;
            const now = new Date();
            const items = document.querySelectorAll('.dashboard-card ul li');
            items.forEach(li => {
              const spans = li.querySelectorAll('span');
              const dateText = spans && spans.length ? spans[0].innerText : '';
              if (!dateText) return;
              const itemDate = new Date(dateText);
              let show = true;
              if (filter === 'today') {
                show = itemDate.toDateString() === now.toDateString();
              } else if (filter === 'week') {
                const weekFromNow = new Date(); weekFromNow.setDate(now.getDate() + 7);
                show = itemDate >= now && itemDate <= weekFromNow;
              } else if (filter === 'month') {
                const monthFromNow = new Date(); monthFromNow.setMonth(now.getMonth() + 1);
                show = itemDate >= now && itemDate <= monthFromNow;
              }
              li.style.display = show ? 'flex' : 'none';
            });
          }

          function filterPrescriptions() {
            const q = (document.getElementById('rxSearch') || {value:''}).value.toLowerCase();
            const from = document.getElementById('rxDateFrom') ? document.getElementById('rxDateFrom').value : '';
            const to = document.getElementById('rxDateTo') ? document.getElementById('rxDateTo').value : '';
            const items = document.querySelectorAll('#prescriptionsList .rx-item');
            items.forEach(li => {
              const text = li.innerText.toLowerCase();
              let show = text.includes(q);
              const dat = li.getAttribute('data-created-at');
              if (show && (from || to) && dat) {
                const itemDate = new Date(dat);
                if (from) {
                  const fromDate = new Date(from + 'T00:00:00');
                  if (itemDate < fromDate) show = false;
                }
                if (to) {
                  const toDate = new Date(to + 'T23:59:59');
                  if (itemDate > toDate) show = false;
                }
              }
              li.style.display = show ? 'flex' : 'none';
            });
          }

          // (old quick-select date filter removed)

          // Appointments page filter
          function filterApptPage() {
            const q = (document.getElementById('apptPageSearch') || {value:''}).value.toLowerCase();
            const type = (document.getElementById('apptPageType') || {value:'all'}).value.toLowerCase();
            const from = document.getElementById('apptDateFrom') ? document.getElementById('apptDateFrom').value : '';
            const to = document.getElementById('apptDateTo') ? document.getElementById('apptDateTo').value : '';
            const rows = document.querySelectorAll('#apptList .row');
            rows.forEach(r => {
              const text = r.innerText.toLowerCase();
              let show = true;
              if (q && !text.includes(q)) show = false;
              if (type !== 'all' && !text.includes(type)) show = false;
              if ((from || to) && show) {
                // attempt to find the date text from the row (first .muted occurrence)
                const muted = r.querySelector('.muted');
                const dateText = muted ? muted.innerText : '';
                // dateText often contains 'YYYY-MM-DD | STATUS' or similar
                const m = dateText.match(/(\d{4}-\d{2}-\d{2})/);
                if (m) {
                  const itemDate = new Date(m[1]);
                  if (from) {
                    const fromDate = new Date(from + 'T00:00:00');
                    if (itemDate < fromDate) show = false;
                  }
                  if (to) {
                    const toDate = new Date(to + 'T23:59:59');
                    if (itemDate > toDate) show = false;
                  }
                }
              }
              r.style.display = show ? 'flex' : 'none';
            });
          }

          // Lab results filter (client-side)
          function filterLabResults() {
            const type = (document.getElementById('labTypeFilter') || {value:'all'}).value.toLowerCase();
            const from = document.getElementById('labDateFrom') ? document.getElementById('labDateFrom').value : '';
            const to = document.getElementById('labDateTo') ? document.getElementById('labDateTo').value : '';
            const rows = document.querySelectorAll('#lab table tbody tr');
            rows.forEach(tr => {
              const cells = tr.querySelectorAll('td');
              if (!cells || cells.length < 5) return;
              const labType = cells[2].innerText.toLowerCase();
              const dateText = cells[4].innerText || '';
              // Try to parse dateText sensibly (it may have date and time)
              const parsed = new Date(dateText);
              let show = true;
              if (type !== 'all' && !labType.includes(type)) show = false;
              if (from) {
                const fromDate = new Date(from + 'T00:00:00');
                if (parsed < fromDate) show = false;
              }
              if (to) {
                const toDate = new Date(to + 'T23:59:59');
                if (parsed > toDate) show = false;
              }
              tr.style.display = show ? '' : 'none';
            });
          }

          // Prescriptions page filter
          function filterRxPage() {
            const q = (document.getElementById('rxPageSearch') || {value:''}).value.toLowerCase();
            const from = document.getElementById('rxPageDateFrom') ? document.getElementById('rxPageDateFrom').value : '';
            const to = document.getElementById('rxPageDateTo') ? document.getElementById('rxPageDateTo').value : '';
            const rows = document.querySelectorAll('#rx .list .row');
            rows.forEach(r => {
              const text = r.innerText.toLowerCase();
              let show = true;
              if (q && !text.includes(q)) show = false;
              if ((from || to) && show) {
                const createdText = r.querySelector('.muted') ? r.querySelector('.muted').innerText : '';
                const m = createdText.match(/Created:\s*(\w+\s*\d{1,2},\s*\d{4})/);
                if (m) {
                  const itemDate = new Date(m[1]);
                  if (from) {
                    const fromDate = new Date(from + 'T00:00:00');
                    if (itemDate < fromDate) show = false;
                  }
                  if (to) {
                    const toDate = new Date(to + 'T23:59:59');
                    if (itemDate > toDate) show = false;
                  }
                }
              }
              r.style.display = show ? 'flex' : 'none';
            });
          }

          

          async function viewPrescriptionDetails(id) {
            showLoader();
            try {
              const response = await fetch(`/doctors/prescription-details/${id}/`, {
                method: 'GET',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
              });

              if (response.ok) {
                const data = await response.json();
                if (data.success && data.prescription) {
                  displayPrescriptionModal(data.prescription);
                } else {
                  alert('Failed to load prescription details');
                }
              } else {
                alert('Failed to load prescription details');
              }
            } catch (error) {
              console.error('Error loading prescription:', error);
              alert('Error loading prescription details');
            }
            hideLoader();
          }

          function displayPrescriptionModal(prescription) {
            const modal = document.getElementById('prescriptionDetailsModal');
            if (!modal) return;

            const body = document.getElementById('prescriptionDetailsBody');
            if (!body) return;

            const statusColor = prescription.status === 'signed' ? '#10B981' : prescription.status === 'draft' ? '#f59e0b' : '#ef4444';
            const medicines = prescription.medicines || [];
            let medicinesHtml = '';
            if (medicines.length > 0) {
              medicinesHtml = '<div style="grid-column:1/-1;padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #8b5cf6"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Medicines</div><div style="display:grid;gap:8px">';
              medicines.forEach((med, idx) => {
                medicinesHtml += `<div style="padding:12px;background:#fff;border-radius:8px;border:1px solid #e5e7eb"><div style="font-weight:700;color:#1f2937;margin-bottom:4px">${med.name || 'N/A'}</div><div style="font-size:13px;color:#64748b">Dosage: ${med.dosage || 'N/A'} · Frequency: ${med.frequency || 'N/A'} · Duration: ${med.duration || 'N/A'}</div></div>`;
              });
              medicinesHtml += '</div></div>';
            }

            body.innerHTML = ''+
              '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #667eea"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Prescription Number</div><div style="font-size:16px;font-weight:800;color:#1f2937">'+ (prescription.prescription_number||'N/A') +'</div></div>'+
              '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #3b82f6"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Patient Name</div><div style="font-size:16px;font-weight:800;color:#1f2937">'+ (prescription.patient_name||'N/A') +'</div></div>'+
              '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #10b981"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Doctor Name</div><div style="font-size:16px;font-weight:800;color:#1f2937">'+ (prescription.doctor_name||'N/A') +'</div></div>'+
              '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid '+statusColor+'"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Status</div><div style="font-size:16px;font-weight:800;color:'+statusColor+'">'+ (prescription.status||'N/A').toUpperCase() +'</div></div>'+
              '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #f59e0b"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Created Date</div><div style="font-size:16px;font-weight:800;color:#1f2937">'+ (prescription.created_at ? new Date(prescription.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A') +'</div></div>'+
              (prescription.follow_up_date ? '<div style="padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #6366f1"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Follow-up Date</div><div style="font-size:16px;font-weight:800;color:#1f2937">'+ new Date(prescription.follow_up_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) +'</div></div>' : '')+
              (prescription.instructions ? '<div style="grid-column:1/-1;padding:16px;background:#f8fafc;border-radius:12px;border-left:4px solid #8b5cf6"><div style="font-size:12px;color:#6b7280;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Instructions</div><div style="font-size:14px;color:#374151;line-height:1.6;white-space:pre-wrap">'+ (prescription.instructions||'No instructions') +'</div></div>' : '')+
              medicinesHtml;

            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            modal.style.zIndex = '10000';
          }

          function closePrescriptionDetails() {
            const modal = document.getElementById('prescriptionDetailsModal');
            if (modal) {
              modal.style.display = 'none';
              modal.style.visibility = 'hidden';
              modal.style.opacity = '0';
            }
          }

          // --------- DASHBOARD FILTERS ---------
          function filterDashboardAppointments() {
            const q = (document.getElementById('dashApptSearch') || {value:''}).value.toLowerCase();
            const type = (document.getElementById('dashApptTypeFilter') || {value:'all'}).value.toLowerCase();
            const status = (document.getElementById('dashApptStatusFilter') || {value:'all'}).value.toLowerCase();
            const items = document.querySelectorAll('.dash-appt-item');
            let visible = 0;
            items.forEach(li => {
              const text = li.innerText.toLowerCase();
              const dataType = li.getAttribute('data-type') || '';
              const dataStatus = li.getAttribute('data-status') || '';
              let show = true;
              if (q && !text.includes(q)) show = false;
              if (type !== 'all' && !dataType.toLowerCase().includes(type)) show = false;
              if (status !== 'all' && !dataStatus.toLowerCase().includes(status)) show = false;
              li.style.display = show ? 'flex' : 'none';
              if (show) visible++;
            });
          }
          function resetDashboardApptFilters() {
            document.getElementById('dashApptSearch').value = '';
            document.getElementById('dashApptTypeFilter').value = 'all';
            document.getElementById('dashApptStatusFilter').value = 'all';
            filterDashboardAppointments();
          }

          function filterDashboardPrescriptions() {
            const q = (document.getElementById('rxDashSearch') || {value:''}).value.toLowerCase();
            const from = document.getElementById('rxDashFrom') ? document.getElementById('rxDashFrom').value : '';
            const to = document.getElementById('rxDashTo') ? document.getElementById('rxDashTo').value : '';
            const items = document.querySelectorAll('#prescriptionsList .rx-item');
            let visible = 0;
            items.forEach(li => {
              const text = li.innerText.toLowerCase();
              let show = text.includes(q);
              const dat = li.getAttribute('data-created-at');
              if (show && (from || to) && dat) {
                const itemDate = new Date(dat);
                if (from) {
                  const fromDate = new Date(from + 'T00:00:00');
                  if (itemDate < fromDate) show = false;
                }
                if (to) {
                  const toDate = new Date(to + 'T23:59:59');
                  if (itemDate > toDate) show = false;
                }
              }
              li.style.display = show ? 'flex' : 'none';
              if (show) visible++;
            });
          }
          function resetDashboardRxFilters() {
            document.getElementById('rxDashSearch').value = '';
            document.getElementById('rxDashFrom').value = '';
            document.getElementById('rxDashTo').value = '';
            filterDashboardPrescriptions();
          }
          function exportDashboardRxCSV() {
            const items = document.querySelectorAll('#prescriptionsList .rx-item[style*="flex"]');
            let csv = 'Rx Number,Patient,Created Date,Status\n';
            items.forEach(item => {
              const text = item.innerText.split('\n')[0];
              csv += text + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'prescriptions_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
          }

          // --------- APPOINTMENTS PAGE FILTERS ---------
          function filterApptPageAdvanced() {
            const q = (document.getElementById('apptPageSearch') || {value:''}).value.toLowerCase();
            const type = (document.getElementById('apptPageType') || {value:'all'}).value.toLowerCase();
            const from = document.getElementById('apptDateFrom') ? document.getElementById('apptDateFrom').value : '';
            const to = document.getElementById('apptDateTo') ? document.getElementById('apptDateTo').value : '';
            const status = (document.getElementById('apptStatusFilter') || {value:'all'}).value.toLowerCase();
            const rows = document.querySelectorAll('#apptList .appt-list-row');
            let visible = 0;
            rows.forEach(r => {
              const text = r.innerText.toLowerCase();
              const dataType = r.getAttribute('data-type') || '';
              const dataStatus = r.getAttribute('data-status') || '';
              const dataDate = r.getAttribute('data-date') || '';
              let show = true;
              if (q && !text.includes(q)) show = false;
              if (type !== 'all' && !dataType.includes(type)) show = false;
              if (status !== 'all' && !dataStatus.includes(status)) show = false;
              if ((from || to) && show && dataDate) {
                const itemDate = new Date(dataDate);
                if (from) {
                  const fromDate = new Date(from + 'T00:00:00');
                  if (itemDate < fromDate) show = false;
                }
                if (to) {
                  const toDate = new Date(to + 'T23:59:59');
                  if (itemDate > toDate) show = false;
                }
              }
              r.style.display = show ? 'flex' : 'none';
              if (show) visible++;
            });
            const total = document.querySelectorAll('#apptList .appt-list-row').length;
            const feedback = document.getElementById('apptFilterFeedback');
            if (feedback) {
              feedback.textContent = `Showing ${visible} of ${total} appointment${total !== 1 ? 's' : ''}`;
            }
          }
          function clearApptFiltersAdvanced() {
            document.getElementById('apptPageSearch').value = '';
            document.getElementById('apptPageType').value = 'all';
            document.getElementById('apptDateFrom').value = '';
            document.getElementById('apptDateTo').value = '';
            document.getElementById('apptStatusFilter').value = 'all';
            filterApptPageAdvanced();
          }
          function exportApptTableAdvanced() {
            const rows = document.querySelectorAll('#apptList .appt-list-row[style*="flex"]');
            let csv = 'Time,Patient,Date,Status,Type\n';
            rows.forEach(row => {
              const cells = row.innerText.split('\n');
              csv += cells.join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'appointments_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
          }
          function printApptTable() {
            window.print();
          }

          // --------- CALENDAR VIEW FUNCTIONALITY ---------
          let currentCalendarDate = new Date();
          
          function switchApptView(view) {
            const listView = document.getElementById('apptList');
            const calView = document.getElementById('apCal');
            const listBtn = document.getElementById('listBtn');
            const calBtn = document.getElementById('calBtn');
            
            if (view === 'list') {
              if (listView) listView.parentElement.parentElement.style.display = 'block';
              if (calView) calView.style.display = 'none';
              if (listBtn) listBtn.classList.add('active');
              if (calBtn) calBtn.classList.remove('active');
            } else if (view === 'cal') {
              if (listView) listView.parentElement.parentElement.style.display = 'none';
              if (calView) calView.style.display = 'block';
              if (listBtn) listBtn.classList.remove('active');
              if (calBtn) calBtn.classList.add('active');
              renderCalendar();
            }
          }

          function changeCalendarMonth(direction) {
            if (direction === 0) {
              currentCalendarDate = new Date();
            } else {
              currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            }
            renderCalendar();
          }

          function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthYear = document.getElementById('calendarMonthYear');
            if (!grid || !monthYear) return;

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            monthYear.textContent = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - startDate.getDay());

            grid.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 42; i++) {
              const cellDate = new Date(startDate);
              cellDate.setDate(startDate.getDate() + i);
              
              const isCurrentMonth = cellDate.getMonth() === month;
              const isToday = cellDate.getTime() === today.getTime();
              
              const cell = document.createElement('div');
              cell.className = 'cal-cell';
              cell.style.cssText = `padding:12px;min-height:100px;border:1px solid #e5e7eb;border-radius:8px;background:${isCurrentMonth ? '#fff' : '#f8fafc'};position:relative;${isToday ? 'border:2px solid #667eea;background:#f0f4ff;' : ''}`;
              
              const dayNum = document.createElement('div');
              dayNum.textContent = cellDate.getDate();
              dayNum.style.cssText = `font-weight:${isToday ? '900' : '700'};color:${isCurrentMonth ? (isToday ? '#667eea' : '#1f2937') : '#9ca3af'};margin-bottom:8px;font-size:${isToday ? '18px' : '16px'}`;
              cell.appendChild(dayNum);

              const dateStr = cellDate.toISOString().split('T')[0];
              const appointmentsForDay = [];
              
              Object.keys(apptData).forEach(key => {
                const appt = apptData[key];
                if (appt.date === dateStr) {
                  appointmentsForDay.push(appt);
                }
              });

              if (appointmentsForDay.length > 0) {
                appointmentsForDay.slice(0, 2).forEach(appt => {
                  const badge = document.createElement('div');
                  badge.className = 'mini-badge';
                  badge.style.cssText = 'margin-top:4px;padding:4px 6px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.2s';
                  badge.innerHTML = `<div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${appt.patientName || 'Patient'}</div><div style="font-size:10px;opacity:.9">${appt.time || ''}</div>`;
                  badge.onclick = () => openApptDetails(appt.id);
                  badge.onmouseover = function() { this.style.transform = 'scale(1.05)'; this.style.boxShadow = '0 2px 8px rgba(102,126,234,0.3)'; };
                  badge.onmouseout = function() { this.style.transform = ''; this.style.boxShadow = ''; };
                  cell.appendChild(badge);
                });
                if (appointmentsForDay.length > 2) {
                  const more = document.createElement('div');
                  more.textContent = `+${appointmentsForDay.length - 2} more`;
                  more.style.cssText = 'margin-top:4px;font-size:10px;color:#6b7280;font-weight:600';
                  cell.appendChild(more);
                }
              }

              grid.appendChild(cell);
            }
          }

          // --------- PATIENTS PAGE FILTERS ---------
          function filterPatientList() {
            const q = (document.getElementById('patientSearch') || {value:''}).value.toLowerCase();
            const items = document.querySelectorAll('#patientList .patient-item');
            let visible = 0;
            items.forEach(item => {
              const text = item.innerText.toLowerCase();
              const show = !q || text.includes(q);
              item.style.display = show ? 'flex' : 'none';
              if (show) visible++;
            });
            const feedback = document.getElementById('patientFilterFeedback');
            if (feedback) {
              const total = items.length;
              feedback.textContent = `Showing ${visible} of ${total} patient${total !== 1 ? 's' : ''}`;
            }
          }
          function resetPatientSearch() {
            document.getElementById('patientSearch').value = '';
            filterPatientList();
          }
          function exportPatientList() {
            const items = document.querySelectorAll('#patientList .patient-item[style*="flex"]');
            let csv = 'Name,ID,Email,Phone\n';
            items.forEach(item => {
              const text = item.innerText;
              csv += text.replace(/\n/g,' ') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'patients_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
          }

          // --------- LABORATORY PAGE FILTERS ---------
          function filterLabResultsAdvanced() {
            const type = (document.getElementById('labTypeFilter') || {value:'all'}).value.toLowerCase();
            const from = document.getElementById('labDateFrom') ? document.getElementById('labDateFrom').value : '';
            const to = document.getElementById('labDateTo') ? document.getElementById('labDateTo').value : '';
            const rows = document.querySelectorAll('#labResultsTable .lab-result-row');
            let visible = 0;
            rows.forEach(tr => {
              const dataType = tr.getAttribute('data-lab-type') || '';
              const dataDate = tr.getAttribute('data-upload-date') || '';
              let show = true;
              if (type !== 'all' && !dataType.includes(type)) show = false;
              if (from) {
                const fromDate = new Date(from + 'T00:00:00');
                const itemDate = new Date(dataDate);
                if (itemDate < fromDate) show = false;
              }
              if (to) {
                const toDate = new Date(to + 'T23:59:59');
                const itemDate = new Date(dataDate);
                if (itemDate > toDate) show = false;
              }
              tr.style.display = show ? '' : 'none';
              if (show) visible++;
            });
            const feedback = document.getElementById('labFilterFeedback');
            if (feedback) {
              const total = rows.length;
              feedback.textContent = `Showing ${visible} of ${total} lab result${total !== 1 ? 's' : ''}`;
            }
          }
          function clearLabFilters() {
            document.getElementById('labTypeFilter').value = 'all';
            document.getElementById('labDateFrom').value = '';
            document.getElementById('labDateTo').value = '';
            filterLabResultsAdvanced();
          }
          function exportLabResultsCSV() {
            const rows = document.querySelectorAll('#labResultsTable .lab-result-row');
            let csv = 'Lab Result ID,Patient Name,Lab Type,Date,Status\n';
            rows.forEach(row => {
              if (row.style.display !== 'none') {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                  csv += cells[0].textContent + ',' + cells[1].textContent.trim() + ',' + cells[2].textContent + ',' + cells[3].textContent + '\n';
                }
              }
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'lab_results_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
          }

          // --------- PRESCRIPTIONS PAGE FILTERS ---------
          function filterRxPageAdvanced() {
            const q = (document.getElementById('rxPageSearch') || {value:''}).value.toLowerCase();
            const status = (document.getElementById('rxStatusFilter') || {value:'all'}).value.toLowerCase();
            const from = document.getElementById('rxPageDateFrom') ? document.getElementById('rxPageDateFrom').value : '';
            const to = document.getElementById('rxPageDateTo') ? document.getElementById('rxPageDateTo').value : '';
            const rows = document.querySelectorAll('#rxPageList .rx-page-item');
            let visible = 0;
            rows.forEach(r => {
              const text = r.innerText.toLowerCase();
              const dataStatus = r.getAttribute('data-status') || '';
              const dataDate = r.getAttribute('data-created-at') || '';
              let show = true;
              if (q && !text.includes(q)) show = false;
              if (status !== 'all' && !dataStatus.includes(status)) show = false;
              if ((from || to) && show && dataDate) {
                const itemDate = new Date(dataDate);
                if (from) {
                  const fromDate = new Date(from + 'T00:00:00');
                  if (itemDate < fromDate) show = false;
                }
                if (to) {
                  const toDate = new Date(to + 'T23:59:59');
                  if (itemDate > toDate) show = false;
                }
              }
              r.style.display = show ? 'flex' : 'none';
              if (show) visible++;
            });
            const feedback = document.getElementById('rxFilterFeedback');
            if (feedback) {
              const total = rows.length;
              feedback.textContent = `Showing ${visible} of ${total} prescription${total !== 1 ? 's' : ''}`;
            }
          }
          function clearRxFilters() {
            document.getElementById('rxPageSearch').value = '';
            document.getElementById('rxStatusFilter').value = 'all';
            document.getElementById('rxPageDateFrom').value = '';
            document.getElementById('rxPageDateTo').value = '';
            filterRxPageAdvanced();
          }
          function exportRxCSV() {
            const rows = document.querySelectorAll('#rxPageList .rx-page-item');
            let csv = 'Rx Number,Patient,Created Date,Status\n';
            rows.forEach(row => {
              if (row.style.display !== 'none') {
                const cells = row.innerText.split('\n');
                csv += cells[0] + '\n';
              }
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'prescriptions_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
          }
          async function downloadPrescription(id) {
            showLoader();
            try {
              const response = await fetch(`/doctors/download-prescription/${id}/`, {
                method: 'GET',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
              });

              if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `prescription_${id}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
              } else {
                const data = await response.json();
                alert(data.error || 'Failed to download prescription');
              }
            } catch (error) {
              console.error('Error downloading prescription:', error);
              alert('Error downloading prescription');
            }
            hideLoader();
          }

          // --------- PROFILE SETTINGS MODAL TABS ---------
          function switchProfileTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.profile-tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.profile-tab-btn').forEach(btn => {
              btn.style.borderBottomColor = 'transparent';
              btn.style.color = '#6b7280';
            });
            // Show selected tab
            const tab = document.getElementById('profile-tab-' + tabName);
            if (tab) tab.style.display = 'block';
            const btn = document.querySelector('[data-tab="' + tabName + '"]');
            if (btn) {
              btn.style.borderBottomColor = btn.getAttribute('data-active-color') || '#764ba2';
              btn.style.color = btn.getAttribute('data-active-color') || '#764ba2';
            }
          }

          // Notification dropdown toggle
          function toggleNotifWindow(){
            const dd = document.getElementById('notifDropdown');
            if(!dd) return;
            dd.style.display = dd.style.display === 'flex' ? 'none' : 'flex';
            if(dd.style.display === 'flex') dd.style.flexDirection = 'column';
          }

          // close notif dropdown when clicking outside
          document.addEventListener('click', function(e){
            const btn = document.getElementById('notifBtn');
            const dd = document.getElementById('notifDropdown');
            if(!dd || !btn) return;
            if(!dd.contains(e.target) && !btn.contains(e.target)){
              dd.style.display = 'none';
            }
          });

          // --------- EVENT LISTENER INITIALIZATION ---------
          document.addEventListener('DOMContentLoaded', function(){
            // Date validation: Filter out past appointments from "Appointments Today"
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            document.querySelectorAll('.appt-item[data-appt-date]').forEach(item => {
              const apptDate = item.getAttribute('data-appt-date');
              if (apptDate && apptDate < todayStr) {
                item.style.display = 'none'; // Hide past appointments
              }
            });

            // Calculate appointment stats for Appointments page
            function calculateApptStats() {
              const rows = document.querySelectorAll('.appt-list-row');
              let approved = 0, pending = 0;
              rows.forEach(row => {
                const status = row.getAttribute('data-status') || '';
                if (status.toLowerCase() === 'approved') approved++;
                if (status.toLowerCase() === 'pending') pending++;
              });
              const approvedEl = document.getElementById('apptApprovedCount');
              const pendingEl = document.getElementById('apptPendingCount');
              if (approvedEl) approvedEl.textContent = approved;
              if (pendingEl) pendingEl.textContent = pending;
            }

            // Calculate prescription stats for Prescriptions page
            function calculateRxStats() {
              const items = document.querySelectorAll('.rx-page-item');
              let active = 0;
              const now = new Date();
              const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
              let thisMonth = 0;
              
              items.forEach(item => {
                const status = item.getAttribute('data-status') || '';
                if (status.toLowerCase() === 'active') active++;
                
                const createdAt = item.getAttribute('data-created-at');
                if (createdAt) {
                  const createdDate = new Date(createdAt);
                  if (createdDate >= monthStart) thisMonth++;
                }
              });
              
              const activeEl = document.getElementById('rxActiveCount');
              const monthEl = document.getElementById('rxMonthCount');
              if (activeEl) activeEl.textContent = active;
              if (monthEl) monthEl.textContent = thisMonth;
            }

            // Calculate stats on page load
            calculateApptStats();
            calculateRxStats();

            // Recalculate stats when filters change
            const originalFilterApptPageAdvanced = window.filterApptPageAdvanced;
            if (originalFilterApptPageAdvanced) {
              window.filterApptPageAdvanced = function() {
                originalFilterApptPageAdvanced();
                setTimeout(calculateApptStats, 100);
              };
            }

            const originalFilterRxPageAdvanced = window.filterRxPageAdvanced;
            if (originalFilterRxPageAdvanced) {
              window.filterRxPageAdvanced = function() {
                originalFilterRxPageAdvanced();
                setTimeout(calculateRxStats, 100);
              };
            }

            // Dashboard appointment filters
            const dashApptSearch = document.getElementById('dashApptSearch');
            const dashApptTypeFilter = document.getElementById('dashApptTypeFilter');
            const dashApptStatusFilter = document.getElementById('dashApptStatusFilter');
            if(dashApptSearch) dashApptSearch.addEventListener('input', filterDashboardAppointments);
            if(dashApptTypeFilter) dashApptTypeFilter.addEventListener('change', filterDashboardAppointments);
            if(dashApptStatusFilter) dashApptStatusFilter.addEventListener('change', filterDashboardAppointments);

            // Dashboard prescription filters
            const rxDashSearch = document.getElementById('rxDashSearch');
            const rxDashFrom = document.getElementById('rxDashFrom');
            const rxDashTo = document.getElementById('rxDashTo');
            if(rxDashSearch) rxDashSearch.addEventListener('input', filterDashboardPrescriptions);
            if(rxDashFrom) rxDashFrom.addEventListener('change', filterDashboardPrescriptions);
            if(rxDashTo) rxDashTo.addEventListener('change', filterDashboardPrescriptions);

            // Appointments page filters
            const apptPageSearch = document.getElementById('apptPageSearch');
            const apptPageType = document.getElementById('apptPageType');
            const apptDateFrom = document.getElementById('apptDateFrom');
            const apptDateTo = document.getElementById('apptDateTo');
            const apptStatusFilter = document.getElementById('apptStatusFilter');
            if(apptPageSearch) apptPageSearch.addEventListener('input', filterApptPageAdvanced);
            if(apptPageType) apptPageType.addEventListener('change', filterApptPageAdvanced);
            if(apptDateFrom) apptDateFrom.addEventListener('change', filterApptPageAdvanced);
            if(apptDateTo) apptDateTo.addEventListener('change', filterApptPageAdvanced);
            if(apptStatusFilter) apptStatusFilter.addEventListener('change', filterApptPageAdvanced);

            // Patients page filter
            const patientSearch = document.getElementById('patientSearch');
            if(patientSearch) patientSearch.addEventListener('input', filterPatientList);

            // Laboratory page filters
            const labTypeFilter = document.getElementById('labTypeFilter');
            const labDateFrom = document.getElementById('labDateFrom');
            const labDateTo = document.getElementById('labDateTo');
            if(labTypeFilter) labTypeFilter.addEventListener('change', filterLabResultsAdvanced);
            if(labDateFrom) labDateFrom.addEventListener('change', filterLabResultsAdvanced);
            if(labDateTo) labDateTo.addEventListener('change', filterLabResultsAdvanced);

            // Prescriptions page filters
            const rxPageSearch = document.getElementById('rxPageSearch');
            const rxStatusFilter = document.getElementById('rxStatusFilter');
            const rxPageDateFrom = document.getElementById('rxPageDateFrom');
            const rxPageDateTo = document.getElementById('rxPageDateTo');
            if(rxPageSearch) rxPageSearch.addEventListener('input', filterRxPageAdvanced);
            if(rxStatusFilter) rxStatusFilter.addEventListener('change', filterRxPageAdvanced);
            if(rxPageDateFrom) rxPageDateFrom.addEventListener('change', filterRxPageAdvanced);
            if(rxPageDateTo) rxPageDateTo.addEventListener('change', filterRxPageAdvanced);

            // Profile Settings Modal - Initialize first tab as active
            const firstTab = document.querySelector('[data-tab="personal"]');
            if(firstTab) {
              firstTab.style.borderBottomColor = firstTab.getAttribute('data-active-color') || '#764ba2';
              firstTab.style.color = firstTab.getAttribute('data-active-color') || '#764ba2';
            }
            const firstContent = document.getElementById('profile-tab-personal');
            if(firstContent) firstContent.style.display = 'block';

            // Additional Features: Dashboard refresh functionality
            window.refreshDashboard = function() {
              showLoader();
              setTimeout(()=>{ hideLoader(); alert('Dashboard refreshed!'); }, 500);
            };

            // Quick stats calculator
            window.calculateDashboardStats = function() {
              const appts = document.querySelectorAll('.dash-appt-item').length;
              const today = document.querySelectorAll('.appt-item').length;
              const rxs = document.querySelectorAll('.rx-item').length;
              return { appointments: appts, todayAppointments: today, prescriptions: rxs };
            };

            // Export dashboard data as JSON
            window.exportDashboardData = function() {
              const stats = calculateDashboardStats();
              const data = {
                timestamp: new Date().toISOString(),
                stats: stats,
                message: 'Doctor Dashboard Export'
              };
              const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
              const link = document.createElement('a');
              link.href = URL.createObjectURL(blob);
              link.download = 'dashboard_' + new Date().toISOString().split('T')[0] + '.json';
              link.click();
            };

            // Quick notification count updater
            window.getUnreadNotifications = function() {
              const badge = document.getElementById('notifBadge');
              return badge ? parseInt(badge.textContent) || 0 : 0;
            };

            // Advanced search across all appointments
            window.advancedSearchAppointments = function(query) {
              const rows = document.querySelectorAll('.dash-appt-item, .appt-list-row, .appt-item');
              let found = 0;
              rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                const match = text.includes(query.toLowerCase());
                row.style.display = match ? '' : 'none';
                if(match) found++;
              });
              return found;
            };

            // Get dashboard readiness status
            window.getDashboardStatus = function() {
              const stats = calculateDashboardStats();
              return {
                isReady: true,
                hasAppointments: stats.appointments > 0,
                hasTodayAppointments: stats.todayAppointments > 0,
                hasPrescriptions: stats.prescriptions > 0,
                unreadNotifications: getUnreadNotifications()
              };
            };

            // Add keyboard shortcuts help
            window.showKeyboardShortcuts = function() {
              const shortcuts = `
Keyboard Shortcuts:
- Press 'D' to go to Dashboard
- Press 'A' to go to Appointments
- Press 'P' to go to My Patients
- Press 'L' to go to Laboratory
- Press 'R' to go to Prescriptions
- Press 'S' to open Profile Settings
- Press '?' to show this help
              `;
              alert(shortcuts);
            };

            // Keyboard shortcuts listener
            document.addEventListener('keydown', function(e) {
              if(e.ctrlKey || e.metaKey) return;
              if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
              
              const key = e.key.toLowerCase();
              if(key === 'd') show('dashboard');
              else if(key === 'a') show('appointments');
              else if(key === 'p') show('patients');
              else if(key === 'l') show('lab');
              else if(key === 'r') show('rx');
              else if(key === 's') openProfileSettings(e);
              else if(key === '?') showKeyboardShortcuts();
            });

            // Close modals when clicking outside
            document.addEventListener('click', function(e) {
              // Profile Settings Modal
              const profileModal = document.getElementById('profileSettingsModal');
              if(profileModal && profileModal.style.display === 'flex' && e.target === profileModal) {
                closeProfileSettings();
              }
              
              // Quick Profile Modal
              const quickModal = document.getElementById('quickProfileModal');
              if(quickModal && quickModal.style.display === 'flex' && e.target === quickModal) {
                closeQuickProfile();
              }
              
              // Appointment Details Modal
              const apptModal = document.getElementById('apptDetailsModal');
              if(apptModal && apptModal.style.display === 'flex' && e.target === apptModal) {
                closeApptDetails();
              }
              
              // Patient Profile Modal
              const patientModal = document.getElementById('patientProfileModal');
              if(patientModal && patientModal.style.display === 'flex' && e.target === patientModal) {
                closePatientProfile();
              }
              
              // Patient Lab Results Modal
              const labModal = document.getElementById('patientLabResultsModal');
              if(labModal && labModal.style.display === 'flex' && e.target === labModal) {
                closePatientLabResults();
              }
            });

            // Close modals on Escape key
            document.addEventListener('keydown', function(e) {
              if(e.key === 'Escape') {
                if(typeof closeProfileSettings === 'function') {
                  const profileModal = document.getElementById('profileSettingsModal');
                  if(profileModal && profileModal.style.display === 'flex') {
                    closeProfileSettings();
                    return;
                  }
                }
                if(typeof closeQuickProfile === 'function') {
                  const quickModal = document.getElementById('quickProfileModal');
                  if(quickModal && quickModal.style.display === 'flex') {
                    closeQuickProfile();
                    return;
                  }
                }
                if(typeof closeApptDetails === 'function') {
                  const apptModal = document.getElementById('apptDetailsModal');
                  if(apptModal && apptModal.style.display === 'flex') {
                    closeApptDetails();
                    return;
                  }
                }
                if(typeof closePatientProfile === 'function') {
                  const patientModal = document.getElementById('patientProfileModal');
                  if(patientModal && patientModal.style.display === 'flex') {
                    closePatientProfile();
                    return;
                  }
                }
                if(typeof closePatientLabResults === 'function') {
                  const labModal = document.getElementById('patientLabResultsModal');
                  if(labModal && labModal.style.display === 'flex') {
                    closePatientLabResults();
                    return;
                  }
                }
              }
            });
          });
        </script>
</body>
</html>
